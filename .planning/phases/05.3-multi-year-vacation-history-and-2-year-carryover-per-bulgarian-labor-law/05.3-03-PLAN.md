---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 03
type: execute
wave: 3
depends_on: ["05.3-01", "05.3-02"]
files_modified:
  - components/VacationSummary.tsx
autonomous: true

must_haves:
  truths:
    - "VacationSummary shows total = current year allocation + active carryover"
    - "Carryover breakdown lists each bucket with allocation year and expiry date"
    - "Expired carryover buckets shown with strikethrough and (–∏–∑—Ç–µ–∫–ª–∏) label"
    - "Active carryover buckets shown with expiry year (–≤–∞–∂–∏ –¥–æ YYYY)"
    - "Anonymous users see NO carryover UI (localStorage doesn't support multi-year)"
    - "Current year allocation shown separately in breakdown"
  artifacts:
    - path: "components/VacationSummary.tsx"
      provides: "Multi-bucket carryover breakdown with expiry status"
      min_lines: 180
  key_links:
    - from: "components/VacationSummary.tsx"
      to: "contexts/VacationContext"
      via: "rollover.buckets array"
      pattern: "rollover.buckets.map\\(bucket =>"
    - from: "components/VacationSummary.tsx"
      to: "rollover.totalRollover"
      via: "Effective total calculation"
      pattern: "rollover\\.totalRollover"
---

<objective>
Display multi-year carryover breakdown with expiry status in VacationSummary per Bulgarian labor law notification requirement.

Purpose: Users see which years their carryover comes from and when it expires. Employers must notify employees of carryover including expiry dates by Jan 31 each year (Bulgarian –ö–æ–¥–µ–∫—Å –Ω–∞ —Ç—Ä—É–¥–∞). This UI provides that transparency.

Output: VacationSummary shows current year allocation + per-bucket carryover breakdown with expiry dates. Expired buckets shown with strikethrough + "(–∏–∑—Ç–µ–∫–ª–∏)" label.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-RESEARCH.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-01-SUMMARY.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-02-SUMMARY.md
@components/VacationSummary.tsx
</context>

<tasks>

<task type="auto">
  <name>Add multi-bucket carryover breakdown with expiry status</name>
  <files>components/VacationSummary.tsx</files>
  <action>
Update components/VacationSummary.tsx to display carryover breakdown with per-bucket expiry status:

1. Update totalRollover calculation (line 23) to use new field:
**OLD:**
```typescript
const rolloverDays = rollover?.rolloverDays || 0;
```
**NEW:**
```typescript
const rolloverDays = rollover?.totalRollover || 0;
```
Why: RolloverResult now has `totalRollover` field which excludes expired buckets. Legacy `rolloverDays` field kept for backward compat but `totalRollover` is the correct source.

2. Update "–û–±—â–æ –¥–Ω–∏ –∑–∞ –æ—Ç–ø—É—Å–∫" display to show equation only when carryover exists (lines 60-123).
No changes needed for lines 60-123. The existing logic already shows `{vacationData.totalDays} + {rolloverDays} = {effectiveTotal}` when rollover exists (line 105-107).

3. Replace single-line rollover display (lines 125-131) with multi-bucket breakdown:
**DELETE:**
```typescript
{/* Rollover Days (Only for authenticated users with rollover) */}
{isAuthenticated && rollover && rolloverDays > 0 && (
  <div className="flex items-center justify-between">
    <span className="text-sm text-mocha">üîÑ –ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç {new Date().getFullYear() - 1}:</span>
    <span className="font-semibold text-mocha">{rolloverDays}</span>
  </div>
)}
```

**REPLACE WITH:**
```typescript
{/* Carryover Breakdown (Only for authenticated users with buckets) */}
{isAuthenticated && rollover && rollover.buckets && rollover.buckets.length > 0 && (
  <div className="border-t border-latte pt-2 mt-2 space-y-1">
    <span className="text-xs text-cappuccino font-semibold">–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏:</span>

    {/* Current year allocation */}
    <div className="flex items-center justify-between">
      <span className="text-xs text-coffee">–¢–µ–∫—É—â–∞ –≥–æ–¥–∏–Ω–∞ ({year || new Date().getFullYear()}):</span>
      <span className="text-sm font-semibold text-espresso">{vacationData.totalDays}</span>
    </div>

    {/* Carryover buckets */}
    {rollover.buckets.map(bucket => (
      <div key={bucket.year} className="flex items-center justify-between">
        <span className={`text-xs ${bucket.isExpired ? 'text-oat-milk line-through' : 'text-mocha'}`}>
          –ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç {bucket.year} {bucket.isExpired ? '(–∏–∑—Ç–µ–∫–ª–∏)' : `(–≤–∞–∂–∏ –¥–æ ${bucket.expiresAt.slice(0, 4)})`}:
        </span>
        <span className={`text-sm font-semibold ${bucket.isExpired ? 'text-oat-milk line-through' : 'text-mocha'}`}>
          {bucket.rolloverDays}
        </span>
      </div>
    ))}
  </div>
)}
```

Why these changes:
- Check `rollover.buckets.length > 0` instead of `rolloverDays > 0`: More accurate (buckets may exist with zero total if all expired)
- "–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏" header: Clear section label per Bulgarian notification requirement
- Current year line shows base allocation separate from carryover
- bucket.map() iterates over all buckets (0-2 buckets max per 2-year Bulgarian law)
- `bucket.isExpired ? '–∏–∑—Ç–µ–∫–ª–∏' : '–≤–∞–∂–∏ –¥–æ YYYY'`: Shows expiry status per bucket
- `line-through` + `text-oat-milk`: Visual distinction for expired buckets
- Coffee theme tokens: `text-mocha` (active carryover), `text-oat-milk` (expired), `border-latte`, `text-coffee`, `text-cappuccino`, `text-espresso`
- Extract year from expiresAt with `.slice(0, 4)`: "–≤–∞–∂–∏ –¥–æ 2026" instead of "–≤–∞–∂–∏ –¥–æ 2026-12-31"

Visual hierarchy:
1. Top: –û–±—â–æ –¥–Ω–∏ –∑–∞ –æ—Ç–ø—É—Å–∫: 20 + 5 = 25 (if carryover exists)
2. Breakdown section (border-top separator):
   - Header: "–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏"
   - Current year: "–¢–µ–∫—É—â–∞ –≥–æ–¥–∏–Ω–∞ (2026): 20"
   - Bucket 1: "–ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç 2025 (–≤–∞–∂–∏ –¥–æ 2027): 5"
   - Bucket 2: "–ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç 2024 (–∏–∑—Ç–µ–∫–ª–∏): 3" (grayed, strikethrough)
3. Used days, Remaining days, Percentage (unchanged)

Edge cases handled:
- No buckets: Section hidden (guard: `rollover.buckets.length > 0`)
- All buckets expired: Total shows 0 carryover, breakdown shows expired buckets with strikethrough
- Anonymous users: Section hidden (guard: `isAuthenticated`)
- Historical year viewing: Shows breakdown for that year's rollover (e.g., viewing 2024 shows carryover from 2023+2022)
  </action>
  <verify>
```bash
grep "rollover?.totalRollover" components/VacationSummary.tsx
grep "–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏" components/VacationSummary.tsx
grep "rollover.buckets.map" components/VacationSummary.tsx
grep "bucket.isExpired" components/VacationSummary.tsx
grep "–∏–∑—Ç–µ–∫–ª–∏" components/VacationSummary.tsx
grep "–≤–∞–∂–∏ –¥–æ" components/VacationSummary.tsx
```
Confirms totalRollover usage, breakdown header exists, bucket iteration implemented, expiry status rendering.
  </verify>
  <done>VacationSummary displays multi-bucket carryover breakdown with current year allocation + per-bucket lines showing allocation year, rollover days, and expiry status (active with expiry year, or expired with strikethrough + –∏–∑—Ç–µ–∫–ª–∏ label)</done>
</task>

</tasks>

<verification>
1. VacationSummary uses `rollover?.totalRollover` instead of `rollover?.rolloverDays`
2. Carryover breakdown section only shown for authenticated users with rollover.buckets.length > 0
3. Breakdown shows header "–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏"
4. Current year allocation shown separately: "–¢–µ–∫—É—â–∞ –≥–æ–¥–∏–Ω–∞ (YYYY): {totalDays}"
5. Each bucket rendered with allocation year, rollover days, expiry info
6. Active buckets show "–≤–∞–∂–∏ –¥–æ YYYY" in text-mocha
7. Expired buckets show "(–∏–∑—Ç–µ–∫–ª–∏)" in text-oat-milk with line-through
8. Coffee theme tokens used throughout (mocha, oat-milk, cappuccino, espresso, latte, coffee)

**Manual test:**
1. Sign in as authenticated user with multi-year vacation data
2. Navigate to current year
3. Verify VacationSummary shows:
   - Top line: "20 + 5 = 25" (if 5 days carryover)
   - Breakdown section with border-top
   - "–¢–µ–∫—É—â–∞ –≥–æ–¥–∏–Ω–∞ (2026): 20"
   - "–ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç 2025 (–≤–∞–∂–∏ –¥–æ 2027): 5"
4. Mock expired carryover (change date to 2027, view data with 2024 carryover):
   - Verify expired bucket shows "(–∏–∑—Ç–µ–∫–ª–∏)" with strikethrough
   - Verify total excludes expired bucket
5. Sign out ‚Üí verify breakdown section hidden
</verification>

<success_criteria>
**Carryover breakdown displays correctly:**
- Header "–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏—Ç–µ –¥–Ω–∏" visible when buckets exist
- Current year allocation shown as separate line
- Each carryover bucket shown with: year, days, expiry status
- Active buckets: "–ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç 2025 (–≤–∞–∂–∏ –¥–æ 2027): 5"
- Expired buckets: "–ü—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –æ—Ç 2024 (–∏–∑—Ç–µ–∫–ª–∏): 3" with line-through + gray

**Totals calculated correctly:**
- Top line shows: base + active carryover = effective total
- Effective total excludes expired carryover
- Used/remaining calculations based on effective total

**Edge cases handled:**
- No carryover: breakdown section hidden
- All carryover expired: breakdown shows expired buckets, total = base only
- Anonymous users: no breakdown visible
- Historical year: breakdown shows rollover FOR that year

**Visual polish:**
- Coffee theme tokens used consistently
- Border-top separator between total and breakdown
- Proper text hierarchy (xs for labels, sm for values)
- Strikethrough + muted color for expired buckets
- Semibold font for values, regular for labels
</success_criteria>

<output>
After completion, create `.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-03-SUMMARY.md`
</output>
