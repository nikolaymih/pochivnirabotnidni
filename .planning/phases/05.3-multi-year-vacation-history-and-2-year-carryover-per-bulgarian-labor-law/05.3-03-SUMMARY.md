---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 03
subsystem: vacation-tracking
tags: [typescript, react, ui, carryover, multi-year, bulgarian-labor-law]

# Dependency graph
requires:
  - phase: 05.3-01
    provides: Multi-year rollover foundation with CarryoverBucket interface
  - phase: 05.3-02
    provides: Year-aware VacationContext with rollover calculation for displayYear
provides:
  - VacationSummary displays current year allocation separately from carryover breakdown
  - Per-bucket carryover display with allocation year and expiry status
  - Visual distinction for expired vs active carryover (strikethrough, muted color)
  - Compliance with Bulgarian labor law notification requirement (Кодекс на труда Art. 173)
affects: [vacation-tracking, ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Multi-bucket breakdown pattern: separate section with border-top separator"
    - "Expiry status visual pattern: line-through + text-oat-milk for expired, text-mocha for active"
    - "Coffee theme token usage: mocha/oat-milk/cappuccino/espresso for carryover breakdown"

key-files:
  created: []
  modified:
    - components/VacationSummary.tsx

key-decisions:
  - "Use rollover?.totalRollover instead of rollover?.rolloverDays (correct source excluding expired)"
  - "Show breakdown only when rollover.buckets.length > 0 (more accurate than rolloverDays > 0)"
  - "Current year allocation shown separately before carryover buckets"
  - "Extract year from expiresAt with .slice(0, 4) for clean 'важи до 2027' display"
  - "Breakdown section uses border-top separator and space-y-1 for clear visual hierarchy"

patterns-established:
  - "Bucket iteration pattern: rollover.buckets.map(bucket => ...) with key={bucket.year}"
  - "Conditional styling pattern: bucket.isExpired ? expired-styles : active-styles"
  - "Bulgarian expiry labels: 'изтекли' for expired, 'важи до YYYY' for active"

# Metrics
duration: 45s
completed: 2026-02-10
---

# Phase 05.3 Plan 03: Multi-Bucket Carryover Breakdown with Expiry Status Summary

**VacationSummary displays per-bucket carryover breakdown showing allocation year, rollover days, and expiry status with visual distinction for expired buckets per Bulgarian labor law notification requirement**

## Performance

- **Duration:** 45s
- **Started:** 2026-02-10T09:43:59Z
- **Completed:** 2026-02-10T09:44:49Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- VacationSummary uses `rollover?.totalRollover` for accurate carryover calculation (excludes expired buckets)
- Multi-bucket breakdown section shows current year allocation + per-bucket carryover with expiry status
- Active buckets display "Прехвърлени от 2025 (важи до 2027): 5" in text-mocha
- Expired buckets display "Прехвърлени от 2024 (изтекли): 3" with line-through and text-oat-milk
- Breakdown section only shown for authenticated users with rollover.buckets.length > 0
- Coffee theme tokens used throughout (mocha, oat-milk, cappuccino, espresso, latte, coffee)
- Visual hierarchy: border-top separator between total and breakdown, text-xs for labels, text-sm for values

## Task Commits

Each task was committed atomically:

1. **Task 1: Add multi-bucket carryover breakdown with expiry status** - `dcc5d33` (feat)

## Files Created/Modified
- `components/VacationSummary.tsx` - Updated rollover display from single-line to multi-bucket breakdown with current year allocation, per-bucket carryover lines showing allocation year/days/expiry status, visual distinction for expired buckets (line-through + muted color)

## Decisions Made

**1. Use totalRollover instead of rolloverDays**
- `rollover?.totalRollover` excludes expired buckets automatically
- Legacy `rolloverDays` field kept for backward compatibility but `totalRollover` is correct source

**2. Show breakdown only when rollover.buckets.length > 0**
- More accurate than checking `rolloverDays > 0`
- Handles edge case: buckets exist but all expired (totalRollover = 0)

**3. Current year allocation shown separately**
- "Текуща година (2026): 20" displayed before carryover buckets
- Clarifies which days are from current year vs carried over

**4. Extract year from expiresAt with .slice(0, 4)**
- Clean display: "важи до 2027" instead of "важи до 2027-12-31"
- User-friendly format for expiry year

**5. Visual hierarchy with border-top separator**
- Border-top + pt-2 mt-2 creates clear separation between total line and breakdown
- space-y-1 for compact bucket list
- text-xs for labels, text-sm for values (clear hierarchy)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 04 (YearSelector UI updates):**
- VacationSummary now displays year-specific carryover breakdown
- Breakdown shows correct buckets for historical years (e.g., viewing 2024 → shows 2023+2022 carryover)
- Visual compliance with Bulgarian labor law notification requirement complete

**Ready for Plan 05 (Year navigation integration):**
- VacationSummary receives year prop from page.tsx (already wired in 05.3-02)
- Breakdown correctly updates when user navigates between years
- Historical year display works with read-only mode

**No blockers or concerns.**

---
*Phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law*
*Completed: 2026-02-10*
