---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 02
subsystem: vacation-tracking
tags: [typescript, react-context, year-aware, read-only-mode, multi-year]

# Dependency graph
requires:
  - phase: 05.3-01
    provides: Multi-year rollover foundation with CarryoverBucket interface
provides:
  - Year-aware VacationProvider with optional year prop
  - Read-only protection for historical years (no sync writes)
  - Historical vacation display in calendar with disabled interaction
  - Year prop wiring from URL query param to VacationContext
affects: [05.3-03-vacation-summary-ui-breakdown, vacation-tracking, calendar]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Year-aware context pattern: year prop → displayYear → isCurrentYear"
    - "Read-only historical mode: isCurrentYear guard on sync operations"
    - "Conditional interaction handlers: undefined when viewing historical years"

key-files:
  created: []
  modified:
    - contexts/VacationContext.tsx
    - components/FullYearCalendarWrapper.tsx
    - app/page.tsx

key-decisions:
  - "VacationProvider accepts optional year prop (defaults to current year)"
  - "Migration only runs for current year (localStorage migration is current-year-only by design)"
  - "Debounced sync only for current year (isCurrentYear guard prevents historical writes)"
  - "fetchVacationData uses displayYear to load correct year's data"
  - "calculateRollover uses displayYear to compute rollover FOR displayed year"
  - "vacationDates passed unconditionally (VacationContext now loads historical data)"

patterns-established:
  - "Year-aware context: derive displayYear and isCurrentYear from year prop"
  - "Read-only guard pattern: if (!isCurrentYear) return before mutation operations"
  - "Historical display: show vacation dates but disable interaction handlers"

# Metrics
duration: 1m 28s
completed: 2026-02-10
---

# Phase 05.3 Plan 02: Year-Aware Vacation Context with Read-Only Historical Mode Summary

**VacationProvider accepts year prop, loads correct year's vacation data, only syncs to Supabase when viewing current year, and displays historical vacation dates with disabled interaction**

## Performance

- **Duration:** 1m 28s
- **Started:** 2026-02-10T09:40:24Z
- **Completed:** 2026-02-10T09:41:52Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- VacationProvider accepts optional year prop (defaults to current calendar year)
- VacationContext derives displayYear and isCurrentYear from year prop
- fetchVacationData uses displayYear to load correct year's vacation data
- Debounced sync guarded with isCurrentYear check (no writes to historical years)
- Migration guarded with isCurrentYear check (only runs for current year)
- calculateRollover uses displayYear to compute rollover FOR displayed year
- FullYearCalendarWrapper passes vacationDates unconditionally (not empty array)
- Calendar shows historical vacation dates when viewing past years
- Interaction handlers (onToggleDate, onPointerDown, etc.) undefined for historical years
- app/page.tsx passes currentYear from URL query param to VacationProvider

## Task Commits

Each task was committed atomically:

1. **Task 1: Make VacationProvider year-aware with read-only historical mode** - `1050191` (feat)
2. **Task 2: Show historical vacation dates in calendar with disabled interaction** - `70e11c6` (feat)
3. **Task 3: Pass year prop from page to VacationProvider** - `c9da6a0` (feat)

## Files Created/Modified
- `contexts/VacationContext.tsx` - Added year prop to VacationProvider, derived displayYear and isCurrentYear, guarded sync and migration with isCurrentYear, updated fetchVacationData and calculateRollover to use displayYear
- `components/FullYearCalendarWrapper.tsx` - Changed vacationDates prop from conditional (isCurrentYear ? dates : []) to unconditional (vacationData.vacationDates), interaction handlers already correctly gated by isCurrentYear
- `app/page.tsx` - Wired currentYear from URL query param to VacationProvider year prop

## Decisions Made

**1. VacationProvider year prop is optional with sensible default**
- Defaults to current calendar year if not provided
- Makes component work without prop (backward compatible)
- Enables year-aware behavior when URL query param changes

**2. Migration only runs for current year**
- Guard: `if (!user || isLoadingCloud || migrationComplete || !isCurrentYear) return`
- localStorage migration is current-year-only by design (see migration.ts comment)
- Historical years don't trigger migration (no localStorage data to migrate from past)

**3. Debounced sync only for current year**
- Guard: `if (!user || !migrationComplete || !isCurrentYear) return`
- Prevents accidental writes to historical year data (RESEARCH.md Pitfall 2)
- Historical years are read-only (view-only mode)

**4. fetchVacationData and calculateRollover use displayYear**
- fetchVacationData loads correct year's vacation data from Supabase
- calculateRollover computes rollover FOR displayed year (e.g., viewing 2024 → rollover from 2023+2022)
- Dependencies updated from currentYear to displayYear

**5. vacationDates passed unconditionally to FullYearCalendar**
- Changed from `isCurrentYear ? vacationData.vacationDates : []`
- To: `vacationData.vacationDates`
- VacationContext now fetches historical year data, so vacationData.vacationDates contains correct year's vacation dates
- Showing empty array was a workaround when historical data wasn't loaded

**6. Interaction handlers already correctly gated**
- onToggleDate, onPointerDown, onPointerEnter, onPointerUp all conditional on isCurrentYear
- When viewing historical year, all handlers are undefined
- FullYearCalendar won't respond to user interaction (view-only mode)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 03 (VacationSummary UI breakdown):**
- VacationContext now year-aware, loads correct year's data
- VacationSummary receives year prop from page.tsx (already wired)
- rollover calculation runs for displayYear, so rollover buckets are year-specific
- VacationSummary can show breakdown for historical years

**Ready for Plan 04 (YearSelector navigation):**
- Year prop flow: URL param → page currentYear → VacationProvider year → VacationContext displayYear
- YearSelector already navigates via URL query params (/?year=2024)
- Calendar and VacationContext respond to URL year changes

**No blockers or concerns.**

---
*Phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law*
*Completed: 2026-02-10*
