---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 02
type: execute
wave: 2
depends_on: ["05.3-01"]
files_modified:
  - contexts/VacationContext.tsx
  - components/FullYearCalendarWrapper.tsx
  - app/page.tsx
autonomous: true

must_haves:
  truths:
    - "VacationProvider accepts optional year prop (defaults to current year)"
    - "When viewing current year, vacation data syncs to Supabase (debounced)"
    - "When viewing historical year, vacation data loads but does NOT sync (read-only)"
    - "Calendar shows vacation dates for historical years (not empty array)"
    - "Calendar interaction disabled for historical years (no accidental edits)"
    - "Rollover calculation runs for displayYear (not hardcoded current year)"
  artifacts:
    - path: "contexts/VacationContext.tsx"
      provides: "Year-aware vacation context with read-only historical mode"
      exports: ["VacationProvider", "useVacation"]
      min_lines: 170
    - path: "components/FullYearCalendarWrapper.tsx"
      provides: "Historical vacation display with disabled interaction"
      min_lines: 125
    - path: "app/page.tsx"
      provides: "Year prop passed to VacationProvider"
      min_lines: 110
  key_links:
    - from: "app/page.tsx"
      to: "contexts/VacationContext.tsx"
      via: "VacationProvider year prop"
      pattern: "<VacationProvider year={currentYear}>"
    - from: "contexts/VacationContext.tsx"
      to: "lib/vacation/sync.ts"
      via: "fetchVacationData with displayYear"
      pattern: "fetchVacationData\\(user.id, displayYear\\)"
    - from: "components/FullYearCalendarWrapper.tsx"
      to: "FullYearCalendar"
      via: "vacationDates always passed (not conditional)"
      pattern: "vacationDates={vacationData.vacationDates}"
---

<objective>
Make VacationContext year-aware to support multi-year vacation history viewing with read-only protection for historical years.

Purpose: Users can navigate to previous years (via YearSelector) and see their historical vacation data. Current year remains editable with Supabase sync; historical years are read-only (no accidental edits).

Output: VacationProvider accepts optional `year` prop, fetches vacation data for that year, only syncs when viewing current year, and passes year context to children. Calendar displays historical vacation dates with interaction disabled for past years.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-RESEARCH.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-01-SUMMARY.md
@contexts/VacationContext.tsx
@components/FullYearCalendarWrapper.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Make VacationProvider year-aware with read-only historical mode</name>
  <files>contexts/VacationContext.tsx</files>
  <action>
Update contexts/VacationContext.tsx to accept optional year prop and implement read-only mode for historical years:

1. Update VacationProvider props interface (line 24):
```typescript
interface VacationProviderProps {
  children: ReactNode;
  year?: number; // Optional: defaults to current calendar year
}

export function VacationProvider({ children, year }: VacationProviderProps) {
```

2. Replace hardcoded currentYear (line 33) with year-aware logic:
```typescript
const currentYear = getYear(new Date());
const displayYear = year ?? currentYear; // Use provided year or current
const isCurrentYear = displayYear === currentYear;
```

3. Update cloud data fetch useEffect to use displayYear (line 60):
```typescript
fetchVacationData(user.id, displayYear)
```
Change dependency from `currentYear` to `displayYear` (line 71):
```typescript
}, [user, displayYear]);
```

4. Update migration useEffect to only run for current year (line 76):
```typescript
useEffect(() => {
  if (!user || isLoadingCloud || migrationComplete || !isCurrentYear) return; // Add isCurrentYear check
  migrateLocalStorageToSupabase(user.id, currentYear) // Keep currentYear for migration
```
Change dependency to include isCurrentYear (line 98):
```typescript
}, [user, isLoadingCloud, migrationComplete, currentYear, isCurrentYear]);
```

5. Update rollover calculation to use displayYear (line 103):
```typescript
calculateRollover(user.id, displayYear)
```
Change dependency from `currentYear` to `displayYear` (line 106):
```typescript
}, [user, isLoadingCloud, displayYear]);
```

6. CRITICAL: Add isCurrentYear guard to debounced sync (line 110-114):
```typescript
useEffect(() => {
  if (!user || !migrationComplete || !isCurrentYear) return; // Add isCurrentYear check
  upsertVacationData(user.id, displayYear, debouncedData)
    .catch(err => console.error('Sync failed, using localStorage:', err));
}, [debouncedData, user, migrationComplete, displayYear, isCurrentYear]);
```

Why these changes:
- `displayYear = year ?? currentYear`: Accepts URL year param or defaults to current
- `isCurrentYear` guard on sync: Prevents accidental writes to historical year data (RESEARCH.md Pitfall 2)
- `displayYear` in fetchVacationData: Loads correct year's vacation data
- `displayYear` in calculateRollover: Computes rollover FOR the displayed year (e.g., viewing 2024 → rollover from 2023+2022)
- Migration only for currentYear: localStorage migration is current-year-only by design (see migration.ts comment)
  </action>
  <verify>
```bash
grep "year?: number" contexts/VacationContext.tsx
grep "displayYear = year ?? currentYear" contexts/VacationContext.tsx
grep "isCurrentYear = displayYear === currentYear" contexts/VacationContext.tsx
grep -A 2 "if (!user || !migrationComplete || !isCurrentYear)" contexts/VacationContext.tsx
```
Confirms VacationProvider accepts year prop, derives displayYear and isCurrentYear, and guards sync with isCurrentYear check.
  </verify>
  <done>VacationProvider accepts year prop, fetches vacation data for displayYear, only syncs to Supabase when isCurrentYear is true (read-only for historical years)</done>
</task>

<task type="auto">
  <name>Show historical vacation dates in calendar with disabled interaction</name>
  <files>components/FullYearCalendarWrapper.tsx</files>
  <action>
Update components/FullYearCalendarWrapper.tsx to display historical vacation dates and disable interaction for past years:

1. Change vacationDates prop from conditional to always-pass (line 117):
**OLD:**
```typescript
vacationDates={isCurrentYear ? vacationData.vacationDates : []}
```
**NEW:**
```typescript
vacationDates={vacationData.vacationDates}
```

Why: VacationContext now fetches historical year data, so vacationData.vacationDates contains the correct year's vacation dates. Showing empty array was a workaround when historical data wasn't loaded.

2. Interaction handlers already correctly gated by isCurrentYear (lines 119-122):
```typescript
onToggleDate={isCurrentYear ? toggleVacationDate : undefined}
onPointerDown={isCurrentYear ? handlePointerDown : undefined}
onPointerEnter={isCurrentYear ? handlePointerEnter : undefined}
onPointerUp={isCurrentYear ? handlePointerUp : undefined}
```
These lines are CORRECT as-is. When viewing historical year, all handlers are undefined, so FullYearCalendar won't respond to user interaction (view-only mode).

No other changes needed. The component's isCurrentYear check (line 32) already derives from year prop, and all interaction is already correctly disabled for past years.
  </action>
  <verify>
```bash
grep 'vacationDates={vacationData.vacationDates}' components/FullYearCalendarWrapper.tsx
grep -A 4 'onToggleDate={isCurrentYear' components/FullYearCalendarWrapper.tsx
```
Confirms vacationDates passed unconditionally, interaction handlers gated by isCurrentYear.
  </verify>
  <done>Calendar displays vacation dates for ALL years (current and historical), interaction handlers (onToggleDate, onPointerDown, etc.) disabled when viewing historical years</done>
</task>

<task type="auto">
  <name>Pass year prop from page to VacationProvider</name>
  <files>app/page.tsx</files>
  <action>
Update app/page.tsx to pass currentYear prop to VacationProvider:

Change line 36:
**OLD:**
```typescript
<VacationProvider>
```
**NEW:**
```typescript
<VacationProvider year={currentYear}>
```

Why: The page already parses year from URL query params (line 20: `params.year ? parseInt(params.year, 10) : getYear(new Date())`). This change wires that year value into VacationContext so it knows which year's data to load.

No other changes needed. The currentYear variable is already used for YearSelector, holiday fetching, and component props. This completes the data flow: URL param → page currentYear → VacationProvider year → VacationContext displayYear → vacation data fetch.
  </action>
  <verify>
```bash
grep '<VacationProvider year={currentYear}>' app/page.tsx
```
Confirms VacationProvider receives year prop from page's currentYear.
  </verify>
  <done>VacationProvider receives year prop from page.tsx, enabling year-aware vacation data loading based on URL query param</done>
</task>

</tasks>

<verification>
1. VacationProvider has year prop (optional, defaults to current year)
2. VacationContext derives displayYear (year ?? currentYear) and isCurrentYear boolean
3. fetchVacationData called with displayYear (loads correct year's data)
4. Debounced sync to Supabase only runs when isCurrentYear is true
5. Migration only runs when isCurrentYear is true
6. calculateRollover called with displayYear (computes rollover FOR displayed year)
7. FullYearCalendarWrapper always passes vacationData.vacationDates (not conditional)
8. Interaction handlers (onToggleDate, onPointerDown, etc.) undefined for historical years
9. app/page.tsx passes currentYear prop to VacationProvider

**Manual test:**
1. Navigate to `/?year=2024` (historical year)
2. Calendar shows vacation dates from 2024 (if user has data)
3. Clicking calendar days does nothing (interaction disabled)
4. Check browser DevTools Network: no upsertVacationData calls on vacation date changes
5. Navigate to `/` (current year)
6. Calendar is interactive, debounced sync works
</verification>

<success_criteria>
**Year-aware context works:**
- Navigating to `/?year=2024` loads 2024 vacation data
- Navigating to `/` loads current year (2026) vacation data
- VacationContext state updates when URL year param changes

**Read-only protection works:**
- Viewing 2024: clicking calendar days has no effect
- Viewing 2024: no Supabase upsertVacationData calls
- Viewing 2026: calendar is fully interactive, sync works

**Historical display works:**
- Viewing 2024: calendar shows vacation dates marked in 2024
- Viewing 2024: VacationSummary shows 2024 totalDays and vacationDates
- Viewing 2024: rollover calculation shows carryover FROM 2023+2022 TO 2024

**Current year still fully functional:**
- Viewing 2026: all existing vacation tracking features work
- Editing vacation dates triggers debounced Supabase sync
- Migration runs on sign-in (only for current year)
</success_criteria>

<output>
After completion, create `.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-02-SUMMARY.md`
</output>
