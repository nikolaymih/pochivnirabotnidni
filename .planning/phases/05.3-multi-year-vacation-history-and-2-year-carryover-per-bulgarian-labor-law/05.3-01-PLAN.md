---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/vacation/types.ts
  - lib/vacation/rollover.ts
autonomous: true

must_haves:
  truths:
    - "Carryover calculation tracks up to 2 previous years per Bulgarian labor law"
    - "Each carryover bucket has allocation year, rollover days, expiry date, and expiry status"
    - "Expired carryover buckets are identified (isExpired: true)"
    - "Total rollover excludes expired buckets"
  artifacts:
    - path: "lib/vacation/types.ts"
      provides: "CarryoverBucket interface"
      exports: ["CarryoverBucket"]
    - path: "lib/vacation/rollover.ts"
      provides: "Multi-year rollover calculation with expiry"
      exports: ["calculateRollover", "RolloverResult", "CarryoverBucket"]
  key_links:
    - from: "lib/vacation/rollover.ts"
      to: "lib/vacation/sync.ts"
      via: "fetchVacationData calls for previous 2 years"
      pattern: "fetchVacationData\\(userId, allocationYear\\)"
    - from: "lib/vacation/rollover.ts"
      to: "date-fns"
      via: "startOfDay, parseISO, isAfter for expiry calculation"
      pattern: "isAfter\\(today, parseISO\\(expiresAt\\)\\)"
---

<objective>
Extend vacation rollover calculation to track multi-year carryover with 2-year expiration per Bulgarian labor law.

Purpose: Enable carryover bucket tracking so users can see unused vacation days from multiple previous years with individual expiry dates (Bulgarian Кодекс на труда: vacation expires 2 years after allocation year).

Output: Updated `RolloverResult` interface with `CarryoverBucket[]` and enhanced `calculateRollover()` function that fetches up to 2 previous years and computes expiry status per bucket.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-RESEARCH.md
@lib/vacation/rollover.ts
@lib/vacation/types.ts
@lib/vacation/sync.ts
</context>

<tasks>

<task type="auto">
  <name>Add CarryoverBucket interface to types</name>
  <files>lib/vacation/types.ts</files>
  <action>
Add `CarryoverBucket` interface to lib/vacation/types.ts (after VacationData interface):

```typescript
export interface CarryoverBucket {
  year: number;              // Allocation year (e.g., 2024)
  rolloverDays: number;      // Unused days from that year
  expiresAt: string;         // YYYY-12-31 format
  isExpired: boolean;        // Computed: today > expiresAt
}
```

This interface represents a single year's carryover with its expiry status per Bulgarian labor law (2-year limitation from end of allocation year).
  </action>
  <verify>
```bash
grep -A 5 "export interface CarryoverBucket" lib/vacation/types.ts
```
Confirms CarryoverBucket interface exists with all 4 fields (year, rolloverDays, expiresAt, isExpired).
  </verify>
  <done>CarryoverBucket interface defined with year, rolloverDays, expiresAt, isExpired fields</done>
</task>

<task type="auto">
  <name>Extend RolloverResult with multi-bucket structure</name>
  <files>lib/vacation/rollover.ts</files>
  <action>
Update lib/vacation/rollover.ts:

1. Add import for CarryoverBucket and date-fns functions at top:
```typescript
import { CarryoverBucket } from './types';
import { startOfDay, parseISO, isAfter } from 'date-fns';
```

2. Replace RolloverResult interface with:
```typescript
export interface RolloverResult {
  buckets: CarryoverBucket[];  // All carryover buckets (newest first)
  totalRollover: number;       // Sum of non-expired buckets only
  // Keep legacy fields for backward compatibility with existing UI
  rolloverDays: number;        // Same as totalRollover
  previousYearTotal: number;   // Most recent bucket's total (for legacy UI)
  previousYearUsed: number;    // Most recent bucket's used (for legacy UI)
}
```

3. Replace calculateRollover function body with multi-year logic:
```typescript
export async function calculateRollover(userId: string, currentYear: number): Promise<RolloverResult | null> {
  try {
    const buckets: CarryoverBucket[] = [];
    const today = startOfDay(new Date()); // Normalize to avoid timezone issues

    // Bulgarian law: 2-year limitation, so check previous 2 years only
    for (let i = 1; i <= 2; i++) {
      const allocationYear = currentYear - i;

      // Fetch vacation data for that year
      const prevData = await fetchVacationData(userId, allocationYear);
      if (!prevData) continue; // No data for this year, skip

      // Calculate unused days
      const usedDays = prevData.vacationDates.length;
      const rolloverDays = Math.max(0, prevData.totalDays - usedDays);

      if (rolloverDays === 0) continue; // No carryover from this year

      // Calculate expiry: end of (allocation year + 2)
      const expiryYear = allocationYear + 2;
      const expiresAt = `${expiryYear}-12-31`;
      const expiryDate = parseISO(expiresAt);
      const isExpired = isAfter(today, expiryDate);

      buckets.push({
        year: allocationYear,
        rolloverDays,
        expiresAt,
        isExpired
      });
    }

    // No buckets = no carryover at all
    if (buckets.length === 0) return null;

    // Sort newest to oldest (2025 before 2024)
    buckets.sort((a, b) => b.year - a.year);

    // Calculate total: only non-expired buckets count
    const totalRollover = buckets
      .filter(b => !b.isExpired)
      .reduce((sum, b) => sum + b.rolloverDays, 0);

    // Legacy fields for backward compatibility
    const mostRecentBucket = buckets[0];
    const previousYearData = await fetchVacationData(userId, mostRecentBucket.year);

    return {
      buckets,
      totalRollover,
      rolloverDays: totalRollover,
      previousYearTotal: previousYearData?.totalDays || 0,
      previousYearUsed: previousYearData?.vacationDates.length || 0,
    };
  } catch (error) {
    console.error('Rollover calculation failed:', error);
    return null;
  }
}
```

Update JSDoc comment to reflect multi-year behavior:
```typescript
/**
 * Calculate multi-year carryover with 2-year expiration per Bulgarian labor law
 *
 * Bulgarian Кодекс на труда: Vacation expires 2 years after allocation year.
 * Example: 2024 vacation → usable until 31.12.2026
 *
 * @param userId - Supabase user ID
 * @param currentYear - Year to calculate rollover FOR (e.g., 2026)
 * @returns RolloverResult with buckets and total, or null if no carryover
 */
```

Why startOfDay(): Prevents timezone-dependent expiry checks. Without normalization, `new Date()` includes time component which can shift expiry status based on user's timezone (see RESEARCH.md Pitfall 1).

Why sequential fetch: Only 2 years max, sequential is clearer than Promise.all for this small loop.

Why keep legacy fields: VacationSummary currently uses `rollover.rolloverDays` (line 23). Plan 03 will update UI to use buckets, but keeping legacy fields ensures no breakage.
  </action>
  <verify>
```bash
grep -A 10 "export interface RolloverResult" lib/vacation/rollover.ts
grep "CarryoverBucket" lib/vacation/rollover.ts
grep "startOfDay" lib/vacation/rollover.ts
npm test -- rollover.test.ts 2>/dev/null || echo "No tests yet (OK for now)"
```
Confirms RolloverResult has buckets array, calculateRollover uses date-fns for expiry calculation, and imports CarryoverBucket type.
  </verify>
  <done>calculateRollover() fetches up to 2 previous years, creates CarryoverBucket per year with expiry calculation, returns RolloverResult with buckets array and totalRollover (non-expired sum)</done>
</task>

</tasks>

<verification>
1. CarryoverBucket type defined with year, rolloverDays, expiresAt, isExpired
2. RolloverResult extended with buckets array and totalRollover field
3. calculateRollover() loops through previous 2 years, fetches vacation data per year
4. Expiry calculation uses `startOfDay(new Date())` to avoid timezone issues
5. Expired buckets have `isExpired: true`, total rollover excludes expired buckets
6. Legacy fields (rolloverDays, previousYearTotal, previousYearUsed) maintained for backward compatibility
</verification>

<success_criteria>
**Type definitions exist:**
- `CarryoverBucket` interface in lib/vacation/types.ts
- `RolloverResult` has `buckets: CarryoverBucket[]` and `totalRollover: number`

**Rollover calculation works:**
- `calculateRollover(userId, 2026)` fetches vacation data for 2025 and 2024
- Each bucket has correct expiresAt (allocation year + 2 years, Dec 31)
- `isExpired` computed correctly: `isAfter(startOfDay(today), parseISO(expiresAt))`
- `totalRollover` sums only non-expired buckets
- Returns null if no carryover buckets

**No existing functionality broken:**
- VacationContext still receives RolloverResult with rolloverDays field (legacy compat)
- VacationSummary still renders (uses rollover.rolloverDays)
</success_criteria>

<output>
After completion, create `.planning/phases/05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law/05.3-01-SUMMARY.md`
</output>
