---
phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law
plan: 01
subsystem: vacation-tracking
tags: [typescript, date-fns, supabase, rollover, bulgarian-labor-law]

# Dependency graph
requires:
  - phase: 04-04
    provides: RolloverResult interface and calculateRollover() function
provides:
  - CarryoverBucket interface with year, rolloverDays, expiresAt, isExpired
  - Multi-year rollover calculation (up to 2 previous years per Bulgarian law)
  - Expiry tracking per bucket (vacation expires 2 years after allocation year)
  - totalRollover field summing only non-expired buckets
affects: [05.3-02-vacation-summary-ui-breakdown, 05.3-03-multi-year-calendar-navigation, vacation-tracking]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Multi-year carryover bucket tracking with expiry calculation"
    - "startOfDay() normalization to prevent timezone-dependent expiry checks"
    - "Backward-compatible interface extension (legacy fields maintained)"

key-files:
  created: []
  modified:
    - lib/vacation/types.ts
    - lib/vacation/rollover.ts

key-decisions:
  - "Loop through 2 previous years only (Bulgarian labor law 2-year expiration limit)"
  - "Use startOfDay() to normalize expiry checks and avoid timezone issues"
  - "Maintain legacy fields (rolloverDays, previousYearTotal, previousYearUsed) for backward compatibility"
  - "Sequential fetch pattern for 2 years (clearer than Promise.all for small loop)"

patterns-established:
  - "CarryoverBucket as standard structure for per-year carryover tracking"
  - "Expiry calculation: allocation year + 2, checked with isAfter(today, parseISO(expiresAt))"
  - "totalRollover excludes expired buckets, legacy rolloverDays equals totalRollover"

# Metrics
duration: 1m 53s
completed: 2026-02-10
---

# Phase 05.3 Plan 01: Multi-Year Rollover Foundation Summary

**Multi-year carryover tracking with 2-year expiration per Bulgarian labor law using CarryoverBucket interface and date-fns expiry calculation**

## Performance

- **Duration:** 1m 53s
- **Started:** 2026-02-10T09:35:49Z
- **Completed:** 2026-02-10T09:37:42Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- CarryoverBucket interface tracks individual year's carryover with expiry status
- calculateRollover() fetches up to 2 previous years and creates bucket per year
- Expiry calculation uses startOfDay() to prevent timezone-dependent checks
- totalRollover field sums only non-expired buckets for accurate available days
- Legacy fields maintained ensuring VacationSummary continues working

## Task Commits

Each task was committed atomically:

1. **Task 1: Add CarryoverBucket interface to types** - `3d6faca` (feat)
2. **Task 2: Extend RolloverResult with multi-bucket structure** - `16eee23` (feat)

## Files Created/Modified
- `lib/vacation/types.ts` - Added CarryoverBucket interface with year, rolloverDays, expiresAt, isExpired
- `lib/vacation/rollover.ts` - Extended RolloverResult interface with buckets array, updated calculateRollover() to loop through 2 previous years with expiry calculation

## Decisions Made

**1. Use startOfDay() for expiry calculation normalization**
- Prevents timezone-dependent expiry status shifts
- Without normalization, `new Date()` includes time component causing expiry to vary by user's timezone
- Pattern from RESEARCH.md Pitfall 1 (same issue as Safari date parsing)

**2. Keep legacy fields for backward compatibility**
- VacationSummary currently uses `rollover.rolloverDays` (line 23 per plan context)
- Plan 03 will update UI to use buckets, but keeping legacy fields prevents breakage
- rolloverDays = totalRollover for smooth migration path

**3. Sequential fetch over Promise.all**
- Only 2 years maximum, sequential loop is clearer and easier to debug
- Marginal performance difference not worth complexity of parallel fetching

**4. Sort buckets newest to oldest**
- UI will typically show most recent carryover first
- Makes mostRecentBucket = buckets[0] intuitive

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 02 (VacationSummary UI breakdown):**
- RolloverResult now has buckets array with expiry status per year
- VacationSummary can iterate over buckets to show breakdown
- Legacy rolloverDays field still works, so existing UI unbroken

**Ready for Plan 03 (Multi-year calendar navigation):**
- calculateRollover() already fetches multi-year data
- Each bucket has allocation year for year-based filtering

**No blockers or concerns.**

---
*Phase: 05.3-multi-year-vacation-history-and-2-year-carryover-per-bulgarian-labor-law*
*Completed: 2026-02-10*
