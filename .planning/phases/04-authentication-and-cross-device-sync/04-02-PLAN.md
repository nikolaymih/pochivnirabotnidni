---
phase: 04-authentication-and-cross-device-sync
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - contexts/AuthContext.tsx
  - lib/avatar/initials.ts
  - components/AuthHeader.tsx
  - components/UserMenu.tsx
  - app/layout.tsx
  - app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a 'Вход с Google' button in the page header"
    - "Clicking the button initiates Google OAuth redirect flow"
    - "After sign-in, header shows user avatar (photo or initials) and name"
    - "Clicking avatar opens dropdown with 'Изход' (sign out) option"
    - "After sign out, user is redirected to home with sign-in button visible again"
    - "User session persists across browser refresh (no re-login needed)"
  artifacts:
    - path: "contexts/AuthContext.tsx"
      provides: "Auth state provider with Supabase auth listener"
      exports: ["AuthProvider", "useAuth"]
    - path: "lib/avatar/initials.ts"
      provides: "Avatar initials and color generation"
      exports: ["getInitials", "getAvatarColor"]
    - path: "components/AuthHeader.tsx"
      provides: "Header with sign-in/sign-out UI"
      min_lines: 30
    - path: "components/UserMenu.tsx"
      provides: "Avatar dropdown with sign out"
      min_lines: 20
  key_links:
    - from: "contexts/AuthContext.tsx"
      to: "lib/supabase/client.ts"
      via: "onAuthStateChange listener"
      pattern: "onAuthStateChange"
    - from: "components/AuthHeader.tsx"
      to: "contexts/AuthContext.tsx"
      via: "useAuth hook"
      pattern: "useAuth"
    - from: "components/UserMenu.tsx"
      to: "lib/supabase/client.ts"
      via: "signOut call"
      pattern: "signOut"
---

<objective>
Create authentication UI with Google sign-in, user avatar display, and auth state management.

Purpose: Users need a way to sign in, see their identity, and sign out. The AuthContext provides auth state that the sync layer (Plan 03) will consume to determine whether to use localStorage or Supabase.

Output: AuthContext provider, AuthHeader component with sign-in button / user avatar, UserMenu dropdown with sign-out, avatar initials/color utility.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-and-cross-device-sync/04-CONTEXT.md
@.planning/phases/04-authentication-and-cross-device-sync/04-RESEARCH.md
@.planning/phases/04-authentication-and-cross-device-sync/04-01-SUMMARY.md
@app/layout.tsx
@app/page.tsx
@lib/supabase/client.ts
@contexts/VacationContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthContext and avatar utilities</name>
  <files>
    contexts/AuthContext.tsx
    lib/avatar/initials.ts
  </files>
  <action>
    1. Create `lib/avatar/initials.ts`:
       - Implement `hashString(str: string): number` - simple hash for deterministic color
       - Define `AVATAR_COLORS` array with 7 accessible colors (red, amber, emerald, blue, violet, pink, cyan - use Tailwind-like hex values)
       - Export `getAvatarColor(userId: string): string` - returns hex color from hash
       - Export `getInitials(fullName: string | null, email: string): string`:
         - If fullName exists and has 2+ words: first letter of first word + first letter of last word, uppercase
         - If fullName exists but single word: first letter, uppercase
         - Fallback: first letter of email, uppercase
       - Follow exact pattern from 04-RESEARCH.md "Hash-Based Avatar Color Generation" code example

    2. Create `contexts/AuthContext.tsx`:
       - 'use client' directive
       - Import `createClient` from `@/lib/supabase/client`
       - Import `User` type from `@supabase/supabase-js`
       - Define `AuthContextType` interface:
         ```typescript
         interface AuthContextType {
           user: User | null;
           isLoading: boolean;
           signInWithGoogle: () => Promise<void>;
           signOut: () => Promise<void>;
         }
         ```
       - Create `AuthContext` with `createContext<AuthContextType | null>(null)`
       - Create `AuthProvider` component:
         - useState for `user` (User | null, default null)
         - useState for `isLoading` (boolean, default true)
         - useEffect to set up `onAuthStateChange` listener:
           - On `SIGNED_IN` or `TOKEN_REFRESHED`: set user from session
           - On `SIGNED_OUT`: set user to null
           - Set isLoading to false after initial check
           - Return cleanup function (unsubscribe)
         - Implement `signInWithGoogle`:
           - Call `supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: \`${window.location.origin}/auth/callback\` } })`
         - Implement `signOut`:
           - Call `supabase.auth.signOut()`
           - Use `router.push('/')` and `router.refresh()` after sign out
           - Import `useRouter` from `next/navigation`
         - Wrap children in `AuthContext.Provider` with value
       - Export `useAuth()` hook that reads context and throws if null
  </action>
  <verify>
    - `npm run build` succeeds
    - `lib/avatar/initials.ts` exports `getInitials` and `getAvatarColor`
    - `contexts/AuthContext.tsx` exports `AuthProvider` and `useAuth`
  </verify>
  <done>
    AuthContext provides user state, sign-in, and sign-out methods. Avatar utility generates initials and deterministic colors from user data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthHeader and UserMenu components, integrate into layout</name>
  <files>
    components/AuthHeader.tsx
    components/UserMenu.tsx
    app/layout.tsx
    app/page.tsx
  </files>
  <action>
    1. Create `components/UserMenu.tsx`:
       - 'use client' directive
       - Import `useAuth` from `@/contexts/AuthContext`
       - Import `getInitials`, `getAvatarColor` from `@/lib/avatar/initials`
       - useState for `isOpen` (dropdown visibility, default false)
       - Display user avatar:
         - If `user.user_metadata.avatar_url` exists: show `<img>` with rounded-full, 32x32px
         - Else: show initials circle with `getAvatarColor(user.id)` background and `getInitials(user.user_metadata.full_name, user.email)` text
       - User name next to avatar: `user.user_metadata.full_name || user.email`
       - onClick avatar/name: toggle `isOpen`
       - Dropdown menu (shown when isOpen):
         - Position: absolute, right-aligned below avatar
         - White background, border, rounded, shadow-lg
         - "Изход" (Sign out) button: calls `signOut()` from useAuth
       - Click outside closes dropdown (useEffect with document click listener)
       - Close dropdown after sign out

    2. Create `components/AuthHeader.tsx`:
       - 'use client' directive
       - Import `useAuth` from `@/contexts/AuthContext`
       - Import `UserMenu` from `./UserMenu`
       - Conditional rendering based on auth state:
         - `isLoading`: show nothing (or minimal skeleton - a 32px gray circle)
         - `user` exists: render `<UserMenu />`
         - No user: render "Вход с Google" button
           - Button styling: border, rounded, px-4 py-2, hover state
           - Include small Google "G" icon or just text
           - onClick: call `signInWithGoogle()` from useAuth
       - Layout: flex, items-center, gap-3

    3. Update `app/layout.tsx`:
       - Import `AuthProvider` from `@/contexts/AuthContext`
       - Wrap the `{children}` inside `<body>` with `<AuthProvider>`
       - The AuthProvider must be OUTSIDE VacationProvider (auth is higher-level)
       - Keep existing metadata, fonts, html lang="bg" unchanged

    4. Update `app/page.tsx`:
       - Import `AuthHeader` from `@/components/AuthHeader`
       - Add AuthHeader to BOTH mobile and desktop layouts:
         - Mobile: Add header section with title + AuthHeader (flex justify-between)
         - Desktop: Add AuthHeader in the top-right area
       - The header should appear at the top of the page, before calendar content
       - Keep all existing layout structure (VacationProvider, Legend, VacationSummary, FullYearCalendarWrapper)
       - AuthHeader is a Client Component but that's fine since it's leaf-level

    IMPORTANT:
    - Do NOT move VacationProvider - it stays in page.tsx wrapping the calendar content
    - AuthProvider goes in layout.tsx (app-wide)
    - This creates the nesting: AuthProvider (layout) > VacationProvider (page) > components
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run dev` shows the page with a "Вход с Google" button in the header
    - AuthHeader renders without errors in both mobile and desktop layouts
    - No hydration mismatches
  </verify>
  <done>
    Header shows "Вход с Google" button for anonymous users. After sign-in, header shows user avatar (photo or initials with colored background) and name. Clicking avatar opens dropdown with "Изход" option. Sign-out redirects to home with sign-in button visible.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Page loads without errors showing "Вход с Google" button
- AuthContext properly wraps the application in layout.tsx
- UserMenu shows avatar with initials when no profile picture
- Sign in initiates Google OAuth redirect
- Sign out redirects to home page
</verification>

<success_criteria>
Users see a sign-in button in the header. Clicking it initiates Google OAuth. After authentication, the header shows their avatar and name with a sign-out dropdown. Auth state persists across page refresh via Supabase session cookies managed by middleware.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-and-cross-device-sync/04-02-SUMMARY.md`
</output>
