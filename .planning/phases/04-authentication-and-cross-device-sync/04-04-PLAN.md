---
phase: 04-authentication-and-cross-device-sync
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - lib/vacation/rollover.ts
  - contexts/VacationContext.tsx
  - components/VacationSummary.tsx
autonomous: true

must_haves:
  truths:
    - "Authenticated users see rolled-over unused vacation days from previous year"
    - "Rollover adds previous year's unused days to current year's total"
    - "Anonymous users see NO reference to rollover (feature is invisible)"
    - "Rollover is calculated automatically when year changes (no user action)"
    - "Rollover only applies once per year transition (not duplicated)"
  artifacts:
    - path: "lib/vacation/rollover.ts"
      provides: "Rollover calculation logic"
      exports: ["calculateRollover"]
    - path: "contexts/VacationContext.tsx"
      provides: "VacationContext with rollover integration"
      exports: ["VacationProvider", "useVacation"]
    - path: "components/VacationSummary.tsx"
      provides: "Summary with rollover display for authenticated users"
      min_lines: 40
  key_links:
    - from: "lib/vacation/rollover.ts"
      to: "lib/vacation/sync.ts"
      via: "fetch previous year data"
      pattern: "fetchVacationData"
    - from: "contexts/VacationContext.tsx"
      to: "lib/vacation/rollover.ts"
      via: "rollover calculation on load"
      pattern: "calculateRollover"
---

<objective>
Implement vacation day rollover for authenticated users and ensure anonymous users see no rollover UI.

Purpose: Authenticated users get the benefit of cross-device data persistence AND vacation rollover - unused days from the previous year carry forward. This is a key differentiator for signing in. Anonymous users see nothing about this feature (per CONTEXT.md: "Anonymous users see nothing about rollover feature - invisible, not grayed out").

Output: Rollover calculation utility, enhanced VacationContext with rollover, and updated VacationSummary showing rolled-over days for authenticated users.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-and-cross-device-sync/04-CONTEXT.md
@.planning/phases/04-authentication-and-cross-device-sync/04-RESEARCH.md
@.planning/phases/04-authentication-and-cross-device-sync/04-03-SUMMARY.md
@contexts/VacationContext.tsx
@contexts/AuthContext.tsx
@components/VacationSummary.tsx
@lib/vacation/sync.ts
@lib/vacation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rollover calculation and integrate into VacationContext</name>
  <files>
    lib/vacation/rollover.ts
    contexts/VacationContext.tsx
  </files>
  <action>
    1. Create `lib/vacation/rollover.ts`:
       - Import `fetchVacationData` from `./sync`
       - Import `VacationData` from `./types`

       Define `RolloverResult`:
       ```typescript
       export interface RolloverResult {
         rolloverDays: number;       // Unused days from previous year
         previousYearTotal: number;  // Previous year's total allowance
         previousYearUsed: number;   // Previous year's used days
       }
       ```

       Export `calculateRollover(userId: string, currentYear: number): Promise<RolloverResult | null>`:
       - Fetch previous year data: `fetchVacationData(userId, currentYear - 1)`
       - If no previous year data: return null (no rollover available)
       - Calculate:
         ```
         previousYearUsed = prevData.vacationDates.length
         rolloverDays = Math.max(0, prevData.totalDays - previousYearUsed)
         ```
       - Return `{ rolloverDays, previousYearTotal: prevData.totalDays, previousYearUsed }`
       - If rolloverDays is 0: return null (nothing to roll over)

    2. Update `contexts/VacationContext.tsx`:
       - Extend `VacationContextType` interface:
         ```typescript
         interface VacationContextType {
           vacationData: VacationData;
           setVacationData: (data: VacationData) => void;
           rollover: RolloverResult | null;  // NEW
           isAuthenticated: boolean;          // NEW
         }
         ```
       - Import `calculateRollover`, `RolloverResult` from `@/lib/vacation/rollover`
       - Add useState for `rollover` (RolloverResult | null, default null)

       Add rollover calculation effect (runs after cloud data loads):
       ```
       useEffect(() => {
         if (!user || isLoadingCloud) return
         calculateRollover(user.id, currentYear)
           .then(result => setRollover(result))
           .catch(err => console.error('Rollover check failed:', err))
       }, [user, isLoadingCloud, currentYear])
       ```

       - When user signs out (in the existing cloud data useEffect where user is null): reset rollover to null (`setRollover(null)`)
       - Pass `rollover` and `isAuthenticated` in the context value:
         ```typescript
         <VacationContext.Provider value={{ vacationData: activeData, setVacationData, rollover, isAuthenticated }}>
         ```

       NOTE: This is a MINOR interface extension. The two new fields (`rollover` and `isAuthenticated`) are additive. Existing consumers that only destructure `vacationData` and `setVacationData` will continue working without changes because TypeScript allows unused properties in destructured objects.

    3. Verify all consuming components compile after the interface change:
       - `components/FullYearCalendarWrapper.tsx` uses `const { vacationData, setVacationData } = useVacation()` -- this will still work (extra fields ignored by destructuring)
       - `components/VacationSummary.tsx` uses `const { vacationData, setVacationData } = useVacation()` -- same pattern, still works
       - `components/Calendar.tsx` uses `const { vacationData, setVacationData } = useVacation()` -- same pattern, still works
       - Run `npm run build` to confirm zero TypeScript errors across ALL files
  </action>
  <verify>
    - `npm run build` succeeds with ZERO TypeScript errors (verify build output has no type errors)
    - `lib/vacation/rollover.ts` exports `calculateRollover` and `RolloverResult`
    - VacationContext provides `rollover` and `isAuthenticated` fields
    - Anonymous flow still works (rollover is null, isAuthenticated is false)
    - Existing consumers compile without changes:
      - `npx tsc --noEmit` passes (full type check across all files)
      - Specifically verify: FullYearCalendarWrapper.tsx, VacationSummary.tsx, Calendar.tsx have no type errors
  </verify>
  <done>
    Rollover calculation fetches previous year data from Supabase and computes unused days. VacationContext exposes rollover result and auth state to downstream components. All existing consuming components (FullYearCalendarWrapper, VacationSummary, Calendar) compile without changes because the new interface fields are additive and not required for destructuring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update VacationSummary to show rollover for authenticated users</name>
  <files>
    components/VacationSummary.tsx
  </files>
  <action>
    Update `components/VacationSummary.tsx`:
    - Import `rollover` and `isAuthenticated` from `useVacation()` (destructure new fields)

    Modify the summary display:
    - Keep ALL existing UI unchanged for anonymous users
    - For authenticated users with rollover (rollover !== null and rollover.rolloverDays > 0):
      - Add a new row AFTER "Общо дни за отпуск" row:
        ```
        "Прехвърлени от {previousYear}: {rollover.rolloverDays} дни"
        (Carried over from {year}: X days)
        ```
      - Style: text-sm text-purple-600 or similar accent color
      - Adjust remaining days calculation to include rollover:
        ```
        const effectiveTotal = vacationData.totalDays + (rollover?.rolloverDays || 0)
        const remainingDays = effectiveTotal - usedDays
        const percentageUsed = effectiveTotal > 0 ? Math.round((usedDays / effectiveTotal) * 100) : 0
        ```
      - Show effective total in the "Общо дни за отпуск" display:
        ```
        "{totalDays} + {rolloverDays} прехвърлени = {effectiveTotal}"
        ```
        Only when rollover exists. Without rollover, just show totalDays as before.

    - For anonymous users: ALL rollover UI is INVISIBLE (not grayed out, not mentioned at all)
      - Check: `if (!isAuthenticated || !rollover)` then render exactly the same as before
      - Per CONTEXT.md: "Anonymous users see nothing about rollover feature (invisible, not grayed out)"

    IMPORTANT:
    - Do NOT add any banner, tooltip, or message encouraging anonymous users to sign in
    - Per CONTEXT.md: "No proactive messaging - no banners, tooltips, or callouts about sign-in benefits"
    - Keep existing edit functionality (totalDays editing) working unchanged
    - Keep existing Tailwind styling patterns
  </action>
  <verify>
    - `npm run build` succeeds
    - Authenticated user with previous year data sees rollover line
    - Remaining days calculation accounts for rollover
    - Edit total days still works
    - NEGATIVE TEST (anonymous user sees NO rollover):
      1. Open app in incognito/unsigned-out state
      2. Verify VacationSummary renders with NO text containing "прехвърлени" or "rollover"
      3. Verify VacationSummary renders with NO purple-colored text (text-purple-600)
      4. Verify the component output is IDENTICAL to the pre-Plan-04-04 version for anonymous users
    - NEGATIVE TEST (codebase verification):
      1. Grep the codebase for rollover UI rendering: all instances of "прехвърлени" and "rolloverDays" in JSX must be gated by `isAuthenticated` or `rollover` check
      2. Run: `grep -n "прехвърлени\|rolloverDays\|rollover\." components/VacationSummary.tsx` and verify EVERY line is inside a conditional block that checks `isAuthenticated` and `rollover`
      3. Ensure no rollover-related string or number leaks into the anonymous user view
  </verify>
  <done>
    VacationSummary shows rollover days for authenticated users who have previous year data. Anonymous users see the identical summary as before with zero reference to rollover -- verified both by visual inspection and by grepping for rollover-related strings to confirm all are behind auth gates. Remaining days calculation includes rollover when applicable.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npx tsc --noEmit` passes (no type errors in any consuming component)
- Anonymous user experience is UNCHANGED (no rollover mention anywhere)
- Authenticated user with previous year data sees "Прехвърлени от {year}: X дни" in summary
- Remaining days includes rollover for authenticated users
- Rollover is calculated once on load, not on every render
- Edit total days still works for both anonymous and authenticated users
- All rollover UI rendering is gated by isAuthenticated AND rollover checks (grep verification)
</verification>

<success_criteria>
Authenticated users see rolled-over vacation days from the previous year in VacationSummary. Rollover adds unused days to their effective total. Anonymous users see absolutely nothing about rollover (invisible, not grayed out, no messaging). The existing VacationSummary UI is unchanged for anonymous users. All existing consuming components compile without modification after the VacationContextType interface extension.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-and-cross-device-sync/04-04-SUMMARY.md`
</output>
