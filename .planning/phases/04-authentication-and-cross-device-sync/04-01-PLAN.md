---
phase: 04-authentication-and-cross-device-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - middleware.ts
  - app/auth/callback/route.ts
  - .env.local.example
autonomous: false
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create Supabase project (if not exists)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable Google OAuth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google -> Enable"
      - task: "Set Google OAuth Client ID and Secret"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google"
  - service: google-cloud
    why: "Google OAuth credentials"
    env_vars: []
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web Application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth Client ID"
      - task: "Add authorized redirect URI: https://<SUPABASE_PROJECT_REF>.supabase.co/auth/v1/callback"
        location: "Google Cloud Console -> OAuth Client ID -> Authorized redirect URIs"

must_haves:
  truths:
    - "Supabase browser client can be created in Client Components"
    - "Supabase server client can be created in Server Components and Route Handlers"
    - "Middleware refreshes auth session on every request (not static assets)"
    - "OAuth callback route exchanges code for session and redirects to home"
    - "Database has vacation_data table with RLS policies enforcing user isolation"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser Supabase client factory with fetch-retry"
      exports: ["createClient"]
    - path: "lib/supabase/server.ts"
      provides: "Server Supabase client factory with cookie handling"
      exports: ["createClient"]
    - path: "lib/supabase/middleware.ts"
      provides: "Middleware session refresh utility"
      exports: ["updateSession"]
    - path: "middleware.ts"
      provides: "Next.js middleware entry point"
      exports: ["middleware", "config"]
    - path: "app/auth/callback/route.ts"
      provides: "OAuth PKCE callback handler"
      exports: ["GET"]
    - path: ".env.local.example"
      provides: "Environment variable template"
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "updateSession"
    - from: "app/auth/callback/route.ts"
      to: "lib/supabase/server.ts"
      via: "import createClient"
      pattern: "exchangeCodeForSession"
---

<objective>
Set up Supabase infrastructure for authentication and data storage.

Purpose: This is the foundation for all auth features. Without Supabase clients, middleware, callback route, and database schema, no other auth plan can function.

Output: Supabase client utilities (browser + server), Next.js middleware for session refresh, OAuth callback route, env var template, and database schema SQL (to be run in Supabase SQL Editor).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-and-cross-device-sync/04-CONTEXT.md
@.planning/phases/04-authentication-and-cross-device-sync/04-RESEARCH.md
@lib/vacation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create client utilities</name>
  <files>
    lib/supabase/client.ts
    lib/supabase/server.ts
    lib/supabase/middleware.ts
    .env.local.example
  </files>
  <action>
    1. Install packages: `npm install @supabase/supabase-js @supabase/ssr fetch-retry use-debounce`
       Also install types if needed: `npm install -D @types/fetch-retry` (check if needed first)

    2. Create `.env.local.example` with:
       ```
       NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
       ```

    3. Create `lib/supabase/client.ts` (Browser Client):
       - Import `createBrowserClient` from `@supabase/ssr`
       - Import `fetchRetry` from `fetch-retry` (or use default import depending on package API)
       - Export `createClient()` function that returns a browser client
       - Configure fetch-retry with 3 retries, exponential backoff (1s, 2s, 4s capped at 30s)
       - Retry on status codes: 520, 521, 522, 503 (Cloudflare + service unavailable)
       - Use `process.env.NEXT_PUBLIC_SUPABASE_URL!` and `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!`
       - Follow exact pattern from 04-RESEARCH.md Pattern 1 + Code Example "Automatic Retry with fetch-retry"

    4. Create `lib/supabase/server.ts` (Server Client):
       - Import `createServerClient` from `@supabase/ssr`
       - Import `cookies` from `next/headers`
       - Export async `createClient()` function
       - Use `await cookies()` to get cookie store (Next.js 16 requires await)
       - Implement `getAll()` and `setAll()` cookie methods
       - Wrap `setAll` in try/catch (Server Components cannot set cookies)
       - Follow exact pattern from 04-RESEARCH.md Pattern 1

    5. Create `lib/supabase/middleware.ts`:
       - Export async `updateSession(request: NextRequest)` function
       - Create server client with request cookies for getAll
       - For setAll: set on request cookies AND on response cookies
       - Call `supabase.auth.getUser()` to refresh session
       - Return the supabaseResponse
       - Follow exact pattern from 04-RESEARCH.md Pattern 3
  </action>
  <verify>
    - `npm run build` succeeds (no import errors)
    - All three files exist with correct exports
    - `@supabase/supabase-js`, `@supabase/ssr`, `fetch-retry`, `use-debounce` in package.json dependencies
  </verify>
  <done>
    Three Supabase client utilities exist and compile without errors. Browser client has fetch-retry. Server client has cookie handling. Middleware utility refreshes sessions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create middleware, OAuth callback route, and database schema SQL</name>
  <files>
    middleware.ts
    app/auth/callback/route.ts
    supabase/schema.sql
  </files>
  <action>
    1. Create `middleware.ts` at project root:
       - Import `updateSession` from `@/lib/supabase/middleware`
       - Export async `middleware(request)` that calls `updateSession(request)`
       - Export `config` with matcher that excludes static assets:
         `'/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'`
       - This prevents middleware from running on static assets (Pitfall 3 from research)

    2. Create `app/auth/callback/route.ts`:
       - Export async `GET(request: Request)` handler
       - Parse URL to extract `code` and `next` searchParams
       - If `code` exists: create server Supabase client, call `exchangeCodeForSession(code)`
       - On success: redirect to `${origin}${next}` (default next = '/')
       - On error or no code: redirect to `${origin}/` (home page)
       - Use `NextResponse.redirect()` for all redirects
       - Follow exact pattern from 04-RESEARCH.md Pattern 2

    3. Create `supabase/schema.sql` (to be run manually in Supabase SQL Editor):
       ```sql
       -- Vacation data table for authenticated users
       CREATE TABLE IF NOT EXISTS vacation_data (
         id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
         user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
         year INTEGER NOT NULL,
         total_days INTEGER NOT NULL DEFAULT 20,
         vacation_dates TEXT[] NOT NULL DEFAULT '{}',
         created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
         updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
         UNIQUE(user_id, year)
       );

       -- Performance index on user_id (Pitfall 7 from research)
       CREATE INDEX IF NOT EXISTS idx_vacation_data_user_id ON vacation_data(user_id);

       -- Enable Row Level Security (Pitfall 2 from research)
       ALTER TABLE vacation_data ENABLE ROW LEVEL SECURITY;

       -- RLS policies using (SELECT auth.uid()) for caching (Pitfall 4)
       CREATE POLICY "Users can view own vacation data"
       ON vacation_data FOR SELECT
       TO authenticated
       USING ((SELECT auth.uid()) = user_id);

       CREATE POLICY "Users can insert own vacation data"
       ON vacation_data FOR INSERT
       TO authenticated
       WITH CHECK ((SELECT auth.uid()) = user_id);

       CREATE POLICY "Users can update own vacation data"
       ON vacation_data FOR UPDATE
       TO authenticated
       USING ((SELECT auth.uid()) = user_id)
       WITH CHECK ((SELECT auth.uid()) = user_id);

       CREATE POLICY "Users can delete own vacation data"
       ON vacation_data FOR DELETE
       TO authenticated
       USING ((SELECT auth.uid()) = user_id);
       ```

       Key design decisions:
       - `year` column enables per-year data (supports rollover in Plan 04)
       - `UNIQUE(user_id, year)` prevents duplicate entries per user per year
       - `vacation_dates TEXT[]` stores ISO date strings as PostgreSQL array (matches existing VacationData.vacationDates: string[])
       - `(SELECT auth.uid())` wrapping for RLS caching optimization (Pitfall 4)
       - `ON DELETE CASCADE` cleans up data when user account is deleted
  </action>
  <verify>
    - `npm run build` succeeds
    - `middleware.ts` exists at project root
    - `app/auth/callback/route.ts` exists and exports GET
    - `supabase/schema.sql` exists with CREATE TABLE, RLS, and policies
  </verify>
  <done>
    Middleware intercepts non-static requests to refresh sessions. OAuth callback route handles PKCE code exchange. Database schema SQL is ready to execute in Supabase SQL Editor.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: User configures Supabase project and environment</name>
  <action>
    The following CANNOT be automated by Claude (requires account access and dashboard interaction):

    1. **Create Supabase project** (if not exists):
       - Go to https://supabase.com/dashboard
       - Create a new project (or use existing)

    2. **Get API credentials:**
       - Go to Project Settings -> API
       - Copy "Project URL" -> paste as `NEXT_PUBLIC_SUPABASE_URL` in `.env.local`
       - Copy "anon/public" key -> paste as `NEXT_PUBLIC_SUPABASE_ANON_KEY` in `.env.local`

    3. **Set up Google OAuth:**
       - Go to Google Cloud Console -> APIs & Services -> Credentials
       - Create OAuth 2.0 Client ID (Web Application type)
       - Add authorized redirect URI: `https://<YOUR_SUPABASE_REF>.supabase.co/auth/v1/callback`
       - Copy Client ID and Client Secret

    4. **Enable Google provider in Supabase:**
       - Go to Supabase Dashboard -> Authentication -> Providers -> Google
       - Enable it
       - Paste Google Client ID and Client Secret

    5. **Run database schema:**
       - Go to Supabase Dashboard -> SQL Editor
       - Paste contents of `supabase/schema.sql`
       - Execute

    6. **Create `.env.local`** from `.env.local.example`:
       ```bash
       cp .env.local.example .env.local
       # Then edit .env.local with your actual values
       ```
  </action>
  <resume-signal>Type "configured" when Supabase project, Google OAuth, env vars, and database schema are set up</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with all new files
- `lib/supabase/client.ts` exports `createClient` (browser)
- `lib/supabase/server.ts` exports async `createClient` (server)
- `middleware.ts` exists at project root with proper matcher config
- `app/auth/callback/route.ts` exports GET handler
- `.env.local.example` has both SUPABASE env vars documented
- `supabase/schema.sql` has vacation_data table, RLS enabled, 4 policies, user_id index
</verification>

<success_criteria>
Supabase infrastructure is fully set up: browser client with retry, server client with cookies, middleware for session refresh, OAuth callback route, env var template, and database schema SQL. User has configured their Supabase project with Google OAuth and executed the schema.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-and-cross-device-sync/04-01-SUMMARY.md`
</output>
