---
phase: 05.2-seo-improvements-and-layout-restructuring
plan: 06
type: execute
wave: 3
depends_on: ["05.2-01", "05.2-04", "05.2-05"]
files_modified:
  - app/page.tsx
  - components/YearSelector.tsx
  - components/FullYearCalendar.tsx
  - components/FullYearCalendarWrapper.tsx
autonomous: false

must_haves:
  truths:
    - "Desktop layout has three columns: left sidebar | calendar | right sidebar"
    - "Both sidebars are sticky and aligned with first calendar month"
    - "Mobile stacking order: title/description -> right sidebar -> left sidebar -> calendar"
    - "Year selector is above the calendar, horizontally centered"
    - "Year selector uses router.push to update URL searchParams (SSR-friendly)"
    - "Header contains only app title/logo and Google auth"
    - "Page title and description use constants from lib/constants.ts"
    - "School holidays are fetched server-side and passed to components"
    - "Calendar receives school holiday dates for teal display"
  artifacts:
    - path: "app/page.tsx"
      provides: "Three-column layout with left sidebar, calendar, right sidebar"
      contains: "LeftSidebar"
    - path: "components/YearSelector.tsx"
      provides: "Interactive year selector using URL-based navigation"
      exports: ["default"]
    - path: "components/FullYearCalendar.tsx"
      provides: "Calendar with school holiday dates passed to MonthGrid"
      contains: "schoolHolidayDates"
    - path: "components/FullYearCalendarWrapper.tsx"
      provides: "Client wrapper bridging school holidays to calendar"
      contains: "schoolHolidayDates"
  key_links:
    - from: "app/page.tsx"
      to: "components/LeftSidebar.tsx"
      via: "Renders LeftSidebar with holidays and school holidays"
      pattern: "LeftSidebar"
    - from: "app/page.tsx"
      to: "lib/holidays/schoolHolidays.ts"
      via: "Calls getSchoolHolidays for server-side data fetch"
      pattern: "getSchoolHolidays"
    - from: "app/page.tsx"
      to: "lib/constants.ts"
      via: "Uses PAGE_TITLE, PAGE_SUBTITLE, PAGE_DESCRIPTION"
      pattern: "import.*constants"
    - from: "components/YearSelector.tsx"
      to: "next/navigation"
      via: "useRouter for URL-based year navigation"
      pattern: "useRouter"
    - from: "components/FullYearCalendarWrapper.tsx"
      to: "components/FullYearCalendar.tsx"
      via: "Passes schoolHolidayDates prop"
      pattern: "schoolHolidayDates"
---

<objective>
Restructure the page layout into three-column desktop view, add year selector, integrate school holidays data flow, and use text constants throughout.

Purpose: This is the final integration plan that brings together all Wave 1 and Wave 2 work into the complete page layout. The three-column layout provides better information density on desktop while the mobile layout prioritizes the most important information first.

Output: Restructured page.tsx with three-column desktop / stacked mobile layout, new YearSelector component, updated FullYearCalendar and Wrapper to pass school holiday data.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-CONTEXT.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-RESEARCH.md
@app/page.tsx
@components/FullYearCalendar.tsx
@components/FullYearCalendarWrapper.tsx
@components/MonthGrid.tsx
@lib/constants.ts
@lib/holidays/schoolHolidays.ts
@components/LeftSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create YearSelector component with router-based navigation</name>
  <files>components/YearSelector.tsx</files>
  <action>
  Create `components/YearSelector.tsx` as a Client Component that uses `useRouter` from `next/navigation` to update the URL searchParams when the year changes. This preserves SSR and creates shareable URLs.

  ```tsx
  'use client';

  import { useRouter } from 'next/navigation';

  interface YearSelectorProps {
    year: number;
  }

  export default function YearSelector({ year }: YearSelectorProps) {
    const router = useRouter();
    const minYear = 2020; // OpenHolidays API BG data starts 2020
    const maxYear = 2030; // Reasonable future limit

    const handleYearChange = (newYear: number) => {
      const currentYear = new Date().getFullYear();
      if (newYear === currentYear) {
        router.push('/');
      } else {
        router.push(`/?year=${newYear}`);
      }
    };

    return (
      <div className="flex items-center justify-center gap-4 mb-4">
        <button
          onClick={() => handleYearChange(year - 1)}
          disabled={year <= minYear}
          className="px-3 py-1 text-lg font-semibold text-coffee hover:text-espresso disabled:text-oat-milk disabled:cursor-not-allowed transition-colors"
          aria-label="Предишна година"
        >
          &larr;
        </button>
        <h2 className="text-2xl font-bold text-espresso">{year}</h2>
        <button
          onClick={() => handleYearChange(year + 1)}
          disabled={year >= maxYear}
          className="px-3 py-1 text-lg font-semibold text-coffee hover:text-espresso disabled:text-oat-milk disabled:cursor-not-allowed transition-colors"
          aria-label="Следваща година"
        >
          &rarr;
        </button>
      </div>
    );
  }
  ```

  Key design:
  - Uses `useRouter` and `router.push` for URL-based year navigation (SSR-friendly, shareable URLs)
  - Receives only `year` as prop (no callback needed since navigation is handled internally)
  - When navigating to the current calendar year, pushes `/` (clean URL); otherwise `/?year=NNNN`
  - Year range bounded to 2020-2030 (API availability)
  - Coffee theme styling with Bulgarian aria labels
  - Disabled state for min/max bounds
  </action>
  <verify>TypeScript compilation succeeds. Component uses `useRouter` and `router.push` (not a callback prop).</verify>
  <done>YearSelector component created with router-based URL navigation, prev/next arrows, Coffee theme styling, and no callback prop</done>
</task>

<task type="auto">
  <name>Task 2: Update FullYearCalendar and Wrapper to pass school holidays</name>
  <files>components/FullYearCalendar.tsx, components/FullYearCalendarWrapper.tsx</files>
  <action>
  **FullYearCalendar.tsx changes:**

  1. Add `schoolHolidayDates` prop:
  ```typescript
  interface FullYearCalendarProps {
    year: number;
    holidays: Holiday[];
    vacationDates?: string[];
    schoolHolidayDates?: string[]; // NEW: individual dates from school holiday ranges
    onToggleDate?: (dateStr: string) => void;
    onPointerDown?: (dateStr: string) => void;
    onPointerEnter?: (dateStr: string) => void;
    onPointerUp?: () => void;
  }
  ```

  2. Pass `schoolHolidayDates` to each MonthGrid:
  ```tsx
  <MonthGrid
    key={monthIndex}
    year={year}
    month={monthIndex}
    holidays={monthHolidays}
    bridgeDays={visibleBridges}
    vacationDates={vacationDates}
    schoolHolidayDates={schoolHolidayDates} // NEW
    onToggleDate={onToggleDate}
    onPointerDown={onPointerDown}
    onPointerEnter={onPointerEnter}
    onPointerUp={onPointerUp}
    compact={true}
  />
  ```

  3. Remove the year header `<h1>` from FullYearCalendar (year display moves to YearSelector). Remove the `<h1 className="text-3xl font-bold mb-6">{year}</h1>` line.

  4. Remove any December-specific debug console.log blocks.

  **FullYearCalendarWrapper.tsx changes:**

  1. Add `schoolHolidayDates` prop:
  ```typescript
  interface FullYearCalendarWrapperProps {
    year: number;
    holidays: Holiday[];
    schoolHolidayDates?: string[]; // NEW
  }
  ```

  2. Pass it through to FullYearCalendar:
  ```tsx
  <FullYearCalendar
    year={year}
    holidays={holidays}
    vacationDates={vacationData.vacationDates}
    schoolHolidayDates={schoolHolidayDates} // NEW
    onToggleDate={toggleVacationDate}
    onPointerDown={handlePointerDown}
    onPointerEnter={handlePointerEnter}
    onPointerUp={handlePointerUp}
  />
  ```

  Keep ALL existing drag selection logic, vacation toggle logic, and document-level pointerup listener unchanged.
  </action>
  <verify>TypeScript compilation succeeds. Build passes. Existing drag selection and vacation tracking work unchanged.</verify>
  <done>FullYearCalendar and Wrapper pass schoolHolidayDates to MonthGrid, year header removed from FullYearCalendar</done>
</task>

<task type="auto">
  <name>Task 3: Integrate school holidays data fetching in page.tsx</name>
  <files>app/page.tsx</files>
  <action>
  Update `app/page.tsx` to fetch school holidays server-side and accept year from URL searchParams. This task focuses on data plumbing only; the full layout restructure is Task 4.

  **1. Add new imports:**
  ```typescript
  import { getYear } from 'date-fns';
  import { getSchoolHolidays, getSchoolHolidayDates } from '@/lib/holidays/schoolHolidays';
  import { PAGE_TITLE, PAGE_SUBTITLE, PAGE_DESCRIPTION } from '@/lib/constants';
  ```

  **2. Accept searchParams for year selection:**
  ```typescript
  interface PageProps {
    searchParams: Promise<{ year?: string }>;
  }

  export default async function HomePage({ searchParams }: PageProps) {
    const params = await searchParams;
    const currentYear = params.year ? parseInt(params.year, 10) : getYear(new Date());
  ```

  **3. Fetch school holidays alongside existing holiday fetch:**
  Add `getSchoolHolidays(currentYear)` to the existing Promise.all:
  ```typescript
  const [prevYearHolidays, currentYearHolidays, nextYearHolidays, schoolHolidays] = await Promise.all([
    getHolidays(currentYear - 1),
    getHolidays(currentYear),
    getHolidays(currentYear + 1),
    getSchoolHolidays(currentYear),
  ]);

  const holidays = [...prevYearHolidays, ...currentYearHolidays, ...nextYearHolidays];

  // Generate individual school holiday dates for calendar display
  const schoolHolidayDatesSet = getSchoolHolidayDates(schoolHolidays);
  const schoolHolidayDates = Array.from(schoolHolidayDatesSet);
  ```

  **4. Update text to use constants:**
  Replace any hardcoded title/description strings with `PAGE_TITLE(currentYear)`, `PAGE_SUBTITLE`, `PAGE_DESCRIPTION`.

  **5. Pass new data to components:**
  - Pass `schoolHolidayDates` to `FullYearCalendarWrapper`
  - Pass `schoolHolidays` and `year={currentYear}` to `LeftSidebar`
  - Pass `year={currentYear}` to `YearSelector`

  Keep the existing layout structure for now (Task 4 will restructure it). Just ensure all data flows correctly.
  </action>
  <verify>
  1. `npm run build` succeeds
  2. School holidays data is fetched and passed to components
  3. Year from URL searchParams is used correctly
  4. Text constants are imported and used
  </verify>
  <done>
  page.tsx updated with:
  - URL searchParams-based year selection
  - School holidays fetched server-side via Promise.all
  - School holiday dates expanded and passed to FullYearCalendarWrapper
  - Text constants from lib/constants.ts
  - Data ready for layout restructure in Task 4
  </done>
</task>

<task type="auto">
  <name>Task 4: Restructure page.tsx layout (three-column desktop, mobile stacking)</name>
  <files>app/page.tsx</files>
  <action>
  Restructure the JSX in `app/page.tsx` to implement the three-column desktop layout and correct mobile stacking order. Building on Task 3's data integration.

  **Layout structure:**

  ```tsx
  return (
    <main className="min-h-screen">
      <VacationProvider>
        {/* Mobile Layout */}
        <div className="lg:hidden">
          <div className="p-4">
            {/* Header: title + auth */}
            <div className="flex justify-between items-start mb-4">
              <h1 className="text-2xl font-bold text-espresso">{PAGE_TITLE(currentYear)}</h1>
              <AuthHeader />
            </div>
            <p className="text-coffee text-sm mb-4">{PAGE_SUBTITLE}</p>

            {/* Right sidebar content first on mobile */}
            <Legend />
            <VacationSummary />

            {/* Left sidebar content */}
            <div className="mt-4">
              <LeftSidebar holidays={holidays} schoolHolidays={schoolHolidays} year={currentYear} />
            </div>
          </div>

          {/* Year selector + Calendar */}
          <div className="p-4">
            <YearSelector year={currentYear} />
            <FullYearCalendarWrapper
              year={currentYear}
              holidays={holidays}
              schoolHolidayDates={schoolHolidayDates}
            />
          </div>
        </div>

        {/* Desktop Layout: Three columns */}
        <div className="hidden lg:block">
          {/* Header: title + auth */}
          <div className="flex justify-between items-center p-4 pb-2">
            <div>
              <h1 className="text-3xl font-bold text-espresso">{PAGE_TITLE(currentYear)}</h1>
              <p className="text-coffee text-sm mt-1">{PAGE_SUBTITLE}</p>
            </div>
            <AuthHeader />
          </div>

          {/* Three-column layout */}
          <div className="flex gap-4 px-4">
            {/* Left Sidebar - sticky, aligned with first month */}
            <div className="w-72 flex-shrink-0">
              <div className="sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto">
                <LeftSidebar holidays={holidays} schoolHolidays={schoolHolidays} year={currentYear} />
              </div>
            </div>

            {/* Center: Year selector + Calendar */}
            <div className="flex-1 min-w-0">
              <YearSelector year={currentYear} />
              <FullYearCalendarWrapper
                year={currentYear}
                holidays={holidays}
                schoolHolidayDates={schoolHolidayDates}
              />
            </div>

            {/* Right Sidebar - sticky, aligned with first month */}
            <div className="w-72 flex-shrink-0">
              <div className="sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto">
                <Legend />
                <VacationSummary />
              </div>
            </div>
          </div>
        </div>
      </VacationProvider>
    </main>
  );
  ```

  Key design decisions:
  - Separate `lg:hidden` and `hidden lg:block` divs for mobile vs desktop
  - Both sidebars use `sticky top-4` to stay visible during scroll
  - `max-h-[calc(100vh-2rem)]` prevents sidebar from exceeding viewport
  - Left sidebar: w-72 (288px), Right sidebar: w-72 (288px)
  - Calendar: flex-1 with min-w-0 to prevent overflow
  - Mobile order: Title/Description -> Legend/Summary -> Left Sidebar -> YearSelector -> Calendar
  - Desktop: Header above, then three columns below
  - VacationProvider wraps everything (existing pattern, do NOT change nesting)
  - Header contains ONLY title + AuthHeader (VacationSummary moved to right sidebar)
  </action>
  <verify>
  1. `npm run build` succeeds
  2. Desktop layout shows three columns (resize browser to confirm)
  3. Mobile layout stacks correctly (use responsive dev tools)
  4. Year selector changes URL and reloads with new year data
  5. Left sidebar shows holidays and school vacations
  6. Existing vacation tracking and drag selection still work
  </verify>
  <done>
  page.tsx restructured with:
  - Three-column desktop layout (left sidebar | calendar | right sidebar)
  - Correct mobile stacking order
  - Year selector above calendar
  - Both sidebars sticky
  - Header with only title + auth
  - VacationSummary in right sidebar (not header)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete three-column layout with year selector, school holidays, and mobile responsive design</what-built>
  <how-to-verify>
  1. Open http://localhost:3000 on desktop - verify three-column layout (left sidebar | calendar | right sidebar)
  2. Both sidebars should stay visible while scrolling the calendar
  3. Click year arrows - URL should change (e.g., /?year=2025) and data should reload
  4. Left sidebar should show official holidays and school vacations
  5. Calendar should show school holidays in teal
  6. Resize to mobile width - verify stacking order: title -> legend/summary -> left sidebar -> calendar
  7. Try drag selection on calendar - should still work
  8. Header should only show title and auth button (no VacationSummary)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Desktop: Three-column layout visible (left sidebar, calendar, right sidebar)
2. Desktop: Both sidebars sticky while scrolling calendar
3. Mobile: Correct stacking order (title -> right sidebar content -> left sidebar -> calendar)
4. Year selector above calendar, horizontally centered
5. Clicking year arrows navigates to new URL and loads correct year data
6. Header shows only title/logo and Google auth button
7. Left sidebar shows official holidays and school vacations
8. Calendar shows school holidays in teal
9. All text uses constants (no inline Bulgarian strings in page.tsx)
10. Existing vacation tracking and drag selection preserved
11. Build succeeds
</verification>

<success_criteria>
- Complete three-column layout on desktop
- Correct responsive mobile layout
- Year selection works via URL params (router.push)
- School holidays displayed in both sidebar and calendar
- All existing features (vacation tracking, drag selection, auth) preserved
- Text constants used throughout
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-06-SUMMARY.md`
</output>
