---
phase: 05.2-seo-improvements-and-layout-restructuring
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/holidays/schoolHolidays.ts
  - components/MonthGrid.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "School holidays only appear on weekday cells (Mon-Fri), never on Saturday or Sunday"
    - "Лятна ваканция (summer vacation, ~May-Sep) is completely excluded from school holidays"
    - "When a bridge day and school holiday overlap on the same cell, the cell is split in two halves"
    - "Weekend holidays are shown on BOTH the weekend day AND the transferred Monday"
  artifacts:
    - path: "lib/holidays/schoolHolidays.ts"
      provides: "Weekend filtering and summer vacation exclusion"
      contains: "getISODay"
    - path: "components/MonthGrid.tsx"
      provides: "Split-cell rendering, weekend holiday display"
      contains: "linear-gradient"
  key_links:
    - from: "lib/holidays/schoolHolidays.ts"
      to: "components/MonthGrid.tsx"
      via: "schoolHolidayDates prop"
      pattern: "schoolHolidaySet"
    - from: "components/MonthGrid.tsx"
      to: "components/DayTooltip.tsx"
      via: "displayAsHoliday renders DayTooltip"
      pattern: "DayTooltip"
---

<objective>
Fix school holiday data layer (filter weekends, exclude summer vacation) and calendar rendering (split-cell for bridge+school overlap, show weekend holidays on both days).

Purpose: Close UAT gaps T9 (school holidays weekday-only, no summer, split-cell) and T10 (show holidays on weekends too). These are data accuracy and visual rendering fixes.
Output: Updated schoolHolidays.ts with filtering, MonthGrid.tsx with split-cell and weekend holiday display.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/holidays/schoolHolidays.ts
@components/MonthGrid.tsx
@lib/holidays/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter weekends and exclude summer vacation from school holidays</name>
  <files>lib/holidays/schoolHolidays.ts</files>
  <action>
  Two changes to schoolHolidays.ts:

  **1. Exclude "Лятна ваканция" from getSchoolHolidays():**
  After the deduplication step (around line 67, after `const deduplicated = Array.from(merged.values());`), add a filter:
  ```typescript
  // Exclude Лятна ваканция — too long, too static, skip for every year per UAT feedback
  const filtered = deduplicated.filter(h => !h.name.includes('Лятна ваканция'));
  ```
  Then return `filtered` instead of `deduplicated`. Also update the log line to use `filtered.length`.

  **2. Filter weekends from getSchoolHolidayDates():**
  Import `getISODay` from date-fns (add to existing import line).
  In the `getSchoolHolidayDates()` function, after generating each day in the range, check if it's a weekday before adding to the set:
  ```typescript
  for (const day of daysInRange) {
    const isoDay = getISODay(day); // 1=Monday, 7=Sunday
    if (isoDay <= 5) { // Only weekdays (Mon-Fri)
      dates.add(format(day, 'yyyy-MM-dd'));
    }
  }
  ```

  **Why:** User explicitly said "School holidays should NOT display on Saturday/Sunday — weekdays only" and "Skip 'Лятна ваканция' (16 May – 14 Sep) entirely — too long, too static, skip for every year."
  </action>
  <verify>
  - Run `npm run build` to confirm no build errors
  - Grep schoolHolidays.ts for "getISODay" to confirm import added
  - Grep schoolHolidays.ts for "Лятна ваканция" to confirm filter exists
  </verify>
  <done>
  - getSchoolHolidayDates() only returns weekday dates (Mon-Fri)
  - getSchoolHolidays() excludes any holiday whose name contains "Лятна ваканция"
  </done>
</task>

<task type="auto">
  <name>Task 2: Show weekend holidays + split-cell for bridge+school overlap</name>
  <files>components/MonthGrid.tsx</files>
  <action>
  Two changes to MonthGrid.tsx:

  **1. Show holidays on weekends (T10 fix):**
  Current line 120: `const showAsHoliday = isHoliday && !isWeekendHoliday;`
  Change to: `const showAsHoliday = isHoliday;`

  This means holidays on Saturday/Sunday will display with cinnamon color AND have their tooltip. The transferred Monday ALSO still shows as a holiday. Both days show cinnamon + tooltip.

  Keep the `isWeekendHoliday` variable declaration (line 119) — it may still be useful for other logic. But remove it from the `showAsHoliday` condition.

  Keep `showAsTransferred` and `displayAsHoliday` logic unchanged — a Monday can still show as transferred if it isn't already a regular holiday.

  **2. Split-cell rendering for bridge+school overlap (T9 fix):**
  In the day classes section (around lines 131-147), add a new condition for when a cell is BOTH a bridge day AND a school holiday (but NOT a holiday or vacation):

  After the existing class conditions, detect the overlap:
  ```typescript
  const isBridgeSchoolOverlap = isBridge && isSchoolHoliday && !displayAsHoliday && !isVacation;
  ```

  In the `dayClasses` array, add this condition BEFORE the individual bridge and school holiday conditions:
  ```typescript
  !isHighlighted && !displayAsHoliday && !isVacation && isBridgeSchoolOverlap && 'text-espresso',
  ```

  And modify the existing school holiday and bridge conditions to exclude the overlap case:
  ```typescript
  !isHighlighted && !displayAsHoliday && !isVacation && isSchoolHoliday && !isBridgeSchoolOverlap && 'bg-school-bg text-teal',
  !isHighlighted && !displayAsHoliday && !isVacation && !isSchoolHoliday && isBridge && 'bg-bridge-bg text-bridge',
  ```

  For the visual split-cell, use inline style with CSS linear-gradient when `isBridgeSchoolOverlap` is true. Add this to the `<div>` element's style prop:
  ```typescript
  style={{
    ...(index === 0 ? { gridColumnStart: firstDayOfWeek + 1 } : {}),
    ...(isBridgeSchoolOverlap ? {
      background: 'linear-gradient(135deg, var(--color-bridge-bg) 50%, var(--color-school-bg) 50%)'
    } : {})
  }}
  ```

  Replace the existing `style` attribute on the day cell div to use the combined style object above.

  **Why this approach:** Using CSS linear-gradient at 135deg creates a diagonal split showing bridge color on top-left and school color on bottom-right. This is the simplest visual indicator that doesn't require extra DOM elements.
  </action>
  <verify>
  - Grep MonthGrid.tsx for "isWeekendHoliday" — should NOT appear in showAsHoliday assignment
  - Grep MonthGrid.tsx for "linear-gradient" — should find the split-cell style
  - Grep MonthGrid.tsx for "isBridgeSchoolOverlap" — should find the overlap detection
  - Run `npm run build` to confirm no build errors
  </verify>
  <done>
  - Weekend holidays display cinnamon color on the weekend day itself (Saturday or Sunday)
  - Transferred Monday ALSO displays cinnamon color (both days show holiday)
  - Tooltips work on both weekend holiday and transferred Monday
  - Bridge+school overlap cells show diagonal split (bridge top-left, school bottom-right)
  - Build passes cleanly
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- MonthGrid.tsx line with `showAsHoliday` does NOT contain `!isWeekendHoliday`
- schoolHolidays.ts filters out Лятна ваканция
- schoolHolidays.ts uses getISODay to filter weekends
- MonthGrid.tsx has split-cell gradient for bridge+school overlap
</verification>

<success_criteria>
1. School holiday cells only appear on weekdays in the calendar
2. No "Лятна ваканция" entries in school holidays data
3. Weekend holidays show cinnamon on BOTH weekend day and transferred Monday
4. Bridge+school overlap cells show diagonal split with both colors
5. Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-08-SUMMARY.md`
</output>
