---
phase: 05.2-seo-improvements-and-layout-restructuring
plan: 02
subsystem: api
tags: [openholidays-api, date-fns, school-holidays, data-layer]

# Dependency graph
requires:
  - phase: 01-foundation-static-holiday-view
    provides: Holiday type definition, fetchWithRetry pattern, OpenHolidays API integration
  - phase: 05-offline-support
    provides: fetchWithRetry with exponential backoff and 24hr cache

provides:
  - SchoolHoliday type definition with Bulgarian name and grade level support
  - getSchoolHolidays() fetch function with OpenHolidays API integration
  - getSchoolHolidayDates() utility for expanding date ranges to individual dates
  - 2026 school holidays fallback JSON with 10 vacation periods

affects: [05.2-04-left-sidebar-school-holidays, calendar-display, vacation-planning]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - School holiday date range expansion using eachDayOfInterval
    - Deduplication of overlapping school holiday entries by merging date ranges
    - Grade level extraction from multilingual API comments

key-files:
  created:
    - lib/holidays/schoolHolidays.ts
    - data/school-holidays-2026-fallback.json
  modified:
    - lib/holidays/types.ts

key-decisions:
  - "Use fetchWithRetry pattern matching public holidays (24hr cache, exponential backoff)"
  - "Extract Bulgarian names and grade levels from multilingual API response"
  - "Deduplicate overlapping school holiday entries by merging date ranges"
  - "Expand date ranges to individual dates using eachDayOfInterval for O(1) calendar lookup"

patterns-established:
  - "School holiday data layer: SchoolHoliday type with startDate/endDate ranges"
  - "Date range expansion: convert ranges to Set<string> of individual dates for performance"
  - "Grade level support: optional gradeLevel field for differentiation (I-XI клас, XII клас)"

# Metrics
duration: 2min
completed: 2026-02-07
---

# Phase 05.2 Plan 02: School Holidays Data Layer Summary

**Bulgarian school vacation periods fetched from OpenHolidays API with date range expansion, grade level support, and 2026 fallback JSON**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-07T16:43:21Z
- **Completed:** 2026-02-07T16:45:17Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- SchoolHoliday type definition with Bulgarian name, date ranges, and grade level support
- getSchoolHolidays() fetches from OpenHolidays SchoolHolidays API with retry + fallback pattern
- getSchoolHolidayDates() expands date ranges to individual dates for O(1) calendar lookup
- 2026 fallback JSON created from real API data with 10 school vacation periods (Коледна, Междусрочна, Пролетна, Лятна)
- Deduplication logic merges overlapping entries with same name

## Task Commits

Each task was committed atomically:

1. **Task 1: Add SchoolHoliday type to types.ts** - `8eac609` (feat)
2. **Task 2: Create school holidays fetch function and fallback** - `c520009` (feat)

## Files Created/Modified

- `lib/holidays/types.ts` - Added SchoolHoliday interface with startDate/endDate ranges and optional gradeLevel
- `lib/holidays/schoolHolidays.ts` - Fetch function with OpenHolidays API integration, deduplication, and date expansion utility
- `data/school-holidays-2026-fallback.json` - Static fallback with 10 Bulgarian school vacation periods

## Decisions Made

**1. Deduplicate overlapping school holiday entries**
- OpenHolidays API returns multiple overlapping entries for same vacation (different grade levels)
- Merge overlapping entries with same name by taking earliest startDate and latest endDate
- Combine grade level info: "I-XI клас, XII клас"
- Non-overlapping entries with same name kept separate (e.g., different "Лятна ваканция" periods)

**2. Extract Bulgarian names and grade levels**
- Search for `language === "BG"` in multilingual `name` array
- Extract grade level from `comment` field (e.g., "I-XI клас", "XII клас")
- Fall back to first language if Bulgarian not available

**3. Date range expansion for calendar display**
- School holidays are date ranges (startDate to endDate)
- Use eachDayOfInterval to generate all individual dates in range
- Return Set<string> for O(1) lookup performance during calendar rendering
- Use parseISO for Safari-safe date parsing (TECH-07)

**4. Follow public holidays pattern exactly**
- Use fetchWithRetry with 24hr cache (matches getHolidays)
- Use API dates directly (already YYYY-MM-DD, no toISOString)
- Fallback to static JSON on API failure
- Console logging for debugging

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- School holiday data layer ready for left sidebar display (05.2-04)
- Date expansion utility ready for calendar integration
- Fallback JSON ensures offline resilience
- Grade level support enables future filtering/customization

---
*Phase: 05.2-seo-improvements-and-layout-restructuring*
*Completed: 2026-02-07*
