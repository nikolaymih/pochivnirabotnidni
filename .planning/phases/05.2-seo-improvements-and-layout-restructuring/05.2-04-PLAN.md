---
phase: 05.2-seo-improvements-and-layout-restructuring
plan: 04
type: execute
wave: 2
depends_on: ["05.2-02", "05.2-03"]
files_modified:
  - components/MonthGrid.tsx
  - components/DayTooltip.tsx
autonomous: true

must_haves:
  truths:
    - "Holiday cells use solid cinnamon background with white text (not light holiday-bg)"
    - "School holiday dates show teal school-bg background color on calendar"
    - "Day type priority: Holiday > Vacation > School Holiday > Bridge > Weekend"
    - "Weekend holidays display on Monday only (not on weekend day)"
    - "Monday substitute holiday tooltip shows holiday name + (почивен ден)"
    - "Tooltips appear on desktop hover only, not on mobile"
    - "Calendar cells have max-width 650px and max-height 320px per month"
    - "When vacation and school holiday overlap, vacation color wins with small teal dot indicator"
  artifacts:
    - path: "components/MonthGrid.tsx"
      provides: "Updated calendar grid with school holidays, fixed colors, weekend transfer, dimensions"
      contains: "schoolHolidayDates"
    - path: "components/DayTooltip.tsx"
      provides: "Desktop-only tooltip (hidden on mobile via CSS)"
      contains: "hidden lg:block"
  key_links:
    - from: "components/MonthGrid.tsx"
      to: "components/DayTooltip.tsx"
      via: "Renders DayTooltip on holiday cells"
      pattern: "DayTooltip"
    - from: "components/MonthGrid.tsx"
      to: "app/globals.css"
      via: "Uses bg-cinnamon, bg-school-bg, text-teal tokens"
      pattern: "bg-cinnamon|bg-school-bg"
---

<objective>
Update MonthGrid with holiday color fix, school holiday display, weekend holiday transfer to Monday, day type priority reorder, tooltip integration (desktop-only), and calendar dimension constraints.

Purpose: Fix multiple visual and behavioral issues in the calendar grid. Holidays must use solid cinnamon (matching legend), school holidays need teal display, weekend holidays must transfer to Monday, and tooltips must work on desktop hover without conflicting with mobile drag selection.

Output: Updated MonthGrid with all rendering fixes, updated DayTooltip with desktop-only behavior.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-CONTEXT.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-RESEARCH.md
@components/MonthGrid.tsx
@components/DayTooltip.tsx
@components/FullYearCalendar.tsx
@lib/holidays/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update existing DayTooltip for desktop-only behavior</name>
  <files>components/DayTooltip.tsx</files>
  <action>
  Update the existing `components/DayTooltip.tsx` component to be desktop-only (no mobile interaction):

  1. Remove the `onClick` handler entirely - tooltips should NOT toggle on click/tap
  2. Keep only `onMouseEnter` and `onMouseLeave` for desktop hover
  3. Add a prop for substitute day display: `isSubstitute?: boolean`
  4. When `isSubstitute` is true, append " (почивен ден)" to the holiday name in tooltip
  5. The tooltip button wrapper should have `className="hidden lg:block absolute top-0 right-0"` to hide on mobile via CSS media query

  Updated component:
  ```tsx
  'use client';

  import { useState } from 'react';
  import { format } from 'date-fns';
  import { bg } from 'date-fns/locale';
  import { parseDate } from '@/lib/calendar/dates';
  import type { Holiday } from '@/lib/holidays/types';

  interface DayTooltipProps {
    holiday: Holiday;
    isSubstitute?: boolean;
  }

  export default function DayTooltip({ holiday, isSubstitute = false }: DayTooltipProps) {
    const [isVisible, setIsVisible] = useState(false);

    const displayName = isSubstitute
      ? `${holiday.name} (почивен ден)`
      : holiday.name;

    return (
      <div className="hidden lg:block absolute top-0 right-0">
        <button
          onMouseEnter={() => setIsVisible(true)}
          onMouseLeave={() => setIsVisible(false)}
          className="text-xs bg-foam/80 text-espresso rounded-full w-4 h-4 flex items-center justify-center font-bold hover:bg-cream transition-colors"
          aria-label="Подробности за празника"
          type="button"
        >
          i
        </button>

        {isVisible && (
          <div
            className="absolute right-0 top-5 z-10 w-48 p-3 bg-espresso text-foam text-sm rounded shadow-lg"
            onMouseEnter={() => setIsVisible(true)}
            onMouseLeave={() => setIsVisible(false)}
          >
            <div className="font-bold mb-1">{displayName}</div>
            <div className="text-xs opacity-80 mb-1">
              {format(parseDate(holiday.date), 'd MMMM yyyy', { locale: bg })}
            </div>
          </div>
        )}
      </div>
    );
  }
  ```

  Key changes:
  - Removed onClick handler (no mobile tooltip interaction)
  - Added `hidden lg:block` to wrapper div (CSS hides on mobile)
  - Added `isSubstitute` prop for weekend holiday transfer display
  - Made tooltip popup also have onMouseEnter/onMouseLeave so user can hover over tooltip content
  - Reduced info button size to w-4 h-4 (smaller, less obtrusive on calendar cells)
  - Changed date format to Bulgarian style: `d MMMM yyyy` instead of `MMM d, yyyy`
  - Removed the holiday.type display line (unnecessary detail)
  </action>
  <verify>TypeScript compilation succeeds. Component renders without errors in build.</verify>
  <done>DayTooltip is desktop-only (hidden on mobile via CSS), supports isSubstitute prop, no onClick handler</done>
</task>

<task type="auto">
  <name>Task 2a: Update MonthGrid colors, dimensions, and tooltip rendering</name>
  <files>components/MonthGrid.tsx</files>
  <action>
  Make the following changes to MonthGrid.tsx (color fixes, dimension constraints, tooltip rendering):

  **1. Add DayTooltip import:**
  ```typescript
  import DayTooltip from './DayTooltip';
  ```

  **2. Add `relative` to day cell classes:**
  The day cell must include `relative` in its className so that the absolutely-positioned DayTooltip renders correctly within the cell.

  **3. Fix holiday cell color - solid cinnamon with white text:**
  Replace the existing holiday color class (e.g., `bg-holiday-bg text-holiday`) with:
  ```
  bg-cinnamon text-white font-semibold
  ```
  This makes holiday cells match the legend (solid dark background, white text).

  **4. Add tooltip rendering for holiday cells:**
  Inside the day cell div, after the day number, add:
  ```tsx
  {/* Desktop-only tooltip for holidays */}
  {isHoliday && (
    <DayTooltip
      holiday={holidays.find(h => h.date === dateStr)!}
    />
  )}
  ```
  (The `isSubstitute` prop will be added in Task 2b when weekend transfer logic is implemented.)

  **5. Add max dimensions to the month container:**
  Change the outer month div to include dimension constraints:
  ```tsx
  <div className="border border-latte rounded-lg p-3 bg-white shadow-sm max-w-[650px] max-h-[320px] overflow-hidden">
  ```

  **6. Remove debug console.log for December:**
  Remove the December-specific debug logging block (if present in current file).

  **IMPORTANT:**
  - Keep all existing pointer event handlers unchanged
  - Keep the highlight flash logic unchanged
  - Keep the grid column start positioning unchanged
  - Do NOT add school holiday logic yet (Task 2b)
  - Do NOT add weekend transfer logic yet (Task 2b)
  </action>
  <verify>
  1. `npm run build` succeeds
  2. Existing bridge day tests still pass: `npx jest lib/calendar/bridgeDays.test.ts`
  3. Visual verification: holiday cells should show solid cinnamon with white text
  </verify>
  <done>
  MonthGrid updated with:
  - Solid cinnamon holiday cells with white text (color fix)
  - Desktop-only tooltip on holiday cells
  - Max dimensions (650px width, 320px height)
  - `relative` positioning on day cells for tooltip
  - Debug logging removed
  </done>
</task>

<task type="auto">
  <name>Task 2b: Add weekend transfer, school holidays, priority reorder, and indicators to MonthGrid</name>
  <files>components/MonthGrid.tsx</files>
  <action>
  Continue updating MonthGrid.tsx with behavioral changes (building on Task 2a):

  **1. Add new props:**
  ```typescript
  interface MonthGridProps {
    // ... existing props ...
    schoolHolidayDates?: string[];  // Individual dates from school holiday ranges
  }
  ```

  **2. Add school holiday Set in the component body:**
  ```typescript
  const schoolHolidaySet = new Set(schoolHolidayDates || []);
  ```

  **3. Add weekend holiday transfer logic:**
  Inside the days.map callback, after calculating `isHoliday`:

  ```typescript
  // Weekend holiday transfer: check if this Monday is a substitute for a weekend holiday
  let transferredHoliday: Holiday | null = null;
  const isMonday = dayOfWeek === 0; // 0=Monday in our system

  if (isMonday && !isHoliday) {
    // Check Saturday (2 days back) and Sunday (1 day back)
    const saturdayDate = format(new Date(year, month, day - 2), 'yyyy-MM-dd');
    const sundayDate = format(new Date(year, month, day - 1), 'yyyy-MM-dd');

    const satHoliday = holidays.find(h => h.date === saturdayDate);
    const sunHoliday = holidays.find(h => h.date === sundayDate);
    transferredHoliday = sunHoliday || satHoliday || null;
  }

  const isTransferredHoliday = transferredHoliday !== null;
  const effectiveHoliday = isHoliday || isTransferredHoliday;
  ```

  Also, for weekend days that have holidays, suppress the holiday appearance:
  ```typescript
  // Weekend holidays should NOT show holiday color on the weekend day itself
  const isWeekendHoliday = isWeekend && holidayDates.has(dateStr);
  const showAsHoliday = isHoliday && !isWeekendHoliday; // Don't show holiday on weekend
  const showAsTransferred = isTransferredHoliday;
  const displayAsHoliday = showAsHoliday || showAsTransferred;
  ```

  **4. Add school holiday check:**
  ```typescript
  const isSchoolHoliday = schoolHolidaySet.has(dateStr);
  ```

  **5. Update day type priority (New priority order):**
  ```typescript
  const dayClasses = [
    'p-2 text-center rounded text-xs',
    'min-w-[44px] min-h-[44px]',
    'flex items-center justify-center',
    'transition-colors duration-150',
    'relative', // For tooltip positioning
    isToday && 'ring-2 ring-today-ring',
    isHighlighted && 'bg-highlight',
    // Priority 1: Official Holiday (solid cinnamon with white text)
    !isHighlighted && displayAsHoliday && 'bg-cinnamon text-white font-semibold',
    // Priority 2: Personal Vacation
    !isHighlighted && !displayAsHoliday && isVacation && 'bg-vacation-bg text-vacation',
    // Priority 3: School Holiday (teal)
    !isHighlighted && !displayAsHoliday && !isVacation && isSchoolHoliday && 'bg-school-bg text-black',
    // Priority 4: Bridge Day Suggestion
    !isHighlighted && !displayAsHoliday && !isVacation && !isSchoolHoliday && isBridge && 'bg-bridge-bg text-bridge',
    // Priority 5: Weekend
    !isHighlighted && !displayAsHoliday && !isVacation && !isSchoolHoliday && !isBridge && isWeekend && 'bg-weekend-bg text-weekend-text',
    // Default: Workday
    !isHighlighted && !displayAsHoliday && !isVacation && !isSchoolHoliday && !isBridge && !isWeekend && 'hover:bg-cream',
    isClickable && 'cursor-pointer',
    isClickable && 'touch-none',
  ].filter(Boolean).join(' ');
  ```

  **6. Update isClickable logic:**
  ```typescript
  // Holidays (including transferred) are not clickable
  const isClickable = !displayAsHoliday;
  ```

  **7. Add school holiday indicator for vacation+school overlap:**
  When a day is both vacation AND school holiday, show a small teal dot:
  ```tsx
  {/* School holiday indicator dot when overlapping with vacation */}
  {isVacation && isSchoolHoliday && !displayAsHoliday && (
    <div className="absolute top-0.5 right-0.5 w-1.5 h-1.5 rounded-full bg-teal" />
  )}
  ```

  **8. Update tooltip rendering to support transferred holidays:**
  Replace the simple DayTooltip render from Task 2a with:
  ```tsx
  {/* Desktop-only tooltip for holidays */}
  {displayAsHoliday && (
    <DayTooltip
      holiday={transferredHoliday || holidays.find(h => h.date === dateStr)!}
      isSubstitute={isTransferredHoliday}
    />
  )}
  ```

  **IMPORTANT:**
  - Keep all existing pointer event handlers unchanged
  - Keep the highlight flash logic unchanged
  - Keep the grid column start positioning unchanged
  - The `holidays` prop is used both for display AND for weekend transfer lookup, so ALL holidays for the month must still be passed (not just weekday holidays)
  - For weekend holiday transfer: use the full holidays array, not just holidayDates set, because we need the Holiday object for tooltip display
  </action>
  <verify>
  1. `npm run build` succeeds
  2. Existing bridge day tests still pass: `npx jest lib/calendar/bridgeDays.test.ts`
  3. Visual verification: school holidays in teal, weekend holidays transferred to Monday
  </verify>
  <done>
  MonthGrid updated with:
  - School holiday display with teal bg
  - New day type priority (Holiday > Vacation > School > Bridge > Weekend)
  - Weekend holiday transfer to Monday
  - School holiday + vacation overlap dot indicator
  - Transferred holiday tooltip with "(почивен ден)" label
  - isClickable updated to exclude transferred holidays
  </done>
</task>

</tasks>

<verification>
1. Holiday cells use `bg-cinnamon text-white` (not `bg-holiday-bg text-holiday`)
2. School holidays show `bg-school-bg text-black`
3. Priority order: holiday > vacation > school > bridge > weekend
4. Weekend holidays show as regular weekend; Monday shows as holiday with "(почивен ден)" tooltip
5. Tooltips hidden on mobile, visible on desktop hover
6. Month cells have max-width 650px and max-height 320px
7. Vacation + school holiday overlap shows vacation color + teal dot
8. Build succeeds, existing tests pass
</verification>

<success_criteria>
- Calendar cells match legend colors exactly
- Weekend holidays correctly transfer to Monday
- Mobile users cannot trigger tooltips (no interference with drag selection)
- Calendar proportions are bounded by max dimensions
- All existing drag selection and vacation tracking functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-04-SUMMARY.md`
</output>
