---
phase: 05.2-seo-improvements-and-layout-restructuring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/holidays/types.ts
  - lib/holidays/schoolHolidays.ts
  - data/school-holidays-2026-fallback.json
autonomous: true

must_haves:
  truths:
    - "School holidays can be fetched from OpenHolidays API for Bulgaria"
    - "School holidays have Bulgarian names extracted from multilingual API response"
    - "School holiday data includes start date, end date, name, and optional grade level"
    - "Fallback JSON exists for 2026 school holidays"
    - "Individual dates within school holiday ranges can be generated for calendar display"
  artifacts:
    - path: "lib/holidays/types.ts"
      provides: "SchoolHoliday interface definition"
      contains: "SchoolHoliday"
    - path: "lib/holidays/schoolHolidays.ts"
      provides: "getSchoolHolidays fetch function with retry + fallback"
      exports: ["getSchoolHolidays", "getSchoolHolidayDates"]
    - path: "data/school-holidays-2026-fallback.json"
      provides: "Static fallback for school holiday data"
  key_links:
    - from: "lib/holidays/schoolHolidays.ts"
      to: "https://openholidaysapi.org/SchoolHolidays"
      via: "fetchWithRetry"
      pattern: "openholidaysapi.org/SchoolHolidays"
    - from: "lib/holidays/schoolHolidays.ts"
      to: "lib/holidays/types.ts"
      via: "import SchoolHoliday"
      pattern: "import.*SchoolHoliday"
---

<objective>
Create the school holidays data layer: type definition, API fetch function with retry/fallback, and static fallback JSON.

Purpose: Enable the app to fetch and display Bulgarian school vacation periods from the OpenHolidays API, following the same architectural patterns as public holidays (fetchWithRetry + static fallback).

Output: `SchoolHoliday` interface, `getSchoolHolidays()` fetch function, `getSchoolHolidayDates()` utility for calendar display, and 2026 fallback JSON.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-CONTEXT.md
@.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-RESEARCH.md
@lib/holidays/types.ts
@lib/holidays/fetch.ts
@lib/offline/retry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SchoolHoliday type to types.ts</name>
  <files>lib/holidays/types.ts</files>
  <action>
  Add the `SchoolHoliday` interface to the existing `lib/holidays/types.ts` file. Keep existing Holiday and HolidayType exports unchanged.

  Add:
  ```typescript
  export interface SchoolHoliday {
    name: string;           // Bulgarian name (e.g., "Коледна ваканция")
    startDate: string;      // ISO date string YYYY-MM-DD
    endDate: string;        // ISO date string YYYY-MM-DD
    type: 'School';
    gradeLevel?: string;    // Optional grade info (e.g., "I-XI клас")
  }
  ```

  This must be appended after the existing exports, not replacing anything.
  </action>
  <verify>TypeScript compilation succeeds and existing Holiday type still works</verify>
  <done>SchoolHoliday interface exported from lib/holidays/types.ts alongside existing Holiday type</done>
</task>

<task type="auto">
  <name>Task 2: Create school holidays fetch function and fallback</name>
  <files>lib/holidays/schoolHolidays.ts, data/school-holidays-2026-fallback.json</files>
  <action>
  Create `lib/holidays/schoolHolidays.ts` following the exact same pattern as `lib/holidays/fetch.ts`:

  1. Import `fetchWithRetry` from `@/lib/offline/retry`
  2. Import `SchoolHoliday` from `./types`
  3. Import `eachDayOfInterval, parseISO, format` from `date-fns`

  **getSchoolHolidays function:**
  ```typescript
  export async function getSchoolHolidays(year: number): Promise<SchoolHoliday[]>
  ```
  - API URL: `https://openholidaysapi.org/SchoolHolidays?countryIsoCode=BG&validFrom=${year}-01-01&validTo=${year}-12-31`
  - Use `fetchWithRetry` with `{ next: { revalidate: 86400 } }` (24hr cache)
  - Map response to SchoolHoliday objects:
    - `name`: Extract BG text: `h.name?.find((n: any) => n.language === "BG")?.text || h.name?.[0]?.text`
    - `startDate`: Use `h.startDate` directly (already YYYY-MM-DD - NEVER use toISOString per TECH-07)
    - `endDate`: Use `h.endDate` directly
    - `type`: Always `'School'`
    - `gradeLevel`: Extract from `h.comment?.find((c: any) => c.language === "BG")?.text` (optional)
  - Fallback: `import('@/data/school-holidays-${year}-fallback.json')`
  - Add console logging matching the pattern in fetch.ts
  - Deduplicate overlapping entries: if multiple entries have the same name and overlapping dates, merge them by taking the earliest startDate and latest endDate

  **getSchoolHolidayDates function:**
  ```typescript
  export function getSchoolHolidayDates(schoolHolidays: SchoolHoliday[]): Set<string>
  ```
  - Takes array of SchoolHoliday
  - For each school holiday, generate all individual dates between startDate and endDate using `eachDayOfInterval` from date-fns
  - Format each date as 'yyyy-MM-dd' using date-fns `format`
  - Return a Set<string> of all individual dates for O(1) calendar lookup
  - Use `parseISO` for parsing dates (Safari-safe, per TECH-07)

  **Create fallback JSON:**
  Create `data/school-holidays-2026-fallback.json` by fetching from the API. The file should contain an array of SchoolHoliday objects. If you cannot fetch live data, create a reasonable fallback based on typical Bulgarian school vacation schedule:
  - Междусрочна ваканция (February): ~2026-02-01 to 2026-02-04
  - Пролетна ваканция (April): ~2026-04-04 to 2026-04-13
  - Лятна ваканция (June-September): ~2026-06-15 to 2026-09-14
  - Коледна ваканция (December): ~2026-12-24 to 2027-01-04

  Fetch the actual data from the API to create an accurate fallback: `curl "https://openholidaysapi.org/SchoolHolidays?countryIsoCode=BG&validFrom=2026-01-01&validTo=2026-12-31"`
  </action>
  <verify>
  1. TypeScript compilation: `npx tsc --noEmit lib/holidays/schoolHolidays.ts`
  2. Fallback JSON is valid: `node -e "require('./data/school-holidays-2026-fallback.json')"`
  3. Verify getSchoolHolidayDates generates correct date sets (manual check or quick test)
  </verify>
  <done>
  - getSchoolHolidays fetches from OpenHolidays API with retry + fallback pattern
  - getSchoolHolidayDates converts date ranges to individual dates Set
  - Fallback JSON exists for 2026 school holidays
  - All date handling uses parseISO/format (Safari-safe)
  </done>
</task>

</tasks>

<verification>
1. `lib/holidays/types.ts` exports both `Holiday` and `SchoolHoliday` interfaces
2. `lib/holidays/schoolHolidays.ts` exports `getSchoolHolidays` and `getSchoolHolidayDates`
3. Fetch function follows same retry + fallback pattern as `getHolidays`
4. `data/school-holidays-2026-fallback.json` exists and is valid JSON
5. No use of `toISOString()` or `new Date(string)` for date-only values
6. TypeScript compilation passes
</verification>

<success_criteria>
- School holiday data can be fetched from OpenHolidays API
- Bulgarian names extracted from multilingual response
- Date ranges can be expanded to individual dates for calendar display
- Fallback JSON exists for offline/API-failure scenarios
- All existing holiday functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-seo-improvements-and-layout-restructuring/05.2-02-SUMMARY.md`
</output>
