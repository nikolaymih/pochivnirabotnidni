---
phase: 06-testing-and-quality-gates
plan: 06
type: execute
wave: 3
depends_on: ["06-01", "06-04", "06-05"]
files_modified:
  - package.json
autonomous: false

must_haves:
  truths:
    - "All tests pass (unit, integration, E2E)"
    - "Coverage is at least 50% for statements, branches, functions, and lines"
    - "No failing tests in Safari (webkit)"
  artifacts:
    - path: "coverage/index.html"
      provides: "HTML coverage report showing 50%+ coverage"
    - path: "playwright-report/index.html"
      provides: "E2E test report with webkit results"
  key_links:
    - from: "jest.config.js"
      to: "coverageThreshold.global"
      via: "Enforces 50% minimum coverage"
      pattern: "coverageThreshold"
---

<objective>
Verify all tests pass, coverage meets 50% threshold, and Safari validation is complete.

Purpose: Quality gate checkpoint before shipping — ensure meaningful test coverage and cross-browser validation.
Output: Coverage reports, test results, and human verification of Safari testing.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-testing-and-quality-gates/06-RESEARCH.md

# All test files created in previous plans
@lib/calendar/bridgeDays.test.ts
@lib/calendar/dates.test.ts
@lib/vacation/rollover.test.ts
@lib/avatar/initials.test.ts
@hooks/useLocalStorage.test.ts
@contexts/VacationContext.test.tsx
@e2e/calendar.spec.ts
@e2e/safari-dates.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Run full test suite and generate coverage report</name>
  <files>package.json</files>
  <action>
Run all Jest tests with coverage reporting:

```bash
npm test -- --coverage
```

This will:
1. Run all unit and integration tests (.test.ts, .test.tsx files)
2. Generate coverage report in coverage/ directory
3. Check against 50% threshold in jest.config.js
4. Exit with error code 1 if coverage is below threshold

Expected output:
```
PASS lib/calendar/bridgeDays.test.ts
PASS lib/calendar/dates.test.ts
PASS lib/vacation/rollover.test.ts
PASS lib/avatar/initials.test.ts
PASS hooks/useLocalStorage.test.ts
PASS contexts/VacationContext.test.tsx

----------|---------|----------|---------|---------|
File      | % Stmts | % Branch | % Funcs | % Lines |
----------|---------|----------|---------|---------|
All files |   50.00 |    50.00 |   50.00 |   50.00 |
----------|---------|----------|---------|---------|
```

If coverage is BELOW 50%, the command will fail. This is intentional — 50% is the quality gate.

Add npm script for convenience:
```json
"scripts": {
  "test": "jest",
  "test:coverage": "jest --coverage",
  "test:watch": "jest --watch"
}
```

Open coverage report in browser:
```bash
open coverage/index.html
```

Review coverage report to identify:
- Files with < 50% coverage (need more tests)
- Uncovered branches (missing error handling tests)
- Uncovered functions (unused code or missing tests)

WHY: Coverage threshold enforces quality gate. Below 50% = more tests needed.
  </action>
  <verify>npm run test:coverage && ls coverage/index.html</verify>
  <done>All Jest tests pass, coverage meets 50% threshold, HTML report generated</done>
</task>

<task type="auto">
  <name>Run Playwright E2E tests in all browsers</name>
  <files>package.json</files>
  <action>
Run all Playwright E2E tests across chromium and webkit:

```bash
npx playwright test
```

Expected output:
```
Running 8 tests using 2 workers

  ✓ [chromium] › calendar.spec.ts:6:3 › Full-year calendar › renders 12 months
  ✓ [chromium] › calendar.spec.ts:12:3 › Full-year calendar › marks date as vacation
  ✓ [webkit] › calendar.spec.ts:6:3 › Full-year calendar › renders 12 months
  ✓ [webkit] › calendar.spec.ts:12:3 › Full-year calendar › marks date as vacation
  ✓ [webkit] › safari-dates.spec.ts:6:3 › Safari date validation › Jan 1 holiday
  ✓ [webkit] › safari-dates.spec.ts:12:3 › Safari date validation › Dec 31 NOT Jan 1
  ✓ [webkit] › safari-dates.spec.ts:18:3 › Safari date validation › DST spring forward
  ✓ [webkit] › safari-dates.spec.ts:24:3 › Safari date validation › DST fall back

  8 passed (15s)
```

If any tests fail, review trace files:
```bash
npx playwright show-trace test-results/[failed-test]/trace.zip
```

Generate HTML report:
```bash
npx playwright show-report
```

Add npm scripts:
```json
"scripts": {
  "test:e2e": "playwright test",
  "test:e2e:ui": "playwright test --ui",
  "test:e2e:webkit": "playwright test --project=webkit"
}
```

Run Safari-only tests:
```bash
npm run test:e2e:webkit
```

WHY: Playwright webkit engine validates Safari-specific date handling. This prevents Phase 1.1-style bugs.
  </action>
  <verify>npx playwright test && ls playwright-report/index.html</verify>
  <done>All E2E tests pass in chromium and webkit, HTML report generated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete test suite with 50%+ coverage:
- 6 Jest test files (unit + integration)
- 2 Playwright E2E test suites (calendar + Safari validation)
- Coverage enforcement in jest.config.js
- Cross-browser validation (Chrome + Safari)
  </what-built>
  <how-to-verify>
**Step 1: Review Jest coverage report**
```bash
open coverage/index.html
```

Verify:
- [ ] Overall coverage is at least 50% (statements, branches, functions, lines)
- [ ] Date utilities (lib/calendar/dates.ts) have high coverage (Safari-critical)
- [ ] Rollover logic (lib/vacation/rollover.ts) has high coverage (Bulgarian law compliance)
- [ ] No files with 0% coverage (except intentionally excluded test files)

**Step 2: Review Playwright test report**
```bash
npx playwright show-report
```

Verify:
- [ ] All tests passed in chromium project
- [ ] All tests passed in webkit project (Safari validation)
- [ ] Safari-specific tests (safari-dates.spec.ts) only ran in webkit
- [ ] No flaky tests (all green, no retries needed)

**Step 3: Run tests yourself**
```bash
npm run test:coverage
npm run test:e2e
```

Verify:
- [ ] All tests pass locally
- [ ] Coverage threshold enforced (command fails if below 50%)
- [ ] No console errors or warnings during test runs

**Step 4: Manual Safari validation (optional but recommended)**
If you have access to real Safari:
```bash
npm run dev
# Open http://localhost:3000 in Safari
```

Verify:
- [ ] January 1st shows "Нова година" holiday
- [ ] December 31st does NOT show "Нова година"
- [ ] Date selection works (click to mark vacation)
- [ ] Year navigation works (historical years read-only)
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any test failures/coverage gaps found.
  </resume-signal>
</task>

</tasks>

<verification>
Final verification commands:
```bash
# All Jest tests with coverage
npm run test:coverage

# All E2E tests (chromium + webkit)
npm run test:e2e

# Safari-only E2E tests
npm run test:e2e:webkit

# Full test suite (Jest + Playwright)
npm run test:coverage && npm run test:e2e
```

Success criteria:
- Exit code 0 for all commands
- Coverage >= 50% for all metrics
- All E2E tests pass in webkit (Safari)
- No flaky tests (consistent pass on multiple runs)
</verification>

<success_criteria>
1. All Jest tests pass (unit + integration)
2. Coverage is at least 50% (enforced by jest.config.js)
3. All Playwright E2E tests pass in chromium and webkit
4. Safari-specific date tests validate Phase 1.1 regression prevention
5. Coverage report shows meaningful tests (no coverage theater)
6. Test suite completes in under 30 seconds (Jest + Playwright combined)
7. Human verification confirms Safari date handling works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-and-quality-gates/06-06-SUMMARY.md`
</output>
