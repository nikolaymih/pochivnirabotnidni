---
phase: 06-testing-and-quality-gates
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - playwright.config.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Playwright can run E2E tests in Safari (webkit), Chrome (chromium), and Firefox"
    - "Playwright configuration targets Next.js dev server at localhost:3000"
    - "Test artifacts (screenshots, traces) are gitignored"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with webkit for Safari testing"
      contains: "projects.*webkit"
    - path: "package.json"
      provides: "@playwright/test installed"
      contains: "@playwright/test"
  key_links:
    - from: "playwright.config.ts"
      to: "http://localhost:3000"
      via: "webServer.url configuration"
      pattern: "localhost:3000"
---

<objective>
Install and configure Playwright for E2E testing with Safari (webkit) support.

Purpose: Enable cross-browser testing for async Server Components and Safari-specific date validation.
Output: Playwright installed with configuration targeting Next.js app, ready for E2E tests in Plan 05.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-testing-and-quality-gates/06-RESEARCH.md

# Current dependencies
@package.json

# Current gitignore
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Install Playwright with browser binaries</name>
  <files>package.json</files>
  <action>
Install Playwright test framework:

```bash
npm install -D @playwright/test
npx playwright install
```

The second command downloads browser binaries for:
- Chromium (Chrome testing)
- Firefox (Firefox testing)
- WebKit (Safari testing) - CRITICAL for this project

Verify installation:
```bash
npx playwright --version
```

Should output Playwright version (e.g., "Version 1.48.0").

Verify browsers installed:
```bash
npx playwright install --dry-run
```

Should show chromium, firefox, webkit as available.

WHY: Playwright webkit engine is the only way to automate Safari testing without a real Mac Safari instance.
  </action>
  <verify>npx playwright --version && npm list @playwright/test --depth=0</verify>
  <done>@playwright/test installed in package.json, browser binaries downloaded</done>
</task>

<task type="auto">
  <name>Create Playwright configuration for Next.js</name>
  <files>playwright.config.ts</files>
  <action>
Create playwright.config.ts with Next.js-optimized settings:

```typescript
import { defineConfig, devices } from '@playwright/test';

/**
 * Playwright configuration for E2E testing
 * @see https://playwright.dev/docs/test-configuration
 */
export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000, // 2 minutes for Next.js to start
  },
});
```

Key configuration:
- **testDir: './e2e'** - E2E tests in e2e/ directory (separate from unit tests)
- **projects: chromium + webkit** - Chrome and Safari testing (skip Firefox for now)
- **webServer** - Automatically starts Next.js dev server before tests
- **baseURL** - Tests can use relative paths (e.g., await page.goto('/'))
- **trace: 'on-first-retry'** - Captures trace for debugging flaky tests
- **retries: 2 in CI** - Reduces flakiness in CI environment

WHY: Next.js App Router needs time to start. webServer config handles this automatically.
  </action>
  <verify>cat playwright.config.ts | grep -E "webkit|localhost:3000"</verify>
  <done>playwright.config.ts exists with webkit project and Next.js webServer configuration</done>
</task>

<task type="auto">
  <name>Update gitignore for Playwright artifacts</name>
  <files>.gitignore</files>
  <action>
Add Playwright-generated files to .gitignore to avoid committing test artifacts.

Append to .gitignore:
```
# Playwright
test-results/
playwright-report/
playwright/.cache/
```

Explanation:
- **test-results/** - Screenshots, videos, traces from failed tests
- **playwright-report/** - HTML test report generated after run
- **playwright/.cache/** - Browser binary cache

WHY: Test artifacts are large and machine-specific. Should not be in git.
  </action>
  <verify>grep -E "test-results|playwright-report" .gitignore</verify>
  <done>Playwright artifact directories added to .gitignore</done>
</task>

</tasks>

<verification>
Verify Playwright setup is working:
```bash
# Create a minimal test to verify config
mkdir -p e2e
cat > e2e/setup-check.spec.ts << 'EOF'
import { test, expect } from '@playwright/test';

test('setup check: can reach Next.js app', async ({ page }) => {
  await page.goto('/');
  await expect(page).toHaveTitle(/Pochivni/);
});
EOF

# Run the test
npx playwright test setup-check.spec.ts

# Clean up
rm e2e/setup-check.spec.ts
```

Expected: Test passes in both chromium and webkit projects.
</verification>

<success_criteria>
1. @playwright/test installed in package.json
2. Browser binaries downloaded (chromium, webkit)
3. playwright.config.ts exists with webkit project
4. Configuration points to localhost:3000
5. .gitignore updated with Playwright artifact directories
6. Playwright can start Next.js dev server and run a basic test
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-and-quality-gates/06-03-SUMMARY.md`
</output>
