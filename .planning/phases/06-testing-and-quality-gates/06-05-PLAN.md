---
phase: 06-testing-and-quality-gates
plan: 05
type: execute
wave: 2
depends_on: ["06-03"]
files_modified:
  - e2e/calendar.spec.ts
  - e2e/safari-dates.spec.ts
autonomous: true

must_haves:
  truths:
    - "Full-year calendar renders all 12 months with holidays displayed"
    - "Vacation marking interaction works (click dates, see summary update)"
    - "Safari correctly displays holidays without timezone shift bugs"
  artifacts:
    - path: "e2e/calendar.spec.ts"
      provides: "E2E tests for calendar rendering and vacation interaction"
      min_lines: 80
    - path: "e2e/safari-dates.spec.ts"
      provides: "Safari-specific date validation tests"
      min_lines: 50
  key_links:
    - from: "e2e/calendar.spec.ts"
      to: "http://localhost:3000"
      via: "Playwright page.goto"
      pattern: "page\\.goto"
    - from: "e2e/safari-dates.spec.ts"
      to: "browserName === 'webkit'"
      via: "Safari-specific test skip"
      pattern: "test\\.skip.*webkit"
---

<objective>
Create E2E tests for critical user flows and Safari-specific date validation.

Purpose: Verify async Server Components render correctly and Safari date handling works without timezone bugs.
Output: Two Playwright test suites covering calendar rendering, vacation interaction, and Safari date edge cases.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-testing-and-quality-gates/06-RESEARCH.md

# Playwright config created in Plan 03
@playwright.config.ts

# Testing patterns from research
Pattern 4: Testing Async Server Components (E2E Only)
Pattern 5: Safari cross-browser validation
</context>

<tasks>

<task type="auto">
  <name>Create calendar E2E test suite</name>
  <files>e2e/calendar.spec.ts</files>
  <action>
Create E2E test suite for full-year calendar rendering and vacation interaction flows.

Test coverage requirements:
1. **Calendar rendering (async Server Component)**
   - Page loads without errors
   - All 12 months rendered with data-testid="month-grid"
   - Month headers display Bulgarian month names (Януари, Февруари, ...)
   - Current date has visual indicator (border or highlight)

2. **Holiday display**
   - January 1st (Нова година) displays with holiday styling
   - Holiday cells have bg-cinnamon background and text-white text
   - Desktop: tooltip appears on hover showing holiday name
   - Tooltips contain holiday name in Bulgarian

3. **Vacation marking interaction**
   - Click on non-holiday date marks it as vacation (blue/vacation styling)
   - VacationSummary updates "Използвани" count after marking
   - Click again removes vacation marking (toggle behavior)
   - Drag selection works (pointer down -> move -> pointer up)

4. **Year navigation**
   - Year selector shows current year (2026)
   - Click left arrow navigates to 2025
   - Click right arrow navigates to 2027
   - Historical years show vacation data in read-only mode (no click handlers)

Example test structure:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Full-year calendar', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('renders 12 months', async ({ page }) => {
    // Wait for async Server Component to render
    await page.waitForSelector('[data-testid="month-grid"]');

    const monthGrids = await page.locator('[data-testid="month-grid"]').count();
    expect(monthGrids).toBe(12);
  });

  test('marks date as vacation on click', async ({ page }) => {
    // Wait for calendar
    await page.waitForSelector('[data-testid="month-grid"]');

    // Click a date (e.g., March 15)
    await page.click('[data-date="2026-03-15"]');

    // Verify vacation styling applied
    const cell = page.locator('[data-date="2026-03-15"]');
    await expect(cell).toHaveClass(/vacation/);

    // Verify summary updated
    const used = page.locator('text=/Използвани: \\d+/');
    await expect(used).toContainText('1');
  });

  test('holiday tooltips show on hover (desktop only)', async ({ page, isMobile }) => {
    test.skip(isMobile, 'Tooltips are desktop-only');

    await page.waitForSelector('[data-date="2026-01-01"]');

    // Hover over holiday
    await page.hover('[data-date="2026-01-01"]');

    // Verify tooltip appears
    await expect(page.locator('text=/Нова година/')).toBeVisible();
  });
});
```

Add data-testid attributes to components if missing:
- MonthGrid: `<div data-testid="month-grid">`
- Date cells: `<div data-date="YYYY-MM-DD">`

WHY: Jest can't test async Server Components. E2E is the only way to verify FullYearCalendar rendering.
  </action>
  <verify>npx playwright test calendar.spec.ts</verify>
  <done>Calendar E2E tests pass in chromium and webkit, covering rendering and interaction</done>
</task>

<task type="auto">
  <name>Create Safari date validation test suite</name>
  <files>e2e/safari-dates.spec.ts</files>
  <action>
Create Safari-specific E2E tests for date parsing and timezone edge cases.

Test coverage requirements:
1. **Phase 1.1 regression prevention**
   - December 31st does NOT show as "Нова година" (Jan 1 holiday)
   - January 1st DOES show as "Нова година"
   - No timezone shift causes holidays to appear on wrong dates

2. **DST boundary dates (Bulgaria)**
   - Spring forward: March 30, 2026 (last Sunday in March)
   - Fall back: October 25, 2026 (last Sunday in October)
   - Dates display correctly without day shift

3. **Year boundary handling**
   - Last week of December (2026-12-28 to 2026-12-31)
   - First week of January (2027-01-01 to 2027-01-05)
   - Bridge days span year boundaries correctly

4. **Safari-only validation**
   - All tests skip unless browserName === 'webkit'
   - Use test.skip() to prevent running in Chromium

Example test structure:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Safari date validation', () => {
  test.beforeEach(async ({ page, browserName }) => {
    test.skip(browserName !== 'webkit', 'Safari-specific tests');
    await page.goto('/');
  });

  test('Jan 1 holiday displays on correct date', async ({ page }) => {
    await page.waitForSelector('[data-date="2026-01-01"]');

    // Verify Jan 1 has holiday styling
    const jan1 = page.locator('[data-date="2026-01-01"]');
    await expect(jan1).toHaveAttribute('data-holiday', 'true');

    // Hover to see tooltip (desktop)
    await page.hover('[data-date="2026-01-01"]');
    await expect(page.locator('text=/Нова година/')).toBeVisible();
  });

  test('Dec 31 does NOT show as Jan 1 holiday', async ({ page }) => {
    await page.waitForSelector('[data-date="2026-12-31"]');

    // Verify Dec 31 does NOT have Jan 1 holiday
    const dec31 = page.locator('[data-date="2026-12-31"]');
    await expect(dec31).not.toHaveAttribute('data-holiday', 'true');

    // Hover should NOT show "Нова година"
    await page.hover('[data-date="2026-12-31"]');
    await expect(page.locator('text=/Нова година/')).not.toBeVisible();
  });

  test('DST spring forward: March 30, 2026', async ({ page }) => {
    await page.waitForSelector('[data-date="2026-03-30"]');

    // Verify March 30 displays correctly (last Sunday in March)
    const march30 = page.locator('[data-date="2026-03-30"]');
    await expect(march30).toBeVisible();

    // Verify it's in March column, not April
    const marchGrid = page.locator('[data-testid="month-grid"]').nth(2); // March (0-indexed)
    await expect(marchGrid.locator('[data-date="2026-03-30"]')).toBeVisible();
  });

  test('DST fall back: October 25, 2026', async ({ page }) => {
    await page.waitForSelector('[data-date="2026-10-25"]');

    // Verify October 25 displays correctly (last Sunday in October)
    const oct25 = page.locator('[data-date="2026-10-25"]');
    await expect(oct25).toBeVisible();

    // Verify it's in October column, not November
    const octGrid = page.locator('[data-testid="month-grid"]').nth(9); // October (0-indexed)
    await expect(octGrid.locator('[data-date="2026-10-25"]')).toBeVisible();
  });
});
```

WHY: Phase 1.1 bug showed Safari parses dates differently than Chrome. These tests prevent regression.
  </action>
  <verify>npx playwright test safari-dates.spec.ts --project=webkit</verify>
  <done>Safari date tests pass in webkit project, covering timezone and DST edge cases</done>
</task>

</tasks>

<verification>
Run all E2E tests across browsers:
```bash
npx playwright test
```

Should run in both chromium and webkit projects.

Run Safari-specific tests only:
```bash
npx playwright test safari-dates.spec.ts --project=webkit
```

Generate HTML report:
```bash
npx playwright show-report
```

Verify test traces captured on failure (check test-results/ directory after a failing test).
</verification>

<success_criteria>
1. Calendar E2E tests pass in chromium and webkit
2. Safari date tests pass in webkit project only
3. Tests verify async Server Component rendering (FullYearCalendar)
4. Holiday tooltips tested (desktop only)
5. Vacation marking interaction verified
6. DST boundary dates validated in Safari
7. Phase 1.1 regression test (Dec 31 vs Jan 1) included
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-and-quality-gates/06-05-SUMMARY.md`
</output>
