---
phase: 06-testing-and-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/calendar/dates.test.ts
  - lib/vacation/rollover.test.ts
  - lib/avatar/initials.test.ts
autonomous: true

must_haves:
  truths:
    - "Date parsing functions handle Safari-critical edge cases (DST, timezone-free ISO strings)"
    - "Rollover calculation correctly implements 2-year expiration per Bulgarian labor law"
    - "Avatar initials generation follows Google pattern for all input variations"
  artifacts:
    - path: "lib/calendar/dates.test.ts"
      provides: "Date utility tests covering parseISO, serializeDate, getCurrentDate"
      min_lines: 80
    - path: "lib/vacation/rollover.test.ts"
      provides: "Rollover calculation tests with expiry logic and Bulgarian law compliance"
      min_lines: 100
    - path: "lib/avatar/initials.test.ts"
      provides: "Initials extraction tests covering name parsing and fallback cases"
      min_lines: 50
  key_links:
    - from: "lib/calendar/dates.test.ts"
      to: "lib/calendar/dates.ts"
      via: "import { parseDate, serializeDate, getCurrentDate }"
      pattern: "import.*from.*dates"
    - from: "lib/vacation/rollover.test.ts"
      to: "lib/vacation/rollover.ts"
      via: "import { calculateRollover }"
      pattern: "import.*calculateRollover"
---

<objective>
Create unit tests for pure functions in lib/ directory covering date utilities, rollover calculations, and avatar initials generation.

Purpose: Establish foundation of meaningful tests for Safari-critical date handling and Bulgarian labor law compliance logic.
Output: Three test files with comprehensive coverage of edge cases and business logic.
</objective>

<execution_context>
@/home/nikolaymih11/.claude/get-shit-done/workflows/execute-plan.md
@/home/nikolaymih11/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-testing-and-quality-gates/06-RESEARCH.md

# Existing test pattern
@lib/calendar/bridgeDays.test.ts

# Code under test
@lib/calendar/dates.ts
@lib/vacation/rollover.ts
@lib/avatar/initials.ts
</context>

<tasks>

<task type="auto">
  <name>Create date utilities test suite</name>
  <files>lib/calendar/dates.test.ts</files>
  <action>
Create comprehensive test suite for lib/calendar/dates.ts following the established pattern from bridgeDays.test.ts.

Test coverage requirements:
1. **parseDate()** - Test Safari-safe date parsing with parseISO
   - Valid ISO strings (YYYY-MM-DD format)
   - Leap year dates (2024-02-29, 2026-02-28)
   - DST boundary dates for Bulgaria (last Sunday in March/October)
     - Spring forward: 2026-03-30 (3:00 AM -> 4:00 AM)
     - Fall back: 2026-10-25 (4:00 AM -> 3:00 AM)
   - Year boundary dates (2026-01-01, 2026-12-31)
   - Invalid date strings should be handled gracefully

2. **serializeDate()** - Test Date-to-string conversion without timezone shift
   - Standard dates
   - Dates during DST transitions (no timezone shift expected)
   - Verify output format is always YYYY-MM-DD
   - Test that serialization is inverse of parsing (parseDate(serializeDate(date)) === date)

3. **getCurrentDate()** - Test startOfDay normalization
   - Returns date with time set to 00:00:00
   - Consistent across timezone contexts
   - Use jest.useFakeTimers() to test specific dates

Import pattern:
```typescript
import { describe, test, expect, beforeEach, afterEach } from '@jest/globals';
import { parseDate, serializeDate, getCurrentDate } from '@/lib/calendar/dates';
```

Use jest.useFakeTimers() and jest.setSystemTime() for testing getCurrentDate() with specific dates. Clean up with jest.useRealTimers() in afterEach.

WHY: Date handling is Safari-critical (Phase 1.1 bug). These tests prevent timezone regression bugs.
  </action>
  <verify>npm test -- dates.test.ts</verify>
  <done>All date utility tests pass, covering DST edge cases and Safari-specific parsing requirements</done>
</task>

<task type="auto">
  <name>Create rollover calculation test suite</name>
  <files>lib/vacation/rollover.test.ts</files>
  <action>
Create test suite for lib/vacation/rollover.ts testing Bulgarian labor law 2-year expiration logic.

Test coverage requirements:
1. **calculateRollover()** - Mock Supabase client to test rollover logic
   - Returns null when no previous year data exists
   - Returns null when previous year has zero unused days
   - Calculates unused days correctly (totalDays - vacationDates.length)
   - Fetches up to 2 previous years (2024 and 2025 when viewing 2026)
   - Handles missing data for one of the two previous years

2. **CarryoverBucket expiry logic**
   - Bucket from 2024 is NOT expired when viewing 2026 (expires 2026-12-31)
   - Bucket from 2024 IS expired when viewing 2027 (after 2026-12-31)
   - Bucket from 2023 IS expired when viewing 2026 (expires 2025-12-31, already past)
   - Use jest.setSystemTime() to control "today" for expiry checks

3. **RolloverResult.totalRollover calculation**
   - Sums only non-expired buckets
   - Excludes expired buckets from total
   - Multiple buckets: some expired, some active

4. **Edge cases**
   - Sequential year fetch handles errors gracefully
   - Empty vacation dates array (all days unused)
   - Partial year data (user started mid-year)

Mock Supabase pattern from research:
```typescript
jest.mock('@/lib/supabase/client', () => ({
  createClient: () => ({
    from: jest.fn(() => ({
      select: jest.fn().mockReturnThis(),
      eq: jest.fn().mockReturnThis(),
      single: jest.fn().mockResolvedValue({
        data: { totalDays: 20, vacationDates: ['2024-03-15'] }
      })
    }))
  })
}));
```

WHY: Rollover logic implements Bulgarian –ö–æ–¥–µ–∫—Å –Ω–∞ —Ç—Ä—É–¥–∞ (2-year carryover limit). Must be legally compliant.
  </action>
  <verify>npm test -- rollover.test.ts</verify>
  <done>Rollover tests pass, covering 2-year expiration logic and Bulgarian labor law compliance</done>
</task>

<task type="auto">
  <name>Create avatar initials test suite</name>
  <files>lib/avatar/initials.test.ts</files>
  <action>
Create test suite for lib/avatar/initials.ts following Google's avatar pattern.

Test coverage requirements:
1. **getInitials()** - Test name parsing and initials extraction
   - First + Last name: "–ù–∏–∫–æ–ª–∞–π –ú–∏—Ö–æ–≤" ‚Üí "–ù–ú"
   - Single name: "–ù–∏–∫–æ–ª–∞–π" ‚Üí "–ù"
   - Three names: "–ù–∏–∫–æ–ª–∞–π –ü–µ—Ç—Ä–æ–≤ –ú–∏—Ö–æ–≤" ‚Üí "–ù–ú" (first + last)
   - Empty string: "" ‚Üí "?" (fallback)
   - Whitespace only: "   " ‚Üí "?" (fallback)
   - Multiple spaces: "–ù–∏–∫–æ–ª–∞–π   –ú–∏—Ö–æ–≤" ‚Üí "–ù–ú"
   - Leading/trailing spaces: " –ù–∏–∫–æ–ª–∞–π –ú–∏—Ö–æ–≤ " ‚Üí "–ù–ú"

2. **Email fallback pattern**
   - No name provided, email available: "test@example.com" ‚Üí "T"
   - Email with dots: "first.last@example.com" ‚Üí "F"
   - Email with numbers: "user123@example.com" ‚Üí "U"

3. **Cyrillic character handling**
   - Bulgarian names with special characters: "–¶–≤–µ—Ç–∞–Ω –¶–≤–µ—Ç–∞–Ω–æ–≤" ‚Üí "–¶–¶"
   - Mixed Cyrillic and Latin: "John –ò–≤–∞–Ω–æ–≤" ‚Üí "JI"
   - Lowercase conversion: "–Ω–∏–∫–æ–ª–∞–π –º–∏—Ö–æ–≤" ‚Üí "–ù–ú"

4. **Edge cases**
   - Null/undefined input handling
   - Non-letter characters in names: "123 456" ‚Üí "?"
   - Emoji or special unicode: "üòÄ Test" ‚Üí handle gracefully

Import pattern:
```typescript
import { describe, test, expect } from '@jest/globals';
import { getInitials } from '@/lib/avatar/initials';
```

WHY: Avatar display is part of auth UI. Must handle Bulgarian Cyrillic names correctly.
  </action>
  <verify>npm test -- initials.test.ts</verify>
  <done>Avatar initials tests pass, covering Cyrillic names and fallback patterns</done>
</task>

</tasks>

<verification>
Run all new tests together:
```bash
npm test -- "dates.test|rollover.test|initials.test"
```

Verify test files follow established pattern from bridgeDays.test.ts:
- Use @jest/globals imports
- Use describe/test/expect structure
- Test edge cases and error paths
- Include cleanup in afterEach when using timers
</verification>

<success_criteria>
1. All three test files exist and pass
2. Date tests cover DST boundaries and Safari-specific parsing
3. Rollover tests verify 2-year expiration per Bulgarian law
4. Initials tests handle Cyrillic names correctly
5. Tests run in under 5 seconds total
6. No test pollution (each test cleans up after itself)
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-and-quality-gates/06-01-SUMMARY.md`
</output>
