---
phase: 01-foundation-static-holiday-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - lib/holidays/types.ts
  - lib/holidays/fetch.ts
  - data/holidays-2026-fallback.json
  - lib/
  - data/
autonomous: true

must_haves:
  truths:
    - "Application has date-fns library available for all date operations"
    - "Bulgarian 2026 holiday data exists as static fallback"
    - "Holiday fetch function handles API failures gracefully"
  artifacts:
    - path: "package.json"
      provides: "date-fns dependency"
      contains: "date-fns"
    - path: "data/holidays-2026-fallback.json"
      provides: "Static fallback holiday data for 2026"
      min_lines: 10
    - path: "lib/holidays/types.ts"
      provides: "Holiday data type definitions"
      exports: ["Holiday", "HolidayType"]
    - path: "lib/holidays/fetch.ts"
      provides: "Holiday data fetching with multi-layer fallback"
      exports: ["getHolidays"]
  key_links:
    - from: "lib/holidays/fetch.ts"
      to: "OpenHolidays API"
      via: "fetch with 24hr cache"
      pattern: "fetch.*openholidaysapi\\.org"
    - from: "lib/holidays/fetch.ts"
      to: "data/holidays-2026-fallback.json"
      via: "static import fallback"
      pattern: "import.*holidays-.*-fallback\\.json"
    - from: "lib/holidays/fetch.ts"
      to: "date-fns parseISO"
      via: "Safari-safe date parsing"
      pattern: "parseISO\\(h\\.startDate\\)"
---

<objective>
Establish the foundation for holiday data management with Safari-safe date handling and multi-layer fallback architecture.

Purpose: Create a reliable holiday data layer that works even when external API fails, using date-fns for cross-browser compatibility (especially Safari). This prevents the calendar from breaking due to API downtime or Safari's strict date parsing.

Output: Installed dependencies, typed holiday data structures, fetch function with API→static fallback, and complete 2026 Bulgarian holiday dataset.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-static-holiday-view/01-CONTEXT.md
@.planning/phases/01-foundation-static-holiday-view/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns dependency and create directory structure</name>
  <files>package.json, package-lock.json, lib/, data/</files>
  <action>
Install date-fns v4.x using npm and create required directories:

```bash
npm install date-fns
mkdir -p lib/holidays data
```

Do NOT install moment.js, dayjs, or any other date library. date-fns is mandatory per CONVENTIONS.md research-locked constraints.

Verify installation by checking package.json contains "date-fns" in dependencies.
  </action>
  <verify>
```bash
grep -q "date-fns" package.json && echo "✓ date-fns installed"
npm list date-fns
test -d lib && echo "✓ lib/ directory exists"
test -d data && echo "✓ data/ directory exists"
```
  </verify>
  <done>package.json contains date-fns in dependencies, package-lock.json updated, lib/ and data/ directories created</done>
</task>

<task type="auto">
  <name>Task 2: Create holiday data layer with multi-layer fallback</name>
  <files>lib/holidays/types.ts, lib/holidays/fetch.ts, data/holidays-2026-fallback.json</files>
  <action>
Create the holiday data layer following the research pattern for Server Component data fetching with multi-layer cache.

**File: lib/holidays/types.ts**
```typescript
export interface Holiday {
  name: string;
  date: string; // ISO date string (YYYY-MM-DD) per TECH-07
  type: HolidayType;
}

export type HolidayType = 'Public Holiday' | 'National Holiday' | 'Observance';
```

**File: data/holidays-2026-fallback.json**
Create static fallback with ALL 2026 Bulgarian public holidays (verified dates):
- New Year's Day: 2026-01-01
- Liberation Day: 2026-03-03
- Good Friday: 2026-04-17 (movable, Orthodox Easter 2026)
- Holy Saturday: 2026-04-18
- Easter Sunday: 2026-04-19
- Easter Monday: 2026-04-20
- Labour Day: 2026-05-01
- St. George's Day: 2026-05-06
- Education and Culture Day: 2026-05-24
- Unification Day: 2026-09-06
- Independence Day: 2026-09-22
- Christmas Eve: 2026-12-24
- Christmas Day: 2026-12-25
- Second Day of Christmas: 2026-12-26

Format as JSON array of Holiday objects with ISO date strings.

**File: lib/holidays/fetch.ts**
```typescript
import { parseISO } from 'date-fns';
import type { Holiday } from './types';

export async function getHolidays(year: number): Promise<Holiday[]> {
  // Layer 1: Try OpenHolidays API
  try {
    const response = await fetch(
      `https://openholidaysapi.org/PublicHolidays?countryIsoCode=BG&validFrom=${year}-01-01&validTo=${year}-12-31`,
      { next: { revalidate: 86400 } } // 24hr cache per research
    );

    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }

    const data = await response.json();

    // Parse dates safely for Safari using parseISO
    const holidays: Holiday[] = data.map((h: any) => ({
      name: h.name?.[0]?.text || h.name,
      date: parseISO(h.startDate).toISOString().split('T')[0], // Parse THEN serialize to YYYY-MM-DD
      type: h.type || 'Public Holiday'
    }));

    return holidays;
  } catch (error) {
    console.warn(`Failed to fetch holidays from API: ${error}`);

    // Layer 2: Static fallback
    const fallback = await import(`@/data/holidays-${year}-fallback.json`);
    return fallback.default;
  }
}
```

CRITICAL: Use parseISO() for Safari-safe date parsing. The API returns ISO strings, but we parse them through parseISO() then serialize back to ensure Safari compatibility. Store dates as ISO strings (YYYY-MM-DD) without time component per TECH-07.

Do NOT use new Date(string) - Safari parses it differently than Chrome, causing timezone bugs.
  </action>
  <verify>
```bash
# Check files exist
test -f lib/holidays/types.ts && echo "✓ types.ts exists"
test -f lib/holidays/fetch.ts && echo "✓ fetch.ts exists"
test -f data/holidays-2026-fallback.json && echo "✓ fallback data exists"

# Verify parseISO usage (Safari-safe) - must actually call parseISO
grep -q "parseISO(h\.startDate)" lib/holidays/fetch.ts && echo "✓ Using parseISO for Safari compatibility"

# Verify NO unsafe Date constructor
! grep -q "new Date(.*['\"]" lib/holidays/fetch.ts && echo "✓ No unsafe Date(string) usage"

# Verify fallback has all holidays - use Node instead of jq
node -e "const h = require('./data/holidays-2026-fallback.json'); console.log(h.length >= 10 ? '✓ Fallback has 10+ holidays' : 'FAIL: Only ' + h.length + ' holidays')"

# Build check
npm run build
```
  </verify>
  <done>
Holiday types defined, fetch function implements API→fallback strategy with Safari-safe date parsing using parseISO(), 2026 Bulgarian holidays stored as static JSON, Next.js build succeeds
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Dependency Check**: `npm list date-fns` shows v4.x installed
2. **Directory Structure**: lib/ and data/ directories exist
3. **Type Safety**: TypeScript compiles without errors for holiday types
4. **Fallback Data Integrity**: JSON file contains valid Holiday objects with ISO date strings
5. **Safari Compatibility**: parseISO() actually called on h.startDate before storing
6. **Build Success**: `npm run build` completes without errors
</verification>

<success_criteria>
Phase 01, Plan 01 is complete when:

- [x] date-fns library installed (package.json updated)
- [x] lib/ and data/ directories created
- [x] Holiday and HolidayType types exported from lib/holidays/types.ts
- [x] getHolidays() function exists in lib/holidays/fetch.ts
- [x] getHolidays() tries API first, falls back to static JSON
- [x] All date parsing uses parseISO() - actually called on h.startDate
- [x] data/holidays-2026-fallback.json contains 10+ Bulgarian holidays
- [x] All dates stored as ISO strings (YYYY-MM-DD format)
- [x] Next.js build completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-static-holiday-view/01-01-SUMMARY.md`
</output>
