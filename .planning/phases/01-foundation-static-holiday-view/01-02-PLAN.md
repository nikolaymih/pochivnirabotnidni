---
phase: 01-foundation-static-holiday-view
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - lib/calendar/grid.ts
  - lib/calendar/dates.ts
  - components/Calendar.tsx
  - components/CalendarDay.tsx
  - components/Legend.tsx
  - components/
autonomous: true

must_haves:
  truths:
    - "Calendar grid positions first day correctly for Monday-first weeks"
    - "Calendar displays 7 columns with Mon-Sun headers"
    - "Weekends have subtle gray background"
    - "Current date has visible border indicator"
    - "Holiday days show red background"
    - "Legend explains red color meaning"
  artifacts:
    - path: "lib/calendar/grid.ts"
      provides: "Calendar grid calculations"
      exports: ["getCalendarGrid"]
      min_lines: 15
    - path: "lib/calendar/dates.ts"
      provides: "Safe date operations wrapper"
      exports: ["parseDate", "serializeDate", "getCurrentDate"]
      min_lines: 15
    - path: "components/Calendar.tsx"
      provides: "Server Component calendar grid"
      min_lines: 40
    - path: "components/CalendarDay.tsx"
      provides: "Server Component day cell"
      min_lines: 25
    - path: "components/Legend.tsx"
      provides: "Server Component color legend"
      min_lines: 15
  key_links:
    - from: "components/Calendar.tsx"
      to: "lib/calendar/grid.ts"
      via: "getCalendarGrid function call"
      pattern: "getCalendarGrid"
    - from: "components/Calendar.tsx"
      to: "date-fns"
      via: "date formatting and comparisons"
      pattern: "from 'date-fns'"
    - from: "components/Calendar.tsx"
      to: "lib/calendar/dates.ts"
      via: "getCurrentDate for Safari-safe today"
      pattern: "getCurrentDate"
    - from: "components/CalendarDay.tsx"
      to: "Holiday type"
      via: "holiday prop typing"
      pattern: "Holiday"
---

<objective>
Build the custom calendar grid with Server Components, implementing Monday-first week layout, proper day positioning, and holiday visualization with Safari-safe current date calculation.

Purpose: Create the visual foundation of the calendar using CSS Grid with correct Bulgarian week conventions (Monday start), weekend styling, current date indicator, and red holiday backgrounds. Server Components ensure fast initial load and leverage Next.js caching. Safari-safe date handling prevents timezone bugs when determining "today".

Output: Reusable calendar utilities with safe getCurrentDate(), server-rendered calendar grid component, individual day cells with conditional styling, and color legend.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-static-holiday-view/01-CONTEXT.md
@.planning/phases/01-foundation-static-holiday-view/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

# Reference prior plan output
@.planning/phases/01-foundation-static-holiday-view/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calendar utilities with Monday-first week logic and Safari-safe date handling</name>
  <files>lib/calendar/grid.ts, lib/calendar/dates.ts, components/</files>
  <action>
Create calendar calculation utilities following the research pattern for CSS Grid with Monday-first weeks and Safari-safe current date calculation.

**First, create components directory:**
```bash
mkdir -p components
```

**File: lib/calendar/dates.ts**
```typescript
import { parseISO, format, startOfDay } from 'date-fns';

/**
 * Parse ISO date string safely for Safari compatibility.
 * NEVER use new Date(string) - Safari parses differently than Chrome.
 */
export function parseDate(isoString: string): Date {
  return parseISO(isoString);
}

/**
 * Serialize date to ISO string for storage (YYYY-MM-DD).
 * Per TECH-07: store dates as ISO strings, not timestamps.
 */
export function serializeDate(date: Date): string {
  return format(date, 'yyyy-MM-dd');
}

/**
 * Get current date safely for cross-browser compatibility.
 * Uses startOfDay to normalize timezone handling per research findings.
 *
 * CRITICAL: new Date() is timezone-sensitive and causes Safari bugs.
 * startOfDay ensures consistent "today" across browsers.
 */
export function getCurrentDate(): Date {
  return startOfDay(new Date());
}
```

**File: lib/calendar/grid.ts**
```typescript
import { startOfMonth, getDay, getDaysInMonth } from 'date-fns';

export interface CalendarGrid {
  firstDayOfWeek: number; // 0-6, Monday=0, Sunday=6
  daysInMonth: number;
  days: number[];
}

/**
 * Calculate calendar grid for a given month.
 * Uses Monday-first week (ISO 8601, Bulgarian standard).
 *
 * @param year - Full year (e.g., 2026)
 * @param month - Month index 0-11 (0=January)
 * @returns Grid data for rendering
 */
export function getCalendarGrid(year: number, month: number): CalendarGrid {
  const firstDay = startOfMonth(new Date(year, month, 1));
  const daysInMonth = getDaysInMonth(firstDay);

  // getDay() returns 0=Sunday, 6=Saturday
  // Convert to Monday-first: 0=Monday, 6=Sunday
  let firstDayOfWeek = getDay(firstDay);
  firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  return {
    firstDayOfWeek,
    daysInMonth,
    days
  };
}
```

CRITICAL: Monday-first week conversion is mandatory. getDay() returns 0 for Sunday, but Bulgarian standard (ISO 8601) starts weeks on Monday. The conversion `firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1` is essential.

CRITICAL: getCurrentDate() uses startOfDay() to avoid Safari timezone bugs per research TECH-07.
  </action>
  <verify>
```bash
# Check directory and files exist
test -d components && echo "✓ components/ directory exists"
test -f lib/calendar/grid.ts && echo "✓ grid.ts exists"
test -f lib/calendar/dates.ts && echo "✓ dates.ts exists"

# Verify date-fns usage
grep -q "from 'date-fns'" lib/calendar/grid.ts && echo "✓ Using date-fns"
grep -q "parseISO" lib/calendar/dates.ts && echo "✓ Safari-safe parseISO"

# Verify getCurrentDate with startOfDay
grep -q "getCurrentDate" lib/calendar/dates.ts && echo "✓ getCurrentDate function exists"
grep -q "startOfDay" lib/calendar/dates.ts && echo "✓ Using startOfDay for Safari safety"

# Verify Monday-first conversion logic
grep -q "firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1" lib/calendar/grid.ts && echo "✓ Monday-first conversion present"

# Build check
npm run build
```
  </verify>
  <done>
components/ directory created, calendar grid calculations handle Monday-first weeks correctly, date utilities use parseISO for Safari safety, getCurrentDate() uses startOfDay() to avoid timezone bugs, TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Server Component calendar UI with holiday styling and Safari-safe today</name>
  <files>components/Calendar.tsx, components/CalendarDay.tsx, components/Legend.tsx</files>
  <action>
Create calendar UI components as Server Components (default) with proper styling per context decisions and Safari-safe current date handling.

**File: components/Calendar.tsx**
```typescript
import { format, isSameDay } from 'date-fns';
import { getCalendarGrid } from '@/lib/calendar/grid';
import { parseDate, getCurrentDate } from '@/lib/calendar/dates';
import type { Holiday } from '@/lib/holidays/types';
import CalendarDay from './CalendarDay';

interface CalendarProps {
  year: number;
  month: number; // 0-11
  holidays: Holiday[];
}

export default function Calendar({ year, month, holidays }: CalendarProps) {
  const { firstDayOfWeek, days } = getCalendarGrid(year, month);
  const firstDay = new Date(year, month, 1);
  const today = getCurrentDate(); // Safari-safe current date

  return (
    <div className="border rounded-lg p-4">
      <h2 className="text-xl font-semibold mb-4">
        {format(firstDay, 'MMMM yyyy')}
      </h2>

      {/* Grid: 7 columns for Mon-Sun */}
      <div className="grid grid-cols-7 gap-1">
        {/* Day headers - Monday first per context decision */}
        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => (
          <div key={day} className="text-center font-medium text-sm py-2">
            {day}
          </div>
        ))}

        {/* Day cells */}
        {days.map((day, index) => {
          const date = new Date(year, month, day);
          const holiday = holidays.find(h => isSameDay(parseDate(h.date), date));

          // Calculate if weekend: indices 5,6 in Monday-first week = Sat,Sun
          const dayOfWeek = (firstDayOfWeek + index) % 7;
          const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
          const isToday = isSameDay(date, today);

          return (
            <CalendarDay
              key={day}
              day={day}
              isToday={isToday}
              isWeekend={isWeekend}
              holiday={holiday}
              gridColumnStart={index === 0 ? firstDayOfWeek + 1 : undefined}
            />
          );
        })}
      </div>
    </div>
  );
}
```

**File: components/CalendarDay.tsx**
```typescript
import type { Holiday } from '@/lib/holidays/types';

interface CalendarDayProps {
  day: number;
  isToday: boolean;
  isWeekend: boolean;
  holiday?: Holiday;
  gridColumnStart?: number;
}

export default function CalendarDay({
  day,
  isToday,
  isWeekend,
  holiday,
  gridColumnStart
}: CalendarDayProps) {
  return (
    <div
      style={gridColumnStart ? { gridColumnStart } : undefined}
      className={`
        relative p-3 text-center border rounded min-h-[3rem]
        ${holiday ? 'bg-red-500 text-white' : ''}
        ${isWeekend && !holiday ? 'bg-gray-100' : ''}
        ${isToday ? 'ring-2 ring-blue-500' : ''}
      `}
    >
      <span className="font-medium">{day}</span>
      {/* Tooltip will be added in next plan as Client Component */}
    </div>
  );
}
```

**File: components/Legend.tsx**
```typescript
export default function Legend() {
  return (
    <div className="border rounded-lg p-4">
      <h3 className="font-semibold mb-3">Legend</h3>
      <div className="space-y-2">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 bg-red-500 rounded"></div>
          <span className="text-sm">Official Holiday</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 bg-gray-100 border rounded"></div>
          <span className="text-sm">Weekend</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 border-2 border-blue-500 rounded"></div>
          <span className="text-sm">Today</span>
        </div>
      </div>
    </div>
  );
}
```

STYLING REQUIREMENTS per context:
- Holiday red: #EF4444 (Tailwind red-500) ✓
- Weekend gray: subtle (gray-100) ✓
- Current date: border indicator (ring-2 ring-blue-500) ✓
- Monday-first headers: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] ✓
- No adjacent month days: grid-column-start positions first day correctly ✓

CRITICAL: Use getCurrentDate() instead of new Date() for today calculation to avoid Safari timezone bugs.

Do NOT add 'use client' directive - these are Server Components.
  </action>
  <verify>
```bash
# Check files exist
test -f components/Calendar.tsx && echo "✓ Calendar.tsx exists"
test -f components/CalendarDay.tsx && echo "✓ CalendarDay.tsx exists"
test -f components/Legend.tsx && echo "✓ Legend.tsx exists"

# Verify Server Components (no 'use client')
! grep -q "use client" components/Calendar.tsx && echo "✓ Calendar is Server Component"
! grep -q "use client" components/CalendarDay.tsx && echo "✓ CalendarDay is Server Component"
! grep -q "use client" components/Legend.tsx && echo "✓ Legend is Server Component"

# Verify Safari-safe getCurrentDate usage
grep -q "getCurrentDate" components/Calendar.tsx && echo "✓ Using getCurrentDate for Safari safety"

# Verify styling per context
grep -q "bg-red-500" components/CalendarDay.tsx && echo "✓ Holiday red color"
grep -q "bg-gray-100" components/CalendarDay.tsx && echo "✓ Weekend gray background"
grep -q "ring-2 ring-blue-500" components/CalendarDay.tsx && echo "✓ Current date indicator"

# Verify Monday-first headers
grep -q "Mon.*Tue.*Wed.*Thu.*Fri.*Sat.*Sun" components/Calendar.tsx && echo "✓ Monday-first headers"

# Build check
npm run build
```
  </verify>
  <done>
Calendar displays 7-column grid with Monday-first headers, uses getCurrentDate() for Safari-safe today calculation, day cells show red for holidays, gray for weekends, blue ring for current date, legend explains colors, all Server Components compile successfully
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Directory Created**: components/ directory exists
2. **Grid Calculation**: getCalendarGrid() returns correct firstDayOfWeek for Monday-first layout
3. **Safari-Safe Today**: getCurrentDate() uses startOfDay() to avoid timezone bugs
4. **Week Convention**: Calendar headers show Mon→Sun in correct order
5. **Styling Applied**: Holiday cells have red background, weekends gray, current date has border
6. **Server Components**: No 'use client' directives in calendar components
7. **Type Safety**: All Holiday types correctly imported and used
8. **Build Success**: `npm run build` completes without errors
</verification>

<success_criteria>
Phase 01, Plan 02 is complete when:

- [x] components/ directory created
- [x] getCalendarGrid() correctly converts to Monday-first week (0=Mon, 6=Sun)
- [x] parseDate() uses parseISO for Safari compatibility
- [x] getCurrentDate() uses startOfDay for Safari-safe today calculation
- [x] Calendar.tsx renders 7-column CSS grid with Monday headers
- [x] Calendar.tsx uses getCurrentDate() instead of new Date()
- [x] CalendarDay.tsx applies red background to holidays (#EF4444)
- [x] CalendarDay.tsx applies gray background to weekends
- [x] CalendarDay.tsx applies blue ring to current date
- [x] First day of month positioned correctly using gridColumnStart
- [x] Legend.tsx explains red, gray, and border meanings
- [x] All components are Server Components (no 'use client')
- [x] Next.js build completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-static-holiday-view/01-02-SUMMARY.md`
</output>
