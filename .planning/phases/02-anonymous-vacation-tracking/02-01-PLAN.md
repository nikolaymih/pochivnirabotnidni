---
phase: 02-anonymous-vacation-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/useLocalStorage.ts
  - lib/vacation/types.ts
  - lib/vacation/storage.ts
  - components/Calendar.tsx
  - components/CalendarDay.tsx
autonomous: true

must_haves:
  truths:
    - User can click a calendar day to mark it as vacation
    - User can click a marked vacation day to unmark it
    - User can drag across multiple days to mark them as vacation
    - Vacation data persists across browser refresh
  artifacts:
    - path: hooks/useLocalStorage.ts
      provides: SSR-safe localStorage hook with error handling
      exports: [useLocalStorage]
      min_lines: 40
    - path: lib/vacation/types.ts
      provides: VacationData type definition with schema version
      contains: "interface VacationData"
    - path: lib/vacation/storage.ts
      provides: localStorage key constants and default values
      contains: "STORAGE_KEY"
    - path: components/Calendar.tsx
      provides: Vacation state management with drag selection
      contains: "useLocalStorage"
    - path: components/CalendarDay.tsx
      provides: Click and pointer event handlers for vacation marking
      contains: "onPointerDown"
  key_links:
    - from: components/Calendar.tsx
      to: hooks/useLocalStorage
      via: "import and useState-like usage"
      pattern: "const \\[vacationData, setVacationData\\] = useLocalStorage"
    - from: components/CalendarDay.tsx
      to: components/Calendar.tsx
      via: "onToggleVacation callback prop"
      pattern: "onToggleVacation\\(dateStr\\)"
    - from: hooks/useLocalStorage.ts
      to: localStorage API
      via: "window.localStorage.getItem/setItem with try-catch"
      pattern: "window\\.localStorage\\.(getItem|setItem)"
---

<objective>
Create vacation tracking foundation with localStorage persistence and interactive date selection.

Purpose: Enable users to mark calendar days as vacation without authentication, with data persisting across sessions. Establishes the core vacation state management that Phase 2 requirements build upon.

Output: Working vacation marking interaction (click to toggle, drag to select ranges) with localStorage persistence and SSR-safe React hooks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-anonymous-vacation-tracking/02-CONTEXT.md
@.planning/phases/02-anonymous-vacation-tracking/02-RESEARCH.md

# Phase 1 foundation
@.planning/phases/01-foundation-static-holiday-view/01-04-SUMMARY.md

# Existing components to extend
@components/Calendar.tsx
@components/CalendarDay.tsx
@lib/calendar/dates.ts
</context>

<tasks>

<task type="auto">
  <name>Create localStorage hook and vacation types</name>
  <files>
    hooks/useLocalStorage.ts
    lib/vacation/types.ts
    lib/vacation/storage.ts
  </files>
  <action>
Create `hooks/useLocalStorage.ts` with SSR-safe localStorage hook:
- Generic hook `useLocalStorage<T>(key: string, initialValue: T)` returns `[T, Dispatch<SetStateAction<T>>]`
- Lazy initialization with `useState(() => ...)` to read localStorage only once on mount
- SSR guard: Check `typeof window === 'undefined'` before accessing localStorage
- Try-catch around `localStorage.getItem` and `JSON.parse` (catch logs warning, returns initialValue)
- `useEffect` to sync state changes to localStorage with try-catch around `setItem`
- Handle QuotaExceededError (code 22) and SecurityError (private browsing) gracefully

Create `lib/vacation/types.ts`:
```typescript
export interface VacationData {
  version: number;           // Schema version for future migrations
  totalDays: number;         // Annual vacation allowance
  vacationDates: string[];   // Array of ISO date strings (YYYY-MM-DD)
}
```

Create `lib/vacation/storage.ts`:
```typescript
export const VACATION_STORAGE_KEY = 'pochivni-vacation-data';
export const VACATION_SCHEMA_VERSION = 1;
export const DEFAULT_VACATION_DAYS = 20; // Bulgarian standard

export const DEFAULT_VACATION_DATA: VacationData = {
  version: VACATION_SCHEMA_VERSION,
  totalDays: DEFAULT_VACATION_DAYS,
  vacationDates: []
};
```

IMPORTANT:
- Follow Research.md Pattern 1 (useLocalStorage hook) and Pattern 4 (schema versioning)
- Use `typeof window === 'undefined'` guard (NOT `window === undefined`) per Next.js best practices
- All date strings must be ISO format (YYYY-MM-DD) matching Phase 1 TECH-07 decision
  </action>
  <verify>
```bash
# Files exist with expected exports
ls hooks/useLocalStorage.ts lib/vacation/types.ts lib/vacation/storage.ts

# Hook has SSR guards
grep -c "typeof window === 'undefined'" hooks/useLocalStorage.ts  # Should be >= 2

# Types include schema version
grep "version: number" lib/vacation/types.ts

# No TypeScript errors
npx tsc --noEmit
```
  </verify>
  <done>
useLocalStorage hook created with SSR guards and error handling. VacationData type includes version field. Storage constants defined with Bulgarian default (20 days).
  </done>
</task>

<task type="auto">
  <name>Add vacation state and drag selection to Calendar</name>
  <files>
    components/Calendar.tsx
    components/CalendarDay.tsx
  </files>
  <action>
Update `components/Calendar.tsx`:
- Import: `useLocalStorage` from `@/hooks/useLocalStorage`
- Import: `VACATION_STORAGE_KEY, DEFAULT_VACATION_DATA` from `@/lib/vacation/storage`
- Import: `VacationData` from `@/lib/vacation/types`
- Import: `eachDayOfInterval, format` from `date-fns` (for drag range calculation)
- Add state: `const [vacationData, setVacationData] = useLocalStorage<VacationData>(VACATION_STORAGE_KEY, DEFAULT_VACATION_DATA)`
- Add drag state: `const [isDragging, setIsDragging] = useState(false)`
- Add drag state: `const [dragStart, setDragStart] = useState<string | null>(null)`
- Add drag state: `const [currentHover, setCurrentHover] = useState<string | null>(null)`

Add helper function (inside component, before JSX):
```typescript
const getDateRange = (start: string, end: string): string[] => {
  const startDate = parseISO(start);
  const endDate = parseISO(end);
  const [rangeStart, rangeEnd] = startDate <= endDate ? [startDate, endDate] : [endDate, startDate];
  return eachDayOfInterval({ start: rangeStart, end: rangeEnd })
    .map(date => format(date, 'yyyy-MM-dd'));
};

const toggleVacationDate = (dateStr: string) => {
  const vacationSet = new Set(vacationData.vacationDates);
  if (vacationSet.has(dateStr)) {
    vacationSet.delete(dateStr);
  } else {
    vacationSet.add(dateStr);
  }
  setVacationData({
    ...vacationData,
    vacationDates: Array.from(vacationSet)
  });
};

const handlePointerDown = (dateStr: string) => {
  setIsDragging(true);
  setDragStart(dateStr);
  setCurrentHover(dateStr);
  toggleVacationDate(dateStr);
};

const handlePointerMove = (dateStr: string) => {
  if (!isDragging || !dragStart) return;
  setCurrentHover(dateStr);
};

const handlePointerUp = () => {
  if (!isDragging || !dragStart || !currentHover) {
    setIsDragging(false);
    setDragStart(null);
    setCurrentHover(null);
    return;
  }

  const range = getDateRange(dragStart, currentHover);
  if (range.length > 1) {
    const vacationSet = new Set(vacationData.vacationDates);
    range.forEach(date => vacationSet.add(date));
    setVacationData({
      ...vacationData,
      vacationDates: Array.from(vacationSet)
    });
  }

  setIsDragging(false);
  setDragStart(null);
  setCurrentHover(null);
};
```

- Pass to CalendarDay: `isVacation={vacationData.vacationDates.includes(dateStr)}`, `onPointerDown={handlePointerDown}`, `onPointerMove={handlePointerMove}`, `onPointerUp={handlePointerUp}`
- Add `onPointerUp` listener to calendar container div (for when pointer released outside day cell)

Update `components/CalendarDay.tsx`:
- Add prop types: `isVacation?: boolean`, `onPointerDown?: (dateStr: string) => void`, `onPointerMove?: (dateStr: string) => void`, `onPointerUp?: () => void`
- Add pointer event handlers to day cell div:
  - `onPointerDown={() => onPointerDown?.(dateStr)}`
  - `onPointerEnter={() => onPointerMove?.(dateStr)}`
  - `onPointerUp={() => onPointerUp?.()}`
- Add CSS classes: `cursor-pointer select-none` (enable clicking, prevent text selection during drag)
- Do NOT add vacation styling yet (deferred to Plan 02 Task 4)

IMPORTANT:
- Use Pointer Events API (onPointerDown/Move/Up) NOT mouse events for touch compatibility per Research.md Pitfall 4
- Toggle vacation on pointer down (immediate feedback), extend range on pointer up
- Use Set for uniqueness to prevent duplicates (VAC-08 requirement)
- Use `parseISO` and `format` from date-fns per Phase 1 TECH-01 decision
- Make Calendar a Client Component ('use client' directive) for useState/useEffect access
- CalendarDay remains Server Component (receives props only)
  </action>
  <verify>
```bash
# Calendar imports vacation types and hook
grep "useLocalStorage" components/Calendar.tsx
grep "VacationData" components/Calendar.tsx

# Calendar has drag state
grep "isDragging" components/Calendar.tsx
grep "dragStart" components/Calendar.tsx

# CalendarDay has pointer event props
grep "onPointerDown" components/CalendarDay.tsx
grep "cursor-pointer" components/CalendarDay.tsx

# Calendar is Client Component
head -1 components/Calendar.tsx | grep "'use client'"

# No TypeScript errors
npx tsc --noEmit
```
  </verify>
  <done>
Calendar has vacation state with useLocalStorage hook. Drag selection implemented with Pointer Events API. CalendarDay accepts pointer event handlers. Vacation marking works with click and drag. Data persists in localStorage across refresh.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Manual browser test:
   - Visit http://localhost:3000
   - Click a calendar day → should mark as vacation
   - Click the same day again → should unmark
   - Drag across multiple days → should mark range
   - Refresh page → vacation marks should persist
   - Open browser DevTools → Application → Local Storage → verify `pochivni-vacation-data` key exists

2. Check localStorage structure:
```bash
# In browser console
JSON.parse(localStorage.getItem('pochivni-vacation-data'))
// Should show: {version: 1, totalDays: 20, vacationDates: ["2026-01-15", ...]}
```

3. SSR check:
```bash
# Build production to verify SSR works
npm run build
# Should succeed without "window is not defined" errors
```
</verification>

<success_criteria>
- useLocalStorage hook exists with SSR guards and error handling
- VacationData type includes version, totalDays, vacationDates fields
- Storage constants defined with Bulgarian default (20 days)
- Calendar component uses useLocalStorage to persist vacation state
- CalendarDay accepts pointer event handlers
- Clicking a day toggles vacation state (mark/unmark)
- Dragging across days marks range
- Vacation data persists across page refresh
- No hydration warnings in console
- Production build succeeds without SSR errors
- VAC-08 satisfied: Set prevents duplicate dates
</success_criteria>

<output>
After completion, create `.planning/phases/02-anonymous-vacation-tracking/02-01-SUMMARY.md` following the summary template.
</output>
