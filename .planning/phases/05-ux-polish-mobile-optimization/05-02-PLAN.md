---
phase: 05-ux-polish-mobile-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/offline/network.ts
  - lib/offline/retry.ts
  - components/NetworkStatus.tsx
  - app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees toast notification when network connection drops"
    - "User sees toast notification when network connection restores"
    - "Failed API operations retry automatically with exponential backoff (3 attempts)"
    - "Supabase sync failures retry before falling back to localStorage silently"
  artifacts:
    - path: "lib/offline/network.ts"
      provides: "useNetworkState hook with navigator.onLine + verification fetch"
      exports: ["useNetworkState"]
    - path: "lib/offline/retry.ts"
      provides: "fetchWithRetry wrapper using exponential backoff"
      exports: ["fetchWithRetry"]
    - path: "components/NetworkStatus.tsx"
      provides: "Network state detector that shows toast on offline/online transitions"
      contains: "useNetworkState"
    - path: "app/layout.tsx"
      provides: "Toaster provider and NetworkStatus mounted app-wide"
      contains: "Toaster"
  key_links:
    - from: "components/NetworkStatus.tsx"
      to: "lib/offline/network.ts"
      via: "useNetworkState hook import"
      pattern: "useNetworkState"
    - from: "app/layout.tsx"
      to: "components/NetworkStatus.tsx"
      via: "mounted as child inside body"
      pattern: "NetworkStatus"
---

<objective>
Add network state detection, toast notifications for offline/online transitions, and retry-with-backoff for API operations.

Purpose: Users need to know when they lose network connectivity (view-only mode applies), and when it restores. API operations (holiday fetch, Supabase sync) should retry automatically with exponential backoff before giving up. Per CONTEXT.md: toast on network loss, automatic silent reconnection, 3 attempts with increasing delays.

Output: useNetworkState hook, fetchWithRetry utility, NetworkStatus component with toast integration, and Toaster provider in layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ux-polish-mobile-optimization/05-CONTEXT.md
@.planning/phases/05-ux-polish-mobile-optimization/05-RESEARCH.md
@app/layout.tsx
@lib/vacation/sync.ts
@lib/holidays/fetch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network detection hook, retry utility, and install react-hot-toast</name>
  <files>lib/offline/network.ts, lib/offline/retry.ts</files>
  <action>
  First, install react-hot-toast:
  ```bash
  npm install react-hot-toast
  ```

  Create `lib/offline/network.ts`:
  - Export `useNetworkState()` hook returning `{ isOnline: boolean, isVerified: boolean }`
  - Initialize state with `typeof navigator !== 'undefined' ? navigator.onLine : true` (SSR guard per existing codebase pattern)
  - Listen for `window.addEventListener('online', handleOnline)` and `window.addEventListener('offline', handleOffline)`
  - On 'offline' event: set isOnline=false immediately (false is reliable per RESEARCH.md Pitfall 1)
  - On 'online' event: verify with actual HEAD request to `/api/health` before setting isOnline=true (navigator.onLine has false positives on LAN without internet)
  - Verification fetch: use AbortController with 5s timeout to prevent hanging
  - Initial verification on mount: call verifyConnection()
  - Clean up event listeners on unmount
  - Use `useRef` for mounted check to prevent state updates after unmount

  Create `lib/offline/retry.ts`:
  - Export `fetchWithRetry(url: string, options?: RequestInit, retryConfig?: RetryConfig): Promise<Response>`
  - RetryConfig type: `{ retries?: number, retryOn?: number[], baseDelay?: number }`
  - Default: 3 retries, retryOn [503, 504, 429], baseDelay 1000ms
  - Exponential backoff: delay = baseDelay * 2^attempt (1s, 2s, 4s)
  - On final failure: throw the error (caller handles fallback)
  - Use standard fetch() internally (NOT the fetch-retry npm package - it uses CommonJS require syntax that can conflict with Next.js ESM. Simple manual implementation is 20 lines and more reliable.)
  - Log retries to console.warn for debugging: `[Retry] Attempt ${attempt}/${retries} for ${url} after ${status}`

  Create `app/api/health/route.ts`:
  - Simple GET/HEAD endpoint returning 200 with `{ status: 'ok' }`
  - Used by useNetworkState for online verification
  - Minimal response body to avoid unnecessary data transfer

  IMPORTANT: Use `typeof window === 'undefined'` guard (not `window === undefined`) per existing 02-01 decision.
  IMPORTANT: Do NOT use the fetch-retry npm package directly. Write a simple retry wrapper. The package has CommonJS/ESM compatibility issues with Next.js App Router.
  </action>
  <verify>
  - `npm run build` passes
  - `lib/offline/network.ts` exports useNetworkState
  - `lib/offline/retry.ts` exports fetchWithRetry
  - `app/api/health/route.ts` returns 200
  - react-hot-toast is in package.json dependencies
  </verify>
  <done>useNetworkState hook detects online/offline with verification. fetchWithRetry provides exponential backoff. Health endpoint exists for verification.</done>
</task>

<task type="auto">
  <name>Task 2: Create NetworkStatus component with toast notifications and wire into layout</name>
  <files>components/NetworkStatus.tsx, app/layout.tsx</files>
  <action>
  Create `components/NetworkStatus.tsx`:
  - 'use client' component (uses hooks and browser APIs)
  - Import `useNetworkState` from `@/lib/offline/network`
  - Import `toast` from `react-hot-toast`
  - Use `useRef` to track previous online state (prevIsOnline) to only toast on TRANSITIONS, not on initial load
  - useEffect watching isOnline + isVerified:
    - Skip if not verified yet (avoid toast on page load)
    - If was online and now offline: `toast('–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞. –†–∞–±–æ—Ç–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω.', { icon: 'üì°', duration: 4000 })`
    - If was offline and now online: `toast.success('–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞', { duration: 2000 })`
    - Update prevIsOnline ref
  - Render nothing (return null) - this is a side-effect-only component
  - Export as default

  Update `app/layout.tsx`:
  - Import `Toaster` from `react-hot-toast`
  - Import `NetworkStatus` from `@/components/NetworkStatus`
  - Add `<Toaster position="bottom-center" />` inside the body, after AuthProvider children
  - Add `<NetworkStatus />` inside the body, after Toaster
  - Both Toaster and NetworkStatus must be INSIDE the body tag but can be OUTSIDE AuthProvider since they don't need auth context
  - Wait, Toaster and NetworkStatus need to be client components. Toaster is already 'use client' from react-hot-toast. NetworkStatus is 'use client'. They should be placed inside the body alongside AuthProvider.

  Layout structure should be:
  ```tsx
  <body>
    <AuthProvider>
      {children}
    </AuthProvider>
    <Toaster position="bottom-center" />
    <NetworkStatus />
  </body>
  ```

  IMPORTANT: Toast messages are in Bulgarian (Cyrillic) per established localization pattern.
  IMPORTANT: Only show toast on STATE TRANSITIONS (offline->online, online->offline). Never on initial page load.
  IMPORTANT: Use `useRef` to track previous state, not `useState` (avoids re-render loops).
  </action>
  <verify>
  - `npm run build` passes
  - NetworkStatus.tsx has 'use client' directive
  - NetworkStatus renders null (side-effect only)
  - layout.tsx includes Toaster and NetworkStatus
  - Toast messages are in Bulgarian
  - useRef tracks previous online state (no initial toast)
  </verify>
  <done>Network status changes trigger Bulgarian toast notifications. Toaster provider is mounted app-wide. No toast on initial page load, only on transitions.</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Navigate to app, open DevTools Network tab, toggle "Offline" - toast appears in Bulgarian
- Toggle back to online - success toast appears
- `/api/health` returns 200 OK
- fetchWithRetry is available for use in subsequent plans
</verification>

<success_criteria>
- Toast notification appears when going offline ("–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞. –†–∞–±–æ—Ç–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω.")
- Toast notification appears when coming back online ("–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞")
- No toast on initial page load
- fetchWithRetry utility retries with 1s, 2s, 4s delays
- Health check endpoint responds at /api/health
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-ux-polish-mobile-optimization/05-02-SUMMARY.md`
</output>
