---
phase: 05-ux-polish-mobile-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/offline/network.ts
  - lib/offline/retry.ts
  - components/NetworkStatus.tsx
  - app/layout.tsx
  - app/api/health/route.ts
autonomous: true

must_haves:
  truths:
    - "User sees toast notification when network connection drops"
    - "User sees toast notification when network connection restores"
    - "Failed API operations retry automatically with exponential backoff (3 attempts)"
    - "Supabase sync failures retry before falling back to localStorage silently"
    - "Toast is visible on mobile Safari without being obscured by address bar"
  artifacts:
    - path: "lib/offline/network.ts"
      provides: "useNetworkState hook with navigator.onLine + verification fetch"
      exports: ["useNetworkState"]
    - path: "lib/offline/retry.ts"
      provides: "fetchWithRetry wrapper using exponential backoff"
      exports: ["fetchWithRetry"]
    - path: "components/NetworkStatus.tsx"
      provides: "Network state detector that shows toast on offline/online transitions"
      contains: "useNetworkState"
    - path: "app/layout.tsx"
      provides: "Toaster provider and NetworkStatus mounted app-wide"
      contains: "Toaster"
    - path: "app/api/health/route.ts"
      provides: "Simple GET/HEAD endpoint for network verification"
      exports: ["GET"]
  key_links:
    - from: "components/NetworkStatus.tsx"
      to: "lib/offline/network.ts"
      via: "useNetworkState hook import"
      pattern: "useNetworkState"
    - from: "app/layout.tsx"
      to: "components/NetworkStatus.tsx"
      via: "mounted as child inside body"
      pattern: "NetworkStatus"
    - from: "lib/offline/network.ts"
      to: "app/api/health/route.ts"
      via: "HEAD fetch for online verification"
      pattern: "/api/health"
---

<objective>
Add network state detection, toast notifications for offline/online transitions, and retry-with-backoff for API operations.

Purpose: Users need to know when they lose network connectivity (view-only mode applies), and when it restores. API operations (holiday fetch, Supabase sync) should retry automatically with exponential backoff before giving up. Per CONTEXT.md: toast on network loss, automatic silent reconnection, 3 attempts with increasing delays.

Output: useNetworkState hook, fetchWithRetry utility, NetworkStatus component with toast integration, health endpoint, and Toaster provider in layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ux-polish-mobile-optimization/05-CONTEXT.md
@.planning/phases/05-ux-polish-mobile-optimization/05-RESEARCH.md
@app/layout.tsx
@lib/vacation/sync.ts
@lib/holidays/fetch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network detection hook, retry utility, health endpoint, and install react-hot-toast</name>
  <files>lib/offline/network.ts, lib/offline/retry.ts, app/api/health/route.ts</files>
  <action>
  First, install react-hot-toast:
  ```bash
  npm install react-hot-toast
  ```

  Create `lib/offline/network.ts`:
  - Export `useNetworkState()` hook returning `{ isOnline: boolean, isVerified: boolean }`
  - Initialize state with `typeof navigator !== 'undefined' ? navigator.onLine : true` (SSR guard per existing codebase pattern)
  - Listen for `window.addEventListener('online', handleOnline)` and `window.addEventListener('offline', handleOffline)`
  - On 'offline' event: set isOnline=false immediately (false is reliable per RESEARCH.md Pitfall 1)
  - On 'online' event: verify with actual HEAD request to `/api/health` before setting isOnline=true (navigator.onLine has false positives on LAN without internet)
  - Verification fetch: use AbortController with 5s timeout to prevent hanging
  - Initial verification on mount: call verifyConnection()
  - Clean up event listeners on unmount
  - Use `useRef` for mounted check to prevent state updates after unmount

  Create `lib/offline/retry.ts`:
  - Export `fetchWithRetry(url: string, options?: RequestInit, retryConfig?: RetryConfig): Promise<Response>`
  - RetryConfig type: `{ retries?: number, retryOn?: number[], baseDelay?: number }`
  - Default: 3 retries, retryOn [503, 504, 429], baseDelay 1000ms
  - Exponential backoff: delay = baseDelay * 2^attempt (1s, 2s, 4s)
  - On final failure: throw the error (caller handles fallback)
  - Use standard fetch() internally (NOT the fetch-retry npm package - it uses CommonJS require syntax that can conflict with Next.js ESM. Simple manual implementation is 20 lines and more reliable.)
  - Log retries to console.warn for debugging: `[Retry] Attempt ${attempt}/${retries} for ${url} after ${status}`

  Create `app/api/health/route.ts`:
  - Simple GET/HEAD endpoint returning 200 with `{ status: 'ok' }`
  - Used by useNetworkState for online verification
  - Minimal response body to avoid unnecessary data transfer

  IMPORTANT: Use `typeof window === 'undefined'` guard (not `window === undefined`) per existing 02-01 decision.
  IMPORTANT: Do NOT use the fetch-retry npm package directly. Write a simple retry wrapper. The package has CommonJS/ESM compatibility issues with Next.js App Router.
  </action>
  <verify>
  - `npm run build` passes
  - `lib/offline/network.ts` exports useNetworkState
  - `lib/offline/retry.ts` exports fetchWithRetry
  - `app/api/health/route.ts` exists and exports GET handler returning 200
  - react-hot-toast is in package.json dependencies
  </verify>
  <done>useNetworkState hook detects online/offline with verification. fetchWithRetry provides exponential backoff. Health endpoint exists at /api/health for verification.</done>
</task>

<task type="auto">
  <name>Task 2: Create NetworkStatus component with toast notifications and wire into layout</name>
  <files>components/NetworkStatus.tsx, app/layout.tsx</files>
  <action>
  Create `components/NetworkStatus.tsx`:
  - 'use client' component (uses hooks and browser APIs)
  - Import `useNetworkState` from `@/lib/offline/network`
  - Import `toast` from `react-hot-toast`
  - Use `useRef` to track previous online state (prevIsOnline) to only toast on TRANSITIONS, not on initial load
  - useEffect watching isOnline + isVerified:
    - Skip if not verified yet (avoid toast on page load)
    - If was online and now offline: `toast('–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞. –†–∞–±–æ—Ç–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω.', { icon: 'üì°', duration: 4000 })`
    - If was offline and now online: `toast.success('–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞', { duration: 2000 })`
    - Update prevIsOnline ref
  - Render nothing (return null) - this is a side-effect-only component
  - Export as default

  Update `app/layout.tsx`:
  - Import `Toaster` from `react-hot-toast`
  - Import `NetworkStatus` from `@/components/NetworkStatus`
  - Add `<Toaster position="bottom-center" toastOptions={{ style: { marginBottom: '80px' } }} />` inside the body, after AuthProvider children
  - The `marginBottom: '80px'` ensures toasts appear above mobile Safari's address bar/bottom UI chrome. This prevents the toast from being hidden behind browser UI elements on iOS.
  - Add `<NetworkStatus />` inside the body, after Toaster
  - Both Toaster and NetworkStatus need to be client components. Toaster is already 'use client' from react-hot-toast. NetworkStatus is 'use client'. They should be placed inside the body alongside AuthProvider.

  Layout structure should be:
  ```tsx
  <body>
    <AuthProvider>
      {children}
    </AuthProvider>
    <Toaster position="bottom-center" toastOptions={{ style: { marginBottom: '80px' } }} />
    <NetworkStatus />
  </body>
  ```

  IMPORTANT: Toast messages are in Bulgarian (Cyrillic) per established localization pattern.
  IMPORTANT: Only show toast on STATE TRANSITIONS (offline->online, online->offline). Never on initial page load.
  IMPORTANT: Use `useRef` to track previous state, not `useState` (avoids re-render loops).
  IMPORTANT: Add marginBottom to toast options to keep toasts visible above mobile Safari's bottom UI (address bar). Test on Safari iOS if possible.
  </action>
  <verify>
  - `npm run build` passes
  - NetworkStatus.tsx has 'use client' directive
  - NetworkStatus renders null (side-effect only)
  - layout.tsx includes Toaster with position="bottom-center" and marginBottom style
  - layout.tsx includes NetworkStatus
  - Toast messages are in Bulgarian
  - useRef tracks previous online state (no initial toast)
  - Toaster has marginBottom: '80px' in toastOptions.style to avoid Safari address bar conflict
  </verify>
  <done>Network status changes trigger Bulgarian toast notifications. Toaster provider is mounted app-wide with bottom-center positioning and 80px margin to avoid mobile Safari UI overlap. No toast on initial page load, only on transitions.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate fetchWithRetry into holiday fetch and document Supabase sync deferral</name>
  <files>lib/holidays/fetch.ts</files>
  <action>
  Wire fetchWithRetry into the existing holiday data fetching:

  In `lib/holidays/fetch.ts`:
  - Import `fetchWithRetry` from `@/lib/offline/retry`
  - Replace the existing `fetch()` call(s) to the OpenHolidays API with `fetchWithRetry()` using the same URL and options
  - Use default retry config (3 retries, retryOn [503, 504, 429], 1s base delay) - these defaults match the OpenHolidays API's likely failure modes
  - Keep the existing static JSON fallback as the final fallback (after all retries fail)
  - The retry chain is: fetchWithRetry (3 attempts with backoff) -> if all fail -> static JSON fallback

  For Supabase sync (lib/vacation/sync.ts):
  - Do NOT wire fetchWithRetry into Supabase sync at this time
  - Reason: Supabase sync already has its own error handling (silent failure mode per 04-03 decision), and the debounced sync pattern (1.5s) would conflict with retry timing
  - This deferral is intentional - Supabase sync retry can be added in Phase 6 if needed after testing reveals it's necessary

  IMPORTANT: Only modify lib/holidays/fetch.ts. Do NOT modify lib/vacation/sync.ts.
  IMPORTANT: The existing static JSON fallback remains the ultimate fallback after retries exhaust.
  </action>
  <verify>
  - `npm run build` passes
  - lib/holidays/fetch.ts imports fetchWithRetry
  - OpenHolidays API calls use fetchWithRetry instead of raw fetch
  - Static JSON fallback still exists as final fallback
  - lib/vacation/sync.ts is NOT modified
  </verify>
  <done>fetchWithRetry is wired into holiday data fetching. OpenHolidays API calls now retry 3 times with exponential backoff before falling back to static JSON. Supabase sync deferral is intentional (has its own error handling).</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Navigate to app, open DevTools Network tab, toggle "Offline" - toast appears in Bulgarian
- Toggle back to online - success toast appears
- `/api/health` returns 200 OK
- fetchWithRetry is used by holiday fetch
- Toast is positioned above mobile Safari bottom UI (verify with 80px margin)
</verification>

<success_criteria>
- Toast notification appears when going offline ("–ù—è–º–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞. –†–∞–±–æ—Ç–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω.")
- Toast notification appears when coming back online ("–í—Ä—ä–∑–∫–∞—Ç–∞ –µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞")
- No toast on initial page load
- fetchWithRetry utility retries with 1s, 2s, 4s delays
- Holiday fetch uses fetchWithRetry with static JSON as final fallback
- Health check endpoint responds at /api/health
- Toast visible on mobile Safari (not obscured by address bar)
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-ux-polish-mobile-optimization/05-02-SUMMARY.md`
</output>
