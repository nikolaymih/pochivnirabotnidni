---
phase: 05-ux-polish-mobile-optimization
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - app/sw.ts
  - next.config.ts
  - public/manifest.json
  - app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Application loads and displays cached holidays when offline"
    - "Users can view existing vacation selections when offline"
    - "Service worker caches holiday API responses for current year"
    - "PWA manifest enables Add to Home Screen on mobile"
    - "Service worker is disabled in development mode"
  artifacts:
    - path: "app/sw.ts"
      provides: "Service worker with runtime caching for holidays API and app shell"
      contains: "Serwist"
    - path: "next.config.ts"
      provides: "Serwist plugin integration with Next.js build"
      contains: "withSerwist"
    - path: "public/manifest.json"
      provides: "PWA manifest with app name, icons, theme color"
      contains: "Почивни Работни Дни"
    - path: "app/layout.tsx"
      provides: "Manifest link in metadata for PWA installability"
      contains: "manifest"
  key_links:
    - from: "next.config.ts"
      to: "app/sw.ts"
      via: "Serwist build plugin compiles sw.ts to public/sw.js"
      pattern: "swSrc.*sw\\.ts"
    - from: "app/layout.tsx"
      to: "public/manifest.json"
      via: "metadata manifest link"
      pattern: "manifest"
    - from: "app/sw.ts"
      to: "openholidaysapi.org"
      via: "CacheFirst runtime caching rule"
      pattern: "openholidaysapi"
---

<objective>
Set up PWA service worker with Serwist for offline holiday viewing and Add-to-Home-Screen capability.

Purpose: Users should be able to view the calendar with cached holidays when offline (view-only mode per CONTEXT.md). The service worker caches holiday API responses and app shell assets. PWA manifest enables mobile users to install the app to their home screen for a native-like experience. This plan depends on both 05-01 (touch interactions must be working for offline mobile UX) and 05-02 (network detection and retry must be in place before SW caching layer).

Output: Serwist service worker configuration, Next.js config integration, PWA manifest, and metadata updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ux-polish-mobile-optimization/05-CONTEXT.md
@.planning/phases/05-ux-polish-mobile-optimization/05-RESEARCH.md
@.planning/phases/05-ux-polish-mobile-optimization/05-01-SUMMARY.md
@.planning/phases/05-ux-polish-mobile-optimization/05-02-SUMMARY.md
@next.config.ts
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and create service worker with caching rules</name>
  <files>app/sw.ts</files>
  <action>
  Install Serwist packages:
  ```bash
  npm install -D @serwist/next
  npm install serwist
  ```

  Create `app/sw.ts` (service worker source):
  - Import Serwist from "serwist"
  - Declare `self.__SW_MANIFEST` for precache manifest (Serwist injects this at build time)
  - Create Serwist instance with:
    - `precacheEntries: self.__SW_MANIFEST` (app shell assets)
    - `skipWaiting: true` (activate new SW immediately)
    - `clientsClaim: true` (take control of all clients)
    - `runtimeCaching` array with two rules:

  Runtime caching rule 1 - Holiday API (CacheFirst):
  - `urlPattern: /^https:\/\/openholidaysapi\.org\/.*$/`
  - handler: CacheFirst strategy (holidays rarely change, cache-first is ideal)
  - cacheName: 'holidays-api-cache'
  - expiration: maxEntries 10, maxAgeSeconds 30 days (30 * 24 * 60 * 60)
  - cacheableResponse: statuses [0, 200]

  Runtime caching rule 2 - Static assets (StaleWhileRevalidate):
  - `urlPattern: /\.(js|css|png|jpg|svg|woff2?)$/`
  - handler: StaleWhileRevalidate strategy
  - cacheName: 'static-assets'
  - expiration: maxEntries 50, maxAgeSeconds 7 days

  - Call `serwist.addEventListeners()` at the end
  - Do NOT cache Supabase API calls in the service worker (vacation mutations should not be cached, per CONTEXT.md view-only offline mode). The existing localStorage fallback handles offline vacation data.

  IMPORTANT: Do NOT cache Supabase requests. Only cache holiday API and static assets.
  IMPORTANT: Do NOT create an offline.html fallback page - the app shell is cached by precaching and the SPA handles offline gracefully with localStorage data.
  IMPORTANT: Use CacheFirst for holidays (data changes at most yearly), StaleWhileRevalidate for static assets.
  </action>
  <verify>
  - app/sw.ts exists with Serwist import
  - CacheFirst rule targets openholidaysapi.org
  - StaleWhileRevalidate rule targets static assets
  - No Supabase URLs in caching rules
  - skipWaiting and clientsClaim are true
  </verify>
  <done>Service worker source file created with CacheFirst for holidays API and StaleWhileRevalidate for static assets. Supabase calls intentionally excluded from caching.</done>
</task>

<task type="auto">
  <name>Task 2: Update Next.js config with Serwist plugin wrapper</name>
  <files>next.config.ts</files>
  <action>
  Update `next.config.ts`:
  - Import `withSerwist` from `@serwist/next`
  - Wrap the existing config with withSerwist:
    ```typescript
    import withSerwistInit from "@serwist/next";

    const withSerwist = withSerwistInit({
      swSrc: "app/sw.ts",
      swDest: "public/sw.js",
      disable: process.env.NODE_ENV === "development",
    });

    const nextConfig: NextConfig = {
      // existing config preserved
    };

    export default withSerwist(nextConfig);
    ```
  - CRITICAL: `disable: process.env.NODE_ENV === "development"` prevents Pitfall 2 (stale assets in dev mode)
  - The Serwist Next.js plugin requires webpack (not Turbopack). If dev script uses --turbopack, this is fine because SW is disabled in dev anyway.
  - Preserve ALL existing next.config.ts settings (just wrap with withSerwist)
  </action>
  <verify>
  - `npm run build` passes (Serwist compiles sw.ts to public/sw.js)
  - `ls public/sw.js` exists after build (generated by Serwist)
  - next.config.ts imports withSerwistInit from "@serwist/next"
  - next.config.ts has disable: process.env.NODE_ENV === "development"
  - Existing next.config settings are preserved
  </verify>
  <done>Next.js config wraps with Serwist plugin. Service worker compiles to public/sw.js on production build. Disabled in development to prevent stale asset issues.</done>
</task>

<task type="auto">
  <name>Task 3: Create PWA manifest and update layout metadata</name>
  <files>public/manifest.json, app/layout.tsx</files>
  <action>
  Create `public/manifest.json`:
  ```json
  {
    "name": "Почивни Работни Дни",
    "short_name": "Почивни Дни",
    "description": "Календар с български празници и планиране на отпуски",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2563eb",
    "icons": [
      {
        "src": "/icon-192.png",
        "sizes": "192x192",
        "type": "image/png"
      },
      {
        "src": "/icon-512.png",
        "sizes": "512x512",
        "type": "image/png"
      }
    ]
  }
  ```
  - Bulgarian name and description per INTL localization pattern
  - theme_color #2563eb matches the blue-500 used for today ring and vacation colors
  - display: standalone for native-like experience
  - Icons: Reference placeholder paths. For now create simple placeholder SVG-based PNGs or just reference the paths (actual icons can be added later). The manifest is valid without icons present.

  Update `app/layout.tsx`:
  - Add manifest to the existing `metadata` export:
    ```typescript
    export const metadata: Metadata = {
      title: "Почивни Работни Дни - Календар с Български Празници 2026",
      description: "Преглед на българските официални празници и планиране на вашите дни за отпуск с интерактивен календар за 2026",
      manifest: "/manifest.json",
      themeColor: "#2563eb",
      appleWebApp: {
        capable: true,
        statusBarStyle: "default",
        title: "Почивни Дни",
      },
    };
    ```
  - The `appleWebApp` metadata adds iOS-specific PWA support (Apple does not use manifest.json for all features)

  Read layout.tsx first (it was modified by Plan 05-02 to add Toaster and NetworkStatus). Preserve those additions.

  IMPORTANT: Preserve the existing AuthProvider, Toaster, and NetworkStatus from the layout (added in Plan 05-02).
  IMPORTANT: Do NOT modify the body structure or component nesting, only update the metadata export.
  </action>
  <verify>
  - `npm run build` passes
  - `public/manifest.json` exists with Bulgarian content
  - layout.tsx metadata includes `manifest: "/manifest.json"`
  - layout.tsx metadata includes themeColor and appleWebApp
  - Existing Toaster and NetworkStatus still present in layout
  </verify>
  <done>PWA manifest with Bulgarian metadata exists. Layout metadata links manifest and includes theme color and iOS PWA support. App is installable on mobile devices.</done>
</task>

</tasks>

<verification>
- `npm run build` completes successfully
- `public/sw.js` is generated by build
- `public/manifest.json` exists with correct content
- In production build (`npm start`): DevTools > Application > Service Workers shows active SW
- In production build: DevTools > Application > Manifest shows valid manifest
- Toggle offline in DevTools: app still loads with cached holidays
- In development mode: no service worker registered (disabled)
</verification>

<success_criteria>
- Service worker registers in production builds
- Holiday API responses cached via CacheFirst strategy
- App loads offline with cached content (view-only)
- PWA manifest enables Add to Home Screen
- Service worker disabled in development
- No Supabase calls cached (mutations stay online-only)
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-ux-polish-mobile-optimization/05-03-SUMMARY.md`
</output>
