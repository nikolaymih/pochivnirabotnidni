# Phase 5.1: UX Infrastructure & Feedback Loop - Research

**Researched:** 2026-02-06
**Status:** Complete

## 1. Coffee Theme → Tailwind Integration

### Current State
- **Tailwind CSS v4** (latest) using new `@theme inline` syntax in `globals.css`
- **No tailwind.config.ts/js file** — using defaults
- Only 2 CSS custom properties: `--background` and `--foreground`
- Current fonts: Geist (Google Fonts), body falls back to Arial/Helvetica
- **85+ hardcoded Tailwind color classes** scattered across components
- Dark mode via `prefers-color-scheme` media query (not toggle)

### Current Color Mapping
```
Calendar Day States:
  Holiday: bg-red-100 text-red-900  →  Coffee: Cinnamon (#B5651D)
  Bridge: bg-yellow-100 text-yellow-900  →  Coffee: Honey (#EB9605)
  Vacation: bg-blue-100 text-blue-900  →  Coffee: Caramel (#C68E17)
  Weekend: bg-gray-50 text-gray-500  →  Coffee: Foam/Cream
  Today: ring-2 ring-blue-500  →  Coffee: Caramel ring
  Highlight: bg-gray-200  →  Coffee: Oat Milk

UI Chrome:
  Background: bg-white  →  Coffee: Foam (#FAF8F5) or Cream (#F5F0E8)
  Cards: bg-white border-gray-200  →  Coffee: White with Latte border
  Text primary: text-gray-800  →  Coffee: Espresso (#2C1810)
  Text secondary: text-gray-600  →  Coffee: Coffee (#6F4E37)
  Buttons: bg-green-500  →  Coffee: Caramel (#C68E17)
  Links: text-blue-600  →  Coffee: Mocha (#5D3A2E)
  Tooltip: bg-gray-900  →  Coffee: Espresso (#2C1810)
```

### Tailwind v4 Theme Approach
In Tailwind v4, theme customization uses `@theme` blocks in CSS, NOT `tailwind.config.ts`:

```css
@theme {
  --color-espresso: #2C1810;
  --color-dark-roast: #3D251E;
  --color-mocha: #5D3A2E;
  /* etc. */
  --font-sans: 'Nunito', sans-serif;
}
```

This generates utility classes like `bg-espresso`, `text-mocha`, `font-sans` automatically.

### Font Loading: Nunito
Option A (recommended for Next.js): Use `next/font/google`
```typescript
import { Nunito } from 'next/font/google';
const nunito = Nunito({ variable: '--font-nunito', subsets: ['latin', 'cyrillic'] });
```
**Critical:** Must include `cyrillic` subset for Bulgarian text.

Option B: Google Fonts link (slower, FOUT risk).

### Migration Strategy
1. Define Coffee tokens in `globals.css` using `@theme` block
2. Create semantic aliases (e.g., `--color-holiday: var(--color-cinnamon)`)
3. Find-and-replace Tailwind classes across all components
4. Document token mapping (inherited vs overridden)

### Key Risks
- **Tailwind v4 compatibility**: `@theme` syntax is different from v3 config. No `tailwind.config.ts` needed.
- **Cyrillic font support**: Nunito supports Cyrillic — verified on Google Fonts
- **85+ class replacements**: Systematic but tedious — need a mapping document
- **Dark mode**: Coffee theme doesn't define dark mode. Can omit or defer.

## 2. agent-browser Integration

### Installation
```bash
npm install -g agent-browser
```

### Key Commands
```bash
# Open a URL
ab open http://localhost:3000

# Take accessibility snapshot (text output for AI)
ab snapshot

# Take screenshot
ab screenshot --path /tmp/calendar.png

# Click element by ref
ab click @e5

# Type text
ab type @e3 "hello"

# Get page source
ab source
```

### Architecture
- **Client-daemon**: Rust CLI communicates with Node.js daemon managing Playwright
- **Ref-based selection**: Returns accessibility tree with unique refs (@e1, @e2) for deterministic interaction
- **Token-efficient output**: Compact text, not verbose JSON
- **Multi-session**: Isolated browser instances for parallel work

### Pre-commit Hook Setup
Use a simple git hook (not husky — keeping it lightweight):

```bash
# .git/hooks/pre-commit
#!/bin/sh
# Check if UI files are staged
UI_FILES=$(git diff --cached --name-only | grep -E '(components/|app/.*\.tsx|globals\.css)')
if [ -n "$UI_FILES" ]; then
  echo "UI files changed, running visual check..."
  ab open http://localhost:3000
  ab snapshot > /tmp/ui-snapshot.txt
  # Agent can review snapshot for obvious issues
fi
```

### Renderable UI States
Must capture these states:
1. Main calendar view (full year, holidays visible)
2. Calendar with vacation dates selected
3. Anonymous user state (no auth header)
4. Authenticated user state (avatar, dropdown)
5. Offline toast notification
6. Migration review modal
7. Vacation summary panel (with and without rollover)
8. Empty state (no vacation dates)

### Limitations
- Requires dev server running (localhost:3000)
- Screenshots are static — no interaction recording
- Playwright dependency needs browsers installed
- May need `npx playwright install chromium` first

## 3. ChunkHound Setup

### Installation
```bash
npm install -g chunkhound
# Or via pip if Python-based
pip install chunkhound
```

### MCP Server Configuration
Add to Claude Code settings (`.claude/settings.json` or user-level):

```json
{
  "mcpServers": {
    "chunkhound": {
      "command": "chunkhound",
      "args": ["mcp-serve"],
      "env": {
        "CHUNKHOUND_ROOT": "/home/nikolaymih11/webstormprojects/pochivnirabotnidni"
      }
    }
  }
}
```

### CLI Commands
```bash
# Index the codebase
chunkhound index .

# Research a topic
chunkhound research "how does vacation state management work"

# Search for specific patterns
chunkhound search "color classes in components"

# Diagnose codebase
chunkhound diagnose
```

### Auto Re-indexing
Options:
1. **File watcher**: `chunkhound watch .` (if supported)
2. **Git hook**: Post-commit hook that runs `chunkhound index .`
3. **npm script**: Add to package.json scripts

### Role in UX Critique
- **Component discovery**: "Which components render the calendar day cells?"
- **Theme consistency**: "Find all hardcoded color classes that don't use Coffee tokens"
- **Refactor safety**: "What depends on MonthGrid's props?"

### Key Capabilities
- 29+ language support (TypeScript included)
- AST-aware chunking (understands component structure)
- Semantic search (not just keyword matching)
- Local-first (no cloud dependency)

## 4. UX Critique Protocol

### Protocol Design

**Document Template:** `.planning/critiques/YYYY-MM-DD-{component-or-view}.md`

```markdown
# UX Critique: {View/Component Name}

**Date:** YYYY-MM-DD
**Triggered by:** {what UI change is proposed}
**Scope:** {which components/views affected}

## Visual Capture
{agent-browser snapshot or screenshot reference}

## Observations
1. {What is observed — factual, no judgment}
2. {What is observed}

## Questions
1. {Does X align with Coffee design system?}
2. {Is the spacing consistent with 4px base unit?}

## Design System Violations
| Element | Current | Expected (Coffee) | Severity |
|---------|---------|-------------------|----------|
| {element} | {current value} | {Coffee token} | {high/medium/low} |

## Token Compliance
- Colors: {pass/fail — list violations}
- Typography: {pass/fail}
- Spacing: {pass/fail}
- Border radius: {pass/fail}
- Shadows: {pass/fail}
```

### Enforcement Mechanism
1. **Pre-commit hook**: If UI files changed, require critique document exists
2. **Naming convention**: Critique file must match date of change
3. **ChunkHound query**: Verify changed components use Coffee tokens

### "No Solutions" Rule
Critique output MUST:
- State observations ("The button uses #2563eb which is not a Coffee token")
- Ask questions ("Should this match Caramel or Cinnamon?")
- Flag violations (table with current vs expected)

Critique output MUST NOT:
- Propose code changes ("Change bg-blue-500 to bg-caramel")
- Suggest implementations ("Use a wrapper component")
- Recommend alternatives ("Consider using a tooltip instead")

### Integration Flow
```
Developer proposes UI change
  → Run agent-browser snapshot (current state)
  → Run ChunkHound: find affected components
  → Run ChunkHound: check token compliance
  → Write critique document (observations only)
  → Developer reviews critique
  → Developer implements (informed by observations)
  → Run agent-browser snapshot (new state)
  → Verify Coffee token compliance
```

## 5. Recommendations for Planning

### Plan Breakdown (4 plans suggested)

**Plan 1 (Wave 1): Coffee Theme Tailwind Config**
- Define all Coffee tokens in globals.css using @theme
- Load Nunito font via next/font/google (with cyrillic subset)
- Create semantic color aliases
- Document token mapping
- Files: globals.css, layout.tsx

**Plan 2 (Wave 1): Coffee Theme Component Migration**
- Systematic find-and-replace of Tailwind color classes
- Update all components to use Coffee tokens
- Update PWA manifest theme color
- Files: All components (MonthGrid, VacationSummary, AuthHeader, etc.)

**Plan 3 (Wave 2): agent-browser + ChunkHound Integration**
- Install and configure agent-browser
- Install and configure ChunkHound with MCP
- Set up auto re-indexing
- Create pre-commit hook
- Define renderable UI states
- Files: .claude/settings.json, package.json, git hooks

**Plan 4 (Wave 2): UX Critique Protocol Documentation**
- Write critique document template
- Document the protocol (trigger, process, output)
- Create first critique of current state (post-Coffee theme)
- Files: .planning/ documents only

### Key Pitfalls
1. **Tailwind v4 @theme syntax** — different from v3, no config file needed
2. **Nunito cyrillic subset** — MUST include for Bulgarian text
3. **85+ color class replacements** — need systematic approach, easy to miss
4. **agent-browser requires running dev server** — hook must handle this gracefully
5. **ChunkHound MCP integration** — need to verify Claude Code supports the MCP config

---

*Research complete: 2026-02-06*
