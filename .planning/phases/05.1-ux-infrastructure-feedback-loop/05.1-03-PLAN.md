---
phase: 05.1-ux-infrastructure-feedback-loop
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.json
  - .git/hooks/pre-commit
autonomous: false

must_haves:
  truths:
    - "agent-browser is installed globally and can open localhost URLs"
    - "ChunkHound MCP server is configured in Claude Code settings"
    - "Pre-commit hook runs visual check when UI files are staged"
    - "ChunkHound can index the project codebase"
  artifacts:
    - path: ".claude/settings.json"
      provides: "ChunkHound MCP server configuration"
      contains: "chunkhound"
    - path: ".git/hooks/pre-commit"
      provides: "Auto visual check on UI file commits"
      contains: "agent-browser"
  key_links:
    - from: ".claude/settings.json"
      to: "chunkhound MCP server"
      via: "mcpServers configuration"
      pattern: "mcpServers.*chunkhound"
    - from: ".git/hooks/pre-commit"
      to: "agent-browser CLI"
      via: "ab snapshot command"
      pattern: "ab.*snapshot"
---

<objective>
Install and configure agent-browser (visual UI capture) and ChunkHound (codebase indexing) tooling, with a pre-commit hook for automated visual checks.

Purpose: These tools are the eyes and memory of the UX critique loop. agent-browser lets Claude "see" the rendered UI. ChunkHound lets Claude understand component structure. The pre-commit hook enforces visual review before UI changes land.
Output: Both tools installed, ChunkHound MCP configured, pre-commit hook active, initial codebase index created.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-ux-infrastructure-feedback-loop/05.1-CONTEXT.md
@.planning/phases/05.1-ux-infrastructure-feedback-loop/05.1-RESEARCH.md
@.claude/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install agent-browser and ChunkHound, configure MCP</name>
  <files>
    .claude/settings.json
  </files>
  <action>
1. **Install agent-browser globally:**
   ```bash
   npm install -g agent-browser
   ```
   After install, verify: `ab --version` or `ab --help`

   If Playwright browsers are needed: `npx playwright install chromium`

   **If installation fails** (e.g., Rust binary not available for platform, npm registry error, permission denied):
   - Record the exact error message
   - Record the command that failed and the platform details (`uname -a`, `node --version`)
   - In the SUMMARY.md, create a "## Manual Installation Required" section with:
     - Tool name: agent-browser
     - Failed command and error
     - Alternative installation methods to try (e.g., `cargo install agent-browser`, building from source)
     - Link to the tool's repository/docs
   - Continue with the rest of the plan (do NOT abort)

2. **Install ChunkHound:**
   Try npm first:
   ```bash
   npm install -g chunkhound
   ```
   If npm package doesn't exist, try pip:
   ```bash
   pip install chunkhound
   ```

   After install, verify: `chunkhound --version` or `chunkhound --help`

   **If installation fails** (neither npm nor pip works):
   - Record the exact error messages for both npm and pip attempts
   - In the SUMMARY.md, create a "## Manual Installation Required" section (or append to existing one) with:
     - Tool name: ChunkHound
     - Failed commands and errors
     - Alternative installation methods to try
     - Link to the tool's repository/docs
   - Continue with MCP configuration regardless (configure optimistically)

3. **Configure ChunkHound MCP server in .claude/settings.json:**
   Read the existing settings.json first, then MERGE (not replace) the mcpServers config into it.

   Add to the existing JSON:
   ```json
   {
     "mcpServers": {
       "chunkhound": {
         "command": "chunkhound",
         "args": ["mcp-serve"],
         "env": {
           "CHUNKHOUND_ROOT": "/home/nikolaymih11/webstormprojects/pochivnirabotnidni"
         }
       }
     }
   }
   ```

   Preserve ALL existing settings (hooks, statusLine). The final file must contain both the existing config AND the new mcpServers block.

4. **Run initial codebase index:**
   ```bash
   cd /home/nikolaymih11/webstormprojects/pochivnirabotnidni && chunkhound index .
   ```
   If ChunkHound wasn't installed successfully, skip this step and note it in the SUMMARY.

IMPORTANT: If either tool fails to install, do NOT treat it as a plan failure. Document failures thoroughly in the SUMMARY.md under "## Manual Installation Required" with exact errors and alternative steps. Configure what's possible, and flag it for the checkpoint task below.
  </action>
  <verify>
Check each tool:
- `which ab` or `ab --help` (agent-browser installed)
- `which chunkhound` or `chunkhound --help` (ChunkHound installed)
- Read .claude/settings.json and confirm it has mcpServers.chunkhound AND the original hooks/statusLine config
- If ChunkHound index was run, check that index artifacts exist
- If either tool failed: confirm SUMMARY.md has "## Manual Installation Required" section with exact errors and alternative steps
  </verify>
  <done>
agent-browser and ChunkHound installed (or installation failures documented in SUMMARY.md under "## Manual Installation Required" with exact error messages, platform details, and alternative installation methods). ChunkHound MCP server configured in .claude/settings.json alongside existing hooks/statusLine config. Initial codebase index created (if ChunkHound available).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pre-commit hook for visual UI checks</name>
  <files>
    .git/hooks/pre-commit
  </files>
  <action>
Create a lightweight pre-commit git hook (NOT husky - keeping dependencies minimal per project convention).

1. Create `.git/hooks/pre-commit` with this content:

```bash
#!/bin/sh
# Pre-commit hook: Visual UI check when UI files are modified
# Part of Phase 5.1 UX Infrastructure

# Check if any UI-related files are staged
UI_FILES=$(git diff --cached --name-only | grep -E '\.(tsx|css)$' | grep -E '(components/|app/)')

if [ -z "$UI_FILES" ]; then
  # No UI files changed, skip visual check
  exit 0
fi

echo ""
echo "=== UX Visual Check ==="
echo "UI files changed:"
echo "$UI_FILES"
echo ""

# Check if agent-browser is available
if command -v ab >/dev/null 2>&1; then
  echo "Running agent-browser snapshot..."

  # Check if dev server is running on port 3000
  if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null | grep -q "200\|304"; then
    ab open http://localhost:3000 2>/dev/null
    ab snapshot > /tmp/ui-snapshot-$(date +%Y%m%d-%H%M%S).txt 2>/dev/null
    echo "Snapshot saved to /tmp/ui-snapshot-*.txt"
  else
    echo "WARNING: Dev server not running on localhost:3000. Skipping visual snapshot."
    echo "Run 'npm run dev' to enable visual checks."
  fi
else
  echo "NOTE: agent-browser not installed. Skipping visual check."
  echo "Install with: npm install -g agent-browser"
fi

# Check if ChunkHound is available for token compliance check
if command -v chunkhound >/dev/null 2>&1; then
  echo ""
  echo "Running ChunkHound token compliance check..."
  # Search for hardcoded default Tailwind colors in changed files
  VIOLATIONS=""
  for file in $UI_FILES; do
    if grep -qE 'bg-(red|blue|yellow|gray|green|purple|pink|indigo|cyan|teal|orange|lime|emerald|violet|fuchsia|rose|amber|slate|zinc|neutral|stone)-[0-9]' "$file" 2>/dev/null; then
      VIOLATIONS="$VIOLATIONS\n  $file"
    fi
  done

  if [ -n "$VIOLATIONS" ]; then
    echo "WARNING: Hardcoded Tailwind colors found (should use Coffee tokens):"
    echo "$VIOLATIONS"
    echo ""
    echo "This is a warning only. Commit will proceed."
  else
    echo "All changed files use Coffee tokens. OK."
  fi
fi

echo "=== End UX Visual Check ==="
echo ""

# Always allow commit (hook is advisory, not blocking)
exit 0
```

2. Make the hook executable:
   ```bash
   chmod +x .git/hooks/pre-commit
   ```

IMPORTANT: The hook is advisory only (always exits 0). It warns about issues but never blocks commits. This matches the project's ship-fast philosophy. Blocking hooks create friction during development.

NOTE: .git/hooks/ is NOT tracked by git. This file exists only locally. Document its creation in the SUMMARY so it can be recreated on fresh clones.
  </action>
  <verify>
- Check hook exists: `ls -la .git/hooks/pre-commit`
- Check it's executable: `test -x .git/hooks/pre-commit && echo "executable" || echo "not executable"`
- Dry-run test: `sh .git/hooks/pre-commit` (should run without errors, print UI check messages)
  </verify>
  <done>
Pre-commit hook created at .git/hooks/pre-commit. Checks for UI file changes, runs agent-browser snapshot if available and dev server running, checks for hardcoded Tailwind color violations. Advisory only (never blocks commits). Documented as local-only file for fresh clone recreation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <what-built>
    Installed agent-browser and ChunkHound globally, configured ChunkHound MCP server in Claude Code settings, created pre-commit hook for visual UI checks.
  </what-built>
  <how-to-verify>
    1. Run `ab --help` in terminal - should show agent-browser help
    2. Run `chunkhound --help` in terminal - should show ChunkHound help
    3. Check `.claude/settings.json` has mcpServers.chunkhound config
    4. Stage any .tsx file and run `git commit --dry-run` to see the pre-commit hook output
    5. If either tool failed to install, review the SUMMARY for the "Manual Installation Required" section with exact errors and manual steps
  </how-to-verify>
  <resume-signal>Type "approved" or describe any installation issues that need manual resolution</resume-signal>
</task>

</tasks>

<verification>
1. agent-browser installed and responds to `ab --help` (or installation failure documented in SUMMARY with exact errors and manual steps)
2. ChunkHound installed and responds to `chunkhound --help` (or installation failure documented in SUMMARY with exact errors and manual steps)
3. .claude/settings.json contains mcpServers.chunkhound alongside existing config
4. .git/hooks/pre-commit exists, is executable, and runs without errors
5. Pre-commit hook detects UI file changes and checks for hardcoded colors
</verification>

<success_criteria>
- Both tools installed or installation issues clearly documented in SUMMARY under "## Manual Installation Required" with exact errors, platform details, and alternative installation methods
- ChunkHound MCP configured in Claude Code settings (merged with existing config)
- Pre-commit hook functional and advisory (non-blocking)
- Initial codebase index created (if ChunkHound available)
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-ux-infrastructure-feedback-loop/05.1-03-SUMMARY.md`
</output>
