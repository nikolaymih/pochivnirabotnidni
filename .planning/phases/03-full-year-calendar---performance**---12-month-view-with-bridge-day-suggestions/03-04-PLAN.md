---
phase: 03-full-year-calendar-performance
plan: 04
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md
autonomous: false

must_haves:
  truths:
    - "Calendar loads within 3 seconds on mobile devices (per UX-01)"
    - "Initial render completes within 200ms (per CAL-04)"
    - "No layout shifts during page load (CLS < 0.1)"
    - "Vacation marking interaction completes within 100ms"
    - "Bridge day suggestions display without perceptible delay (< 50ms)"
  artifacts:
    - path: ".planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md"
      provides: "Performance measurement results"
      contains: "Mobile load time"
      min_lines: 30
  key_links:
    - from: "Performance measurement"
      to: "React DevTools Profiler"
      via: "Manual profiling session"
      pattern: "Profiler"
    - from: "Performance budget"
      to: "Requirements UX-01, CAL-04"
      via: "Validation against requirements"
      pattern: "UX-01|CAL-04"
---

<objective>
Measure and verify that the 12-month full-year calendar meets performance requirements (UX-01: <3 second mobile load, CAL-04: <200ms initial render) and optimize if necessary.

Purpose: Ensure Bulgarian users on typical mobile devices can view the full-year calendar without frustrating load times or janky interactions.

Output: Performance measurements documented in 03-PERFORMANCE.md, with optimizations applied if benchmarks are not met.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-RESEARCH.md

# Performance requirements
UX-01: Application loads and displays calendar within 3 seconds on mobile
CAL-04: Calendar renders with acceptable performance on mobile devices (<200ms initial render)

# Completed plans in this phase
@.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-01-PLAN.md
@.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-02-PLAN.md
@.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-03-PLAN.md

# Research insights
Research indicates:
- 365 DOM nodes should perform well on modern devices
- React Compiler (Next.js 16+) auto-optimizes re-renders
- Server Components reduce JavaScript bundle
- Only add virtualization (react-window) if profiling shows >200ms render
</context>

<tasks>

<task type="auto">
  <name>Measure baseline performance with React DevTools Profiler</name>
  <files>.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md</files>
  <action>
Create `.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md` and perform performance measurements:

**Automated measurements:**

1. **Build production bundle:**
   ```bash
   npm run build
   npm run start
   ```

2. **Measure bundle size:**
   ```bash
   # Next.js build output shows bundle sizes
   # Record JavaScript bundle size for main page
   # Target: < 200KB for First Load JS
   ```

3. **Lighthouse performance audit:**
   ```bash
   # Run Lighthouse on http://localhost:3000
   # Focus on:
   # - First Contentful Paint (FCP)
   # - Largest Contentful Paint (LCP)
   # - Total Blocking Time (TBT)
   # - Cumulative Layout Shift (CLS)
   ```

4. **Component count:**
   ```bash
   # Count DOM nodes rendered
   # Expected: 365 day cells + 12 month containers + headers = ~400 nodes
   ```

**Document in 03-PERFORMANCE.md:**

```markdown
# Phase 3: Full-Year Calendar Performance Report

**Measured:** [Date]
**Environment:** Production build (npm run build && npm run start)
**Device:** [Actual device or Chrome DevTools device simulation]

## Performance Metrics

### Bundle Size
- First Load JS: [X] KB
- Page specific JS: [X] KB
- Target: < 200 KB ✓/✗

### Lighthouse Score (Mobile)
- Performance: [X]/100
- First Contentful Paint: [X]ms
- Largest Contentful Paint: [X]ms
- Total Blocking Time: [X]ms
- Cumulative Layout Shift: [X]

### Component Metrics
- Total DOM nodes: [X]
- Day cells rendered: 365
- Month grids rendered: 12

### Render Performance
- Initial page load: [X]s (Target: <3s per UX-01) ✓/✗
- Calendar render time: [X]ms (Target: <200ms per CAL-04) ✓/✗

## Analysis

[PASS/FAIL for each requirement]

UX-01 (3 second load): [PASS/FAIL - X seconds measured]
CAL-04 (200ms render): [PASS/FAIL - X ms measured]

## Recommendations

[If any metrics fail:]
- [ ] Consider react-window virtualization
- [ ] Lazy load months below fold
- [ ] Reduce bundle size (code splitting)

[If all metrics pass:]
- ✓ No optimization needed, performance targets met
- ✓ Server Components + React Compiler sufficient
```

**Commands to run:**
```bash
# Production build
npm run build

# Start production server
npm run start

# Open browser to http://localhost:3000
# Run Chrome DevTools Lighthouse (Mobile, Navigation mode)
# Record metrics in 03-PERFORMANCE.md
```

**Important:**
- Use production build (NOT npm run dev)
- Test on mobile device or mobile simulation (Chrome DevTools)
- Focus on REAL metrics, not theoretical concerns
- Only recommend optimizations if requirements are not met
  </action>
  <verify>
```bash
# Performance report exists
test -f .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md

# Contains measurements
grep -q "Bundle Size" .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md
grep -q "Lighthouse Score" .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md
grep -q "UX-01" .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md
grep -q "CAL-04" .planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-PERFORMANCE.md
```
  </verify>
  <done>
- 03-PERFORMANCE.md created with performance measurements
- Production build created and tested
- Lighthouse mobile audit completed
- Bundle size measured and recorded
- UX-01 (3 second load) validated against measurement
- CAL-04 (200ms render) validated against measurement
- Recommendations documented (if any metrics fail)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full 12-month calendar with holiday and bridge day detection, performance-optimized for mobile devices.
  </what-built>
  <how-to-verify>
**Visual verification:**

1. Open http://localhost:3000 (production build running from Task 1)
2. Verify layout:
   - [ ] All 12 months visible on page
   - [ ] Months arranged in responsive grid (resize browser to check breakpoints)
   - [ ] Mobile (narrow): 1 column
   - [ ] Tablet (~768px): 2 columns
   - [ ] Desktop (~1024px): 3 columns
   - [ ] Large (~1280px): 4 columns

3. Verify holiday display:
   - [ ] Bulgarian holidays show RED background
   - [ ] Holidays have correct dates (cross-reference with known 2026 holidays)
   - [ ] Hover over holiday shows tooltip with name

4. Verify bridge day suggestions:
   - [ ] Bridge days show YELLOW background
   - [ ] Bridge days only appear on Mondays after Tuesday holidays
   - [ ] Bridge days only appear on Fridays after Thursday holidays
   - [ ] No yellow on dates that are already holidays

5. Verify vacation tracking:
   - [ ] Click a date → turns BLUE (vacation marked)
   - [ ] Click blue date → turns back to normal (vacation removed)
   - [ ] Drag across dates → selects range
   - [ ] VacationSummary updates with correct count
   - [ ] Refresh page → vacation data persists (localStorage)

6. Verify weekend styling:
   - [ ] Saturdays and Sundays show GRAY background (unless holiday/bridge/vacation)

7. Verify performance (subjective):
   - [ ] Page loads quickly (feels < 3 seconds)
   - [ ] No janky scrolling or interaction lag
   - [ ] Clicking dates feels immediate

8. Test on actual mobile device (if possible):
   - [ ] Open on phone browser (Safari or Chrome)
   - [ ] Touch interaction works
   - [ ] Layout fits screen
   - [ ] No horizontal scroll

**Acceptance criteria:**
- All 12 months display correctly
- Holidays in red, bridge days in yellow, vacation in blue
- Bridge day logic correct (only Tue→Mon, Thu→Fri patterns)
- Vacation tracking works across all months
- Performance feels acceptable on mobile
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any visual/functional issues found.
  </resume-signal>
</task>

<task type="auto">
  <name>Apply optimizations if performance targets not met</name>
  <files>components/FullYearCalendar.tsx</files>
  <action>
**ONLY execute if user reports performance issues in checkpoint OR if 03-PERFORMANCE.md shows failed metrics.**

If UX-01 or CAL-04 targets NOT met, apply optimizations:

**Optimization 1: Lazy load months below fold**
```typescript
import dynamic from 'next/dynamic';

const MonthGrid = dynamic(() => import('./MonthGrid'), {
  loading: () => <div className="h-64 bg-gray-100 animate-pulse rounded-lg" />,
});
```

**Optimization 2: Reduce initial render with viewport-based loading**
```typescript
'use client';
import { useEffect, useState } from 'react';

export default function FullYearCalendar({ year, holidays, bridgeDays }) {
  const [visibleMonths, setVisibleMonths] = useState(3); // Load first 3 months

  useEffect(() => {
    // Load remaining months after initial render
    setTimeout(() => setVisibleMonths(12), 100);
  }, []);

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {Array.from({ length: visibleMonths }, (_, monthIndex) => (
        <MonthGrid key={monthIndex} year={year} month={monthIndex} ... />
      ))}
    </div>
  );
}
```

**Optimization 3: Add react-window virtualization**
```bash
npm install react-window @types/react-window
```

```typescript
import { FixedSizeGrid as Grid } from 'react-window';

// Virtualize month grid with window size calculation
// Only render months in viewport
```

**Decision criteria:**
- If load time < 3s AND render < 200ms: NO optimizations needed
- If load time 3-5s: Apply Optimization 1 (lazy load)
- If load time 5-8s: Apply Optimization 1 + 2 (lazy + progressive load)
- If load time > 8s: Apply all optimizations including react-window

**Important:**
- Start with simplest approach (no optimization)
- Only optimize if measurements prove it's needed
- Re-measure after each optimization
- Document results in 03-PERFORMANCE.md
  </action>
  <verify>
```bash
# If optimizations applied, verify they exist
if grep -q "dynamic.*MonthGrid" components/FullYearCalendar.tsx; then
  echo "Lazy loading applied"
fi

if grep -q "visibleMonths" components/FullYearCalendar.tsx; then
  echo "Progressive loading applied"
fi

if grep -q "react-window" package.json; then
  echo "Virtualization library added"
fi
```
  </verify>
  <done>
**If performance targets NOT met:**
- Optimizations applied based on severity of performance gap
- Re-measurement performed to confirm improvement
- 03-PERFORMANCE.md updated with optimization results

**If performance targets MET:**
- No changes to components (documented in 03-PERFORMANCE.md)
- Performance validation confirms targets achieved without optimization
  </done>
</task>

</tasks>

<verification>
Performance verification complete when:

1. **Measurements documented:**
   - 03-PERFORMANCE.md exists with all metrics
   - Bundle size recorded
   - Lighthouse scores recorded
   - Load time measured
   - Render time measured

2. **Requirements validated:**
   - UX-01 (3 second mobile load) marked PASS or FAIL
   - CAL-04 (200ms render) marked PASS or FAIL

3. **Human verification:**
   - User confirms visual correctness
   - User confirms interaction responsiveness
   - User confirms bridge day logic accuracy

4. **Optimization (if needed):**
   - If targets not met, optimizations applied
   - Re-measurement shows improvement
   - Final metrics documented
</verification>

<success_criteria>
**Phase 3 Plan 4 is complete when:**

- [ ] Production build created (npm run build)
- [ ] 03-PERFORMANCE.md exists with measurements
- [ ] Bundle size measured and recorded
- [ ] Lighthouse mobile audit completed
- [ ] UX-01 validated: Load time <3 seconds (or optimizations applied)
- [ ] CAL-04 validated: Render time <200ms (or optimizations applied)
- [ ] User approved visual and functional correctness in checkpoint
- [ ] Bridge days display correctly (yellow on Mondays after Tue holidays, Fridays after Thu holidays)
- [ ] Holidays display correctly (red background on official dates)
- [ ] Vacation tracking works across all 12 months
- [ ] Responsive layout works at all breakpoints
- [ ] Performance feels acceptable on mobile device
- [ ] Final performance results documented
</success_criteria>

<output>
After completion, create `.planning/phases/03-full-year-calendar---performance**---12-month-view-with-bridge-day-suggestions/03-04-SUMMARY.md` following the summary template.
</output>
